<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAP | Portal do Aluno</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #8671d1; --secondary: #F1D24B; }
        body { font-family: 'DM Sans', sans-serif; background-color: #f4f7f9; min-height: 100vh; margin: 0; scroll-behavior: smooth; }
        #main-wrapper { width: 100%; margin: 0 auto; padding: 0; position: relative; }
        #dashboard-view, #generator-view, #study-view { padding: 0 1.5rem; max-width: 1200px; margin: 0 auto; padding-top: 1.5rem; }
        .bg-primary\/10 { background-color: rgba(134, 113, 209, 0.1); }
        .text-primary { color: #8671d1; }

        /* UI BUTTONS */
        .action-button { background-color: #F1D24B; color: #44403c; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-flex; align-items: center; justify-content: center; font-size: 0.875rem; white-space: nowrap; }
        .action-button-sm { background-color: #F1D24B; color: #44403c; padding: 0.35rem 0.5rem; border-radius: 0.375rem; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-flex; align-items: center; justify-content: center; font-size: 0.6rem; white-space: nowrap; }
        .action-button-sm:hover:not(:disabled) { background-color: #eab308; transform: translateY(-2px); }
        .action-button-sm:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; box-shadow: none; }
        .action-button:hover:not(:disabled) { background-color: #eab308; transform: translateY(-2px); }
        .action-button:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; box-shadow: none; }

        .secondary-button { background-color: #44403c; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; font-size: 0.875rem; }
        .secondary-button-sm { background-color: #44403c; color: white; padding: 0.4rem 0.6rem; border-radius: 0.25rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; font-size: 0.65rem; }
        .secondary-button-sm:hover { background-color: #292524; transform: translateY(-1px); }
        .back-button { background-color: #44403c; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .back-button:hover { background-color: #292524; transform: translateY(-1px); }
        .secondary-button:hover { background-color: #292524; transform: translateY(-1px); }

        /* CARDS */
        .level-card { background-color: white; padding: 1.75rem; border-radius: 1.25rem; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid transparent; transition: all 0.2s; display: flex; flex-direction: column; justify-content: space-between; height: 100%; position: relative; min-height: 180px; }
        .level-card:not(.locked):hover { transform: scale(1.02); border-color: #8671d1; }
        .level-card.locked { opacity: 0.6; background-color: #f9fafb; pointer-events: none; }
        
        /* STUDY VIEW CONTAINER */
        .study-container { background: white; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-bottom: 2rem; }

        .module-tag { display: inline-block; padding: 0.25rem 0.5rem; background-color: #8671d1; color: white; font-size: 0.75rem; font-weight: 700; border-radius: 0.5rem; margin-bottom: 0.5rem; }
        .lock-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(68,64,60,0.9); padding: 1rem; border-radius: 50%; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* LISTENING */
        .listening-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 0.5rem; margin-top: 0.25rem; }
        .listening-grid-wide { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 0.5rem; margin-top: 0.25rem; }
        .number-btn { background: white; border: 2px solid #e2e8f0; border-radius: 0.75rem; padding: 0.5rem; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 55px; }
        .number-btn:hover { border-color: #8671d1; transform: translateY(-2px); }
        .number-btn span.main-text { font-size: 1.1rem; font-weight: 800; }
        .number-btn span.sub-text { font-size: 0.6rem; font-weight: 600; color: #8671d1; text-transform: uppercase; }
        .number-btn span.phonetic-text { font-size: 0.75rem; font-weight: 500; color: #78716c; font-style: italic; }
        .number-btn.playing { border-color: #F1D24B; background-color: #fffbeb; animation: pulse 1s infinite; }

        /* FLASHCARDS */
        .flashcard-container { perspective: 1000px; width: 100%; max-width: 400px; height: 300px; margin: 0.5rem auto; cursor: pointer; }
        .flashcard { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 1.5rem; padding: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .flashcard-front { background-color: #8671d1; color: white; }
        .flashcard-back { background-color: #F1D24B; color: #44403c; transform: rotateY(180deg); }

        /* CHUNKS */
        .chunks-grid { display: grid; grid-template-columns: 1fr 1fr; border: 2px solid #e2e8f0; border-radius: 1rem; overflow: hidden; background: white; text-align: left; }
        .chunks-header { background: #44403c; color: white; padding: 1rem; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
        .chunks-cell { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; font-weight: 500; font-size: 0.9rem; word-break: break-word; }
        .chunks-cell-en { color: #1e1b4b; background-color: #f8fafc; }
        .chunks-cell-pt { color: #64748b; justify-content: space-between; }
        .chunk-input { flex: 1; padding: 0.4rem 0.6rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 0.85rem; outline: none; transition: 0.2s; min-width: 0; }
        .chunk-check-btn { flex-shrink: 0; padding: 0.4rem 0.6rem; margin-left: 0.5rem; border-radius: 0.5rem; background: #8671d1; color: white; font-size: 0.75rem; font-weight: 700; border: none; cursor: pointer; transition: 0.2s; }
        .chunk-check-btn:hover { background: #7161b8; }
        .chunk-input:focus { border-color: #8671d1; }
        .chunk-input.correct { border-color: #22c55e; background: #f0fdf4; color: #166534; }
        .chunk-input.wrong { border-color: #ef4444; background: #fef2f2; }
        .translation-hidden { filter: blur(5px); opacity: 0.3; transition: 0.3s; user-select: none; } 
        .translation-visible { filter: blur(0); opacity: 1; user-select: text; }
        @media (max-width: 640px) {
            .chunks-grid { grid-template-columns: 1fr; }
            .chunks-header:last-of-type { display: none; }
            .chunks-header:first-of-type::after { content: " / English"; }
            .chunks-cell { padding: 0.875rem; font-size: 0.95rem; }
            .chunks-cell-pt { border-bottom: none; border-right: none; padding-bottom: 0.5rem; }
            .chunks-cell-en { border-bottom: 2px solid #e2e8f0; padding-top: 0.5rem; }
        }

        /* WORD SEARCH */
        .wordsearch-grid { display: inline-grid; gap: 1px; background: #44403c; padding: 2px; border-radius: 0.5rem; user-select: none; }
        .wordsearch-cell { width: 32px; height: 32px; background: white; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.15s; text-transform: uppercase; }
        .wordsearch-cell:hover { background: #f0e6ff; }
        .wordsearch-cell.selected { background: #8671d1; color: white; }
        .wordsearch-cell.found { background: #F1D24B; color: #44403c; }
        .wordsearch-words { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; max-width: 320px; margin-top: 1rem; }
        .wordsearch-word { padding: 0.25rem 0.75rem; background: #f5f5f4; border-radius: 1rem; font-size: 0.85rem; font-weight: 600; color: #44403c; border: 2px solid #e2e8f0; }
        .wordsearch-word.found { background: #F1D24B; border-color: #F1D24B; text-decoration: line-through; }
        @media (max-width: 640px) {
            .wordsearch-cell { width: 28px; height: 28px; font-size: 14px; }
        }

        /* SCRAMBLE */
        .scramble-dropzone {
            min-height: 80px; 
            border: 2px dashed #cbd5e1; 
            border-radius: 1rem; 
            padding: 1.5rem; 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            justify-content: center; 
            gap: 0.75rem; 
            background-color: #f8fafc; 
            margin-bottom: 2rem; 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: #8671d1;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .scramble-word {
            background: white; 
            border: 2px solid #e2e8f0; 
            padding: 0.75rem 1.25rem; 
            border-radius: 0.75rem; 
            cursor: pointer; 
            font-weight: 600; 
            color: #44403c; 
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .scramble-word:hover { border-color: #8671d1; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .scramble-word-selected {
            background: #8671d1; 
            color: white;
            border: 2px solid #8671d1; 
            padding: 0.5rem 1rem; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s;
            margin: 0.125rem;
        }
        .scramble-word-selected:hover { background: #7161b1; border-color: #7161b1; }

        /* MISTAKE */
        .mistake-word { display: inline-block; padding: 0.2rem 0.4rem; border-radius: 0.4rem; cursor: pointer; transition: all 0.2s; border-bottom: 2px solid transparent; }
        .mistake-word:hover { background-color: #fee2e2; border-bottom-color: #ef4444; }
        .mistake-word.correct-choice { background: #dcfce7; border-color: #22c55e; }
        .mistake-word.wrong-choice { background: #fee2e2; border-color: #ef4444; text-decoration: line-through; }

        /* DICTATION */
        .dictation-input { font-size: 1.25rem; text-align: center; border: 3px solid #e2e8f0; border-radius: 1rem; width: 220px; padding: 0.5rem; outline: none; transition: 0.2s; }
        .dictation-input:focus { border-color: #8671d1; }
        .dictation-input.correct { border-color: #22c55e; background: #dcfce7; }
        .dictation-input.wrong { border-color: #ef4444; background: #fee2e2; }

        /* GENERAL UI */

        .streak-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 1rem; }
        .streak-bar-wrapper { width: 100%; max-width: 300px; margin: 0 auto; }
        .streak-bar-bg { width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; }
        .streak-bar-fill { height: 100%; background: linear-gradient(90deg, #F1D24B, #f59e0b); border-radius: 6px; transition: width 0.4s ease; }
        .streak-label { font-size: 0.75rem; font-weight: 700; color: #78716c; margin-bottom: 0.25rem; }

        /* QUIZ UI */
        .option-button { background-color: white; border: 2px solid #e2e8f0; color: #44403c; text-align: left; padding: 1rem; border-radius: 0.75rem; width: 100%; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; gap: 1rem; }
        .option-button:hover:not(:disabled) { border-color: #F1D24B; background-color: #fffbeb; }
        .option-prefix { width: 2.2rem; height: 2.2rem; background: #fef9c3; color: #a16207; font-weight: 800; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid #fde047; }

        .help-btn { position: absolute; top: 1rem; right: 1.5rem; width: 2.5rem; height: 2.5rem; border-radius: 50%; background: white; border: 2px solid #e2e8f0; color: #8671d1; font-weight: 700; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; border-radius: 1.5rem; padding: 1.8rem; max-width: 400px; width: 90%; transform: scale(0.9); transition: 0.3s; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .modal-overlay.active .modal-content { transform: scale(1); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* LOGIN SCREEN */
        #login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f4f7f9 0%, #e8e0f3 100%); }
        .login-card { background: white; border-radius: 1.5rem; padding: 2.5rem; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(134,113,209,0.15); }
        .login-input { width: 100%; padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 0.75rem; font-size: 1rem; font-family: 'DM Sans', sans-serif; outline: none; transition: 0.2s; box-sizing: border-box; }
        .login-input:focus { border-color: #8671d1; }
        .login-error { color: #ef4444; font-size: 0.8rem; font-weight: 600; margin-top: 0.5rem; display: none; }
        .login-tabs { display: flex; border-radius: 0.75rem; overflow: hidden; border: 2px solid #e2e8f0; margin-bottom: 1.5rem; }
        .login-tab { flex: 1; padding: 0.65rem; text-align: center; font-weight: 700; font-size: 0.875rem; cursor: pointer; transition: 0.2s; background: white; color: #78716c; }
        .login-tab.active { background: #8671d1; color: white; }
        .user-badge { display: inline-flex; align-items: center; gap: 0.5rem; background: white; border: 1px solid #e2e8f0; padding: 0.35rem 0.75rem; border-radius: 2rem; font-size: 0.75rem; font-weight: 600; color: #44403c; }
        .logout-btn { background: none; border: none; color: #ef4444; font-weight: 700; font-size: 0.7rem; cursor: pointer; padding: 0.2rem 0.4rem; border-radius: 0.25rem; }
        .logout-btn:hover { background: #fef2f2; }
        .teacher-tab { flex: 1; padding: 0.5rem; text-align: center; font-weight: 700; font-size: 0.75rem; cursor: pointer; border: 2px solid #e7e5e4; border-radius: 0.5rem; background: white; color: #78716c; font-family: 'DM Sans', sans-serif; transition: 0.2s; }
        .teacher-tab.active { background: #8671d1; color: white; border-color: #8671d1; }
        .student-card { display: flex; align-items: center; justify-content: space-between; background: #fafaf9; border-radius: 0.5rem; padding: 0.6rem 0.75rem; cursor: pointer; transition: 0.15s; border: 1px solid transparent; }
        .student-card:hover { border-color: #8671d1; background: #faf5ff; }
        .student-approved { color: #16a34a; }
        .student-pending { color: #f59e0b; }

        /* SIDEBAR */
        .app-sidebar { position: fixed; top: 0; left: 0; width: 260px; height: 100vh; background: white; border-right: 1px solid #e7e5e4; z-index: 900; display: flex; flex-direction: column; transition: transform 0.3s ease; }
        .app-sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 899; }
        .app-content { margin-left: 260px; transition: margin-left 0.3s ease; }
        .sidebar-item { display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem 1rem; border-radius: 0.5rem; font-size: 0.8rem; font-weight: 600; color: #57534e; cursor: pointer; transition: 0.15s; border: none; background: none; width: 100%; text-align: left; text-decoration: none; font-family: 'DM Sans', sans-serif; }
        .sidebar-item:hover { background: #f5f3ff; color: #8671d1; }
        .teacher-sidebar-nav.active { background: #f5f3ff; color: #8671d1; font-weight: 700; }
        .sidebar-toggle { display: none; position: fixed; top: 0.75rem; left: 0.75rem; z-index: 901; background: white; border: 1px solid #e7e5e4; border-radius: 0.5rem; padding: 0.4rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        @media (max-width: 768px) {
            .app-sidebar { transform: translateX(-100%); }
            .app-sidebar.open { transform: translateX(0); }
            .app-sidebar-overlay.open { display: block; }
            .app-content { margin-left: 0; }
            .sidebar-toggle { display: flex; }
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f5f0ff 0%, #fefce8 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; overflow-y: auto;">
        <div class="login-card">
            <div class="text-center mb-6">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" class="w-28 h-auto mx-auto mb-4">
                <h2 class="text-xl font-bold text-stone-800">Portal do Aluno</h2>
                <p class="text-stone-500 text-sm mt-1">Faça login para acessar seus estudos</p>
            </div>

            <div class="login-tabs" data-testid="login-tabs">
                <div class="login-tab active" data-testid="tab-login" onclick="switchLoginTab('login')">ENTRAR</div>
                <div class="login-tab" data-testid="tab-register" onclick="switchLoginTab('register')">CADASTRAR</div>
            </div>

            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label class="block text-sm font-bold text-stone-600 mb-1">Email</label>
                    <input type="email" id="login-email" class="login-input" placeholder="seu@email.com" required data-testid="input-login-email">
                </div>
                <div class="mb-1">
                    <label class="block text-sm font-bold text-stone-600 mb-1">Senha</label>
                    <input type="password" id="login-password" class="login-input" placeholder="Sua senha" required minlength="6" data-testid="input-login-password">
                </div>
                <p id="login-error" class="login-error" data-testid="text-login-error"></p>
                <button type="submit" id="login-submit-btn" class="action-button w-full mt-4" data-testid="button-login-submit">ENTRAR</button>
            </form>

            <form id="register-form" class="hidden" onsubmit="handleRegister(event)">
                <div class="mb-3">
                    <label class="block text-sm font-bold text-stone-600 mb-1">Nome completo</label>
                    <input type="text" id="register-name" class="login-input" placeholder="Seu nome" required data-testid="input-register-name">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold text-stone-600 mb-1">Email</label>
                    <input type="email" id="register-email" class="login-input" placeholder="seu@email.com" required data-testid="input-register-email">
                </div>
                <div class="mb-1">
                    <label class="block text-sm font-bold text-stone-600 mb-1">Senha</label>
                    <input type="password" id="register-password" class="login-input" placeholder="Mínimo 6 caracteres" required minlength="6" data-testid="input-register-password">
                </div>
                <p id="register-error" class="login-error" data-testid="text-register-error"></p>
                <button type="submit" id="register-submit-btn" class="action-button w-full mt-4" data-testid="button-register-submit">CRIAR CONTA</button>
            </form>
        </div>
    </div>

    <!-- PENDING APPROVAL SCREEN -->
    <div id="pending-screen" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f5f0ff 0%, #fefce8 100%); align-items: center; justify-content: center; z-index: 10000;">
        <div class="login-card" style="text-align: center;">
            <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" class="w-28 h-auto mx-auto mb-4">
            <div style="width: 64px; height: 64px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <h2 class="text-xl font-bold text-stone-800 mb-2" data-testid="text-pending-title">Cadastro Recebido!</h2>
            <p class="text-stone-600 text-sm mb-1" data-testid="text-pending-message">Sua conta foi criada com sucesso.</p>
            <p class="text-stone-600 text-sm mb-4">Aguarde a <strong>aprovação do professor</strong> para acessar a plataforma.</p>
            <p class="text-stone-400 text-xs mb-4" id="pending-user-email" data-testid="text-pending-email"></p>
            <button class="secondary-button w-full" onclick="handleLogout()" data-testid="button-pending-logout">SAIR E VOLTAR</button>
        </div>
    </div>

    <!-- JOURNEY MAP SCREEN -->
    <div id="journey-map-screen" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, #f5f3ff 0%, #fefce8 50%, #f5f3ff 100%); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow: auto;">
        <div class="jmap-layout">
            <div class="jmap-info">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" style="width: 100px; margin: 0 auto 0.6rem;">
                <p style="font-size: 0.9rem; color: #78716c; font-weight: 500;">Olá, <strong id="journey-user-name" style="color: #44403c;"></strong></p>
                <h2 style="font-size: 1.5rem; font-weight: 900; color: #1c1917; margin-top: 0.15rem;" data-testid="text-journey-title">Jornada SLAP</h2>
                <p style="font-size: 0.8rem; color: #a8a29e; margin-top: 0.2rem;">Selecione seu nível para começar</p>
                <button class="secondary-button jmap-logout-desktop" onclick="handleLogout()" data-testid="button-journey-logout-desktop">SAIR DA CONTA</button>
            </div>

            <div class="jmap-trail-area">
            <div class="jmap-snake">
                <svg class="jmap-snake-line" viewBox="0 0 800 340" preserveAspectRatio="none" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M 80 55 H 720 V 170 H 80 V 285 H 720" stroke="#c4b5fd" stroke-width="3" stroke-dasharray="8 6" fill="none"/>
                </svg>

                <div class="jmap-row">
                    <div class="jmap-snode jmap-current" onclick="enterLevel('starter1')" data-testid="button-level-starter1">
                        <div class="jmap-circle jmap-circle-active pulse-glow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        </div>
                        <span class="jmap-name">Starter 1</span>
                        <span class="jmap-sublevel">Iniciante</span>
                        <span class="jmap-badge-active">Selecionar</span>
                    </div>
                    <div class="jmap-snode jmap-current" onclick="enterLevel('starter2')" data-testid="button-level-starter2">
                        <div class="jmap-circle jmap-circle-active pulse-glow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        </div>
                        <span class="jmap-name">Starter 2</span>
                        <span class="jmap-sublevel">Básico</span>
                        <span class="jmap-badge-active">Selecionar</span>
                    </div>
                    <div class="jmap-snode jmap-locked" data-testid="button-level-freshman1">
                        <div class="jmap-circle jmap-circle-locked">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        </div>
                        <span class="jmap-name">Freshman 1</span>
                        <span class="jmap-sublevel">Pré-intermediário</span>
                    </div>
                </div>

                <div class="jmap-row jmap-row-reverse">
                    <div class="jmap-snode jmap-locked" data-testid="button-level-freshman2">
                        <div class="jmap-circle jmap-circle-locked">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        </div>
                        <span class="jmap-name">Freshman 2</span>
                        <span class="jmap-sublevel">Pré-intermediário</span>
                    </div>
                    <div class="jmap-snode jmap-locked" data-testid="button-level-sophomore1">
                        <div class="jmap-circle jmap-circle-locked">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        </div>
                        <span class="jmap-name">Sophomore 1</span>
                        <span class="jmap-sublevel">Intermediário</span>
                    </div>
                    <div class="jmap-snode jmap-locked" data-testid="button-level-sophomore2">
                        <div class="jmap-circle jmap-circle-locked">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        </div>
                        <span class="jmap-name">Sophomore 2</span>
                        <span class="jmap-sublevel">Intermediário</span>
                    </div>
                </div>

                <div class="jmap-row">
                    <div class="jmap-snode jmap-locked" data-testid="button-level-senior1">
                        <div class="jmap-circle jmap-circle-locked">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        </div>
                        <span class="jmap-name">Senior 1</span>
                        <span class="jmap-sublevel">Avançado</span>
                    </div>
                    <div class="jmap-snode jmap-locked" data-testid="button-level-senior2">
                        <div class="jmap-circle jmap-circle-locked">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        </div>
                        <span class="jmap-name">Senior 2</span>
                        <span class="jmap-sublevel">Avançado</span>
                    </div>
                    <div class="jmap-snode jmap-locked" data-testid="button-level-acc">
                        <div class="jmap-circle jmap-circle-trophy">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                        </div>
                        <span class="jmap-name">ACC</span>
                        <span class="jmap-sublevel">Conversação Avançada</span>
                    </div>
                </div>
            </div>
            <button class="secondary-button jmap-logout-mobile" onclick="handleLogout()" data-testid="button-journey-logout">SAIR DA CONTA</button>
            </div>
        </div>
    </div>
    <style>
        .jmap-layout {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .jmap-info {
            text-align: center;
            margin-bottom: 1.25rem;
        }
        .jmap-trail-area {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .jmap-logout-desktop {
            display: none;
            font-size: 0.8rem;
            margin-top: 1.5rem;
            padding: 0.6rem 2.5rem;
        }
        .jmap-logout-mobile {
            font-size: 0.8rem;
            margin-top: 1.25rem;
            padding: 0.6rem 2.5rem;
        }
        @media (min-width: 900px) {
            .jmap-layout {
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 3rem;
                padding: 2rem;
                max-width: 1100px;
                margin: 0 auto;
            }
            .jmap-info {
                text-align: left;
                margin-bottom: 0;
                flex-shrink: 0;
                min-width: 220px;
                max-width: 250px;
                align-self: center;
            }
            .jmap-info img {
                margin: 0 0 0.6rem 0 !important;
            }
            .jmap-trail-area {
                flex: 1;
                min-width: 0;
            }
            .jmap-logout-desktop {
                display: inline-block;
            }
            .jmap-logout-mobile {
                display: none;
            }
        }
        .jmap-snake {
            position: relative;
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        .jmap-snake-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        .jmap-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: relative;
            z-index: 1;
            padding: 0.75rem 0;
        }
        .jmap-row-reverse {
            flex-direction: row-reverse;
        }
        .jmap-snode {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 0.35rem;
            flex: 1;
            min-width: 0;
            padding: 0.5rem;
        }
        .jmap-snode.jmap-current {
            cursor: pointer;
        }
        .jmap-snode.jmap-current:hover .jmap-circle {
            transform: scale(1.1);
        }
        .jmap-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .jmap-circle-active {
            background: linear-gradient(135deg, #8671d1, #a78bfa);
            color: white;
            box-shadow: 0 0 0 4px rgba(134,113,209,0.2), 0 4px 15px rgba(134,113,209,0.4);
        }
        .jmap-circle-locked {
            background: #ede9fe;
            color: #a8a29e;
            border: 2px dashed #d4d0ec;
        }
        .jmap-circle-trophy {
            background: linear-gradient(135deg, #F1D24B, #f59e0b);
            color: white;
            border: 2px solid #F1D24B;
        }
        .jmap-name {
            font-weight: 800;
            font-size: 0.95rem;
            color: #44403c;
            line-height: 1.2;
            font-family: 'DM Sans', sans-serif;
        }
        .jmap-snode.jmap-locked .jmap-name {
            color: #a8a29e;
        }
        .jmap-sublevel {
            font-size: 0.7rem;
            color: #78716c;
            font-weight: 500;
        }
        .jmap-snode.jmap-locked .jmap-sublevel {
            color: #c7c5c2;
        }
        .jmap-badge-active {
            font-size: 0.65rem;
            font-weight: 800;
            color: white;
            background: linear-gradient(135deg, #8671d1, #a78bfa);
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
            margin-top: 0.15rem;
            display: inline-block;
            letter-spacing: 0.3px;
        }
        @media (max-width: 480px) {
            .jmap-circle { width: 44px; height: 44px; }
            .jmap-name { font-size: 0.8rem; }
            .jmap-sublevel { font-size: 0.6rem; }
            .jmap-snake { max-width: 380px; }
            .jmap-snode { padding: 0.25rem; }
        }
    </style>

    <!-- GRADES MODAL -->
    <div id="grades-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20000; align-items: center; justify-content: center; padding: 1rem;">
        <div style="background: white; border-radius: 1rem; max-width: 420px; width: 100%; max-height: 85vh; overflow-y: auto; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2); position: relative;" data-testid="modal-grades">
            <button onclick="closeGradesModal()" data-testid="button-close-grades" style="position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; cursor: pointer; color: #78716c; font-size: 1.25rem; line-height: 1; z-index: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <div style="text-align: center; margin-bottom: 1rem;">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" style="width: 70px; margin: 0 auto 0.75rem;">
                <h3 style="font-size: 1.15rem; font-weight: 800; color: #1c1917; font-family: 'DM Sans', sans-serif;">Minhas Notas</h3>
            </div>
            <div id="student-grades-content"></div>
            <div style="margin-top: 0.75rem; padding: 0.5rem 0.75rem; background: #fef9c3; border-radius: 0.5rem; display: flex; align-items: flex-start; gap: 0.4rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#a16207" stroke-width="2" style="flex-shrink: 0; margin-top: 1px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                <p style="font-size: 0.7rem; color: #854d0e; line-height: 1.4;" data-testid="text-grade-notice">Para ser aprovado para o próximo nível, é necessário somar no mínimo <strong>70 pontos</strong> de 100.</p>
            </div>
        </div>
    </div>

    <!-- TOP STUDENTS MODAL -->
    <div id="top-students-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20000; align-items: center; justify-content: center; padding: 1rem;">
        <div style="background: white; border-radius: 1rem; max-width: 420px; width: 100%; max-height: 85vh; overflow-y: auto; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2); position: relative;" data-testid="modal-top-students">
            <button onclick="closeTopStudentsModal()" data-testid="button-close-top-students" style="position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; cursor: pointer; color: #78716c; font-size: 1.25rem; line-height: 1; z-index: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <div style="text-align: center; margin-bottom: 1.25rem;">
                <div style="width: 48px; height: 48px; background: #fef9c3; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#F1D24B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7 4 7 7 7 7"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5C17 4 17 7 17 7"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                </div>
                <h3 style="font-size: 1.15rem; font-weight: 800; color: #1c1917; font-family: 'DM Sans', sans-serif;">Top Students</h3>
                <p style="font-size: 0.75rem; color: #78716c; margin-top: 0.25rem;" id="top-students-level-label" data-testid="text-top-students-level"></p>
            </div>
            <div id="top-students-content" style="display: flex; flex-direction: column; gap: 0.5rem;">
                <p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 2rem 0;">Carregando...</p>
            </div>
        </div>
    </div>

    <!-- TEACHER DASHBOARD -->
    <div id="teacher-screen" style="display: none; width: 100%; position: relative;">

        <!-- TEACHER SIDEBAR -->
        <nav class="app-sidebar" id="teacher-sidebar" data-testid="nav-teacher-sidebar">
            <div style="padding: 2rem 1rem 0.75rem; text-align: center;">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" style="width: 80px; margin: 0 auto 0.75rem;">
                <div style="position: relative; width: 64px; height: 64px; margin: 0 auto 0.5rem; cursor: pointer;" onclick="document.getElementById('teacher-avatar-upload-input').click()" data-testid="button-teacher-avatar-upload">
                    <div id="teacher-sidebar-avatar" style="width: 64px; height: 64px; border-radius: 50%; background: #ede9fe; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #8671d1;">
                        <svg id="teacher-sidebar-avatar-placeholder" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#8671d1" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <img id="teacher-sidebar-avatar-img" src="" alt="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    </div>
                    <div style="position: absolute; bottom: -2px; right: -2px; width: 22px; height: 22px; background: #8671d1; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    </div>
                    <input type="file" id="teacher-avatar-upload-input" accept="image/*" style="display: none;" onchange="handleTeacherAvatarUpload(event)" data-testid="input-teacher-avatar-file">
                </div>
                <p style="font-size: 0.75rem; color: #a8a29e; font-weight: 500;">Teacher,</p>
                <p style="font-size: 0.95rem; font-weight: 800; color: #1c1917;" id="teacher-sidebar-user-name" data-testid="text-teacher-sidebar-username"></p>
            </div>

            <div style="padding: 0.5rem 0.75rem; flex: 1; display: flex; flex-direction: column; gap: 0.15rem;">
                <p style="font-size: 0.6rem; font-weight: 700; color: #a8a29e; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.5rem 1rem 0.25rem;">Menu</p>

                <button onclick="showTeacherSection('students'); closeTeacherSidebar();" class="sidebar-item teacher-sidebar-nav active" id="teacher-nav-students" data-testid="button-teacher-nav-students">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Alunos
                </button>

                <button onclick="showTeacherSection('ranking'); closeTeacherSidebar();" class="sidebar-item teacher-sidebar-nav" id="teacher-nav-ranking" data-testid="button-teacher-nav-ranking">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7 4 7 7 7 7"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5C17 4 17 7 17 7"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                    Top Students
                </button>
            </div>

            <div style="padding: 0.75rem 1rem; border-top: 1px solid #e7e5e4; display: flex; justify-content: center;">
                <button onclick="handleLogout()" class="sidebar-item" style="color: #ef4444; justify-content: center;" data-testid="button-teacher-sidebar-logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Sair da Conta
                </button>
            </div>

            <div style="padding: 0.75rem 1rem; border-top: 1px solid #e7e5e4; text-align: center;">
                <span style="font-size: 0.6rem; font-weight: 700; color: #a8a29e; text-transform: uppercase; letter-spacing: 1px;">Siga o SLAP</span>
                <div style="display: flex; justify-content: center; gap: 0.4rem; margin-top: 0.4rem;">
                    <a href="https://www.instagram.com/slapingles" target="_blank" style="width: 30px; height: 30px; border-radius: 50%; background: #f5f3ff; display: flex; align-items: center; justify-content: center;" data-testid="link-teacher-social-instagram">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="#8671d1"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                    </a>
                    <a href="https://www.tiktok.com/@slapingles" target="_blank" style="width: 30px; height: 30px; border-radius: 50%; background: #f5f3ff; display: flex; align-items: center; justify-content: center;" data-testid="link-teacher-social-tiktok">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="#8671d1"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                    </a>
                    <a href="https://www.youtube.com/@slapingles" target="_blank" style="width: 30px; height: 30px; border-radius: 50%; background: #f5f3ff; display: flex; align-items: center; justify-content: center;" data-testid="link-teacher-social-youtube">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="#8671d1"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                    </a>
                </div>
            </div>
        </nav>
        <div class="app-sidebar-overlay" id="teacher-sidebar-overlay" onclick="closeTeacherSidebar()"></div>

        <!-- TEACHER MOBILE SIDEBAR TOGGLE -->
        <button class="sidebar-toggle" id="teacher-sidebar-toggle-btn" onclick="toggleTeacherSidebar()" data-testid="button-toggle-teacher-sidebar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#44403c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>

        <!-- TEACHER MAIN CONTENT AREA -->
        <div class="app-content">
            <header class="mb-10 relative" style="background: #8671d1; padding: 2rem 1.5rem; text-align: center;">
                <h1 style="font-size: 1.75rem; font-weight: 900; color: white; margin: 0;" data-testid="text-teacher-title">Portal do Professor</h1>
                <p style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin-top: 0.25rem;">Gerencie alunos, notas e progresso</p>
            </header>

            <!-- TEACHER: STUDENTS SECTION -->
            <div id="teacher-section-students" class="w-full" style="padding: 0 1.5rem 2rem;">
                <div style="max-width: 960px; margin: 0 auto;">
                    <div id="teacher-stats-bar" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;"></div>

                    <div style="margin-bottom: 1rem; position: relative;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#a8a29e" stroke-width="2" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%);"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        <input type="text" id="teacher-search-input" placeholder="Buscar aluno por nome ou email..." style="width: 100%; padding: 0.6rem 0.75rem 0.6rem 2.25rem; border: 2px solid #e7e5e4; border-radius: 0.5rem; font-size: 0.85rem; font-family: 'DM Sans', sans-serif; outline: none; box-sizing: border-box;" oninput="searchStudents()" data-testid="input-teacher-search">
                    </div>

                    <div id="teacher-students-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 2rem 0;">Carregando alunos...</p>
                    </div>

                    <div id="teacher-pagination" style="display: none; margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"></div>

                    <div id="teacher-student-detail-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 9998; backdrop-filter: blur(2px);" onclick="closeStudentDetail()"></div>
                    <div id="teacher-student-detail" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 92%; max-width: 640px; max-height: 85vh; overflow-y: auto; background: white; border-radius: 1rem; padding: 1.25rem; box-shadow: 0 8px 40px rgba(0,0,0,0.18); z-index: 9999;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <h3 style="font-size: 1rem; font-weight: 800; color: #1c1917; font-family: 'DM Sans', sans-serif;" id="detail-student-name" data-testid="text-detail-student-name"></h3>
                                <p style="font-size: 0.7rem; color: #78716c;" id="detail-student-email" data-testid="text-detail-student-email"></p>
                            </div>
                            <button onclick="closeStudentDetail()" style="background: none; border: none; cursor: pointer; color: #78716c;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>

                        <div id="student-dates-info" style="display: flex; gap: 1rem; margin-bottom: 1rem; padding: 0.6rem 0.75rem; background: #fafaf9; border-radius: 0.5rem; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.35rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#a8a29e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                <span style="font-size: 0.7rem; color: #78716c;">Cadastro: <strong id="detail-student-created" style="color: #44403c;" data-testid="text-student-created">—</strong></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.35rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#a8a29e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                <span style="font-size: 0.7rem; color: #78716c;">Aprovação: <strong id="detail-student-approved" style="color: #44403c;" data-testid="text-student-approved">—</strong></span>
                            </div>
                        </div>

                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button onclick="showDetailTab('grades')" id="tab-grades" class="teacher-tab active" data-testid="button-tab-grades">Notas</button>
                            <button onclick="showDetailTab('streaks')" id="tab-streaks" class="teacher-tab" data-testid="button-tab-streaks">Streaks</button>
                            <button onclick="showDetailTab('links')" id="tab-links" class="teacher-tab" data-testid="button-tab-links">Links</button>
                            <button onclick="showDetailTab('level')" id="tab-level" class="teacher-tab" data-testid="button-tab-level">N&#237;vel</button>
                            <button onclick="showDetailTab('approval')" id="tab-approval" class="teacher-tab" data-testid="button-tab-approval">Status</button>
                        </div>

                        <div id="detail-tab-grades">
                            <div id="grade-level-tabs" style="display: flex; gap: 0.35rem; margin-bottom: 0.75rem; flex-wrap: wrap;"></div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;" id="teacher-grades-form">
                                <div style="display: flex; justify-content: space-between; align-items: center; background: #fafaf9; border-radius: 0.5rem; padding: 0.5rem 0.75rem;">
                                    <span style="font-size: 0.8rem; color: #44403c; font-weight: 500;">Midterm Test <span style="color: #a8a29e; font-size: 0.65rem;">(max 20)</span></span>
                                    <input type="number" min="0" max="20" id="grade-midterm" style="width: 60px; text-align: center; padding: 0.3rem; border: 1px solid #d6d3d1; border-radius: 0.375rem; font-size: 0.8rem; font-family: 'DM Sans', sans-serif;" data-testid="input-grade-midterm">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; background: #fafaf9; border-radius: 0.5rem; padding: 0.5rem 0.75rem;">
                                    <span style="font-size: 0.8rem; color: #44403c; font-weight: 500;">Listening Test <span style="color: #a8a29e; font-size: 0.65rem;">(max 20)</span></span>
                                    <input type="number" min="0" max="20" id="grade-listening" style="width: 60px; text-align: center; padding: 0.3rem; border: 1px solid #d6d3d1; border-radius: 0.375rem; font-size: 0.8rem; font-family: 'DM Sans', sans-serif;" data-testid="input-grade-listening">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; background: #fafaf9; border-radius: 0.5rem; padding: 0.5rem 0.75rem;">
                                    <span style="font-size: 0.8rem; color: #44403c; font-weight: 500;">Grammar Test <span style="color: #a8a29e; font-size: 0.65rem;">(max 20)</span></span>
                                    <input type="number" min="0" max="20" id="grade-grammar" style="width: 60px; text-align: center; padding: 0.3rem; border: 1px solid #d6d3d1; border-radius: 0.375rem; font-size: 0.8rem; font-family: 'DM Sans', sans-serif;" data-testid="input-grade-grammar">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; background: #fafaf9; border-radius: 0.5rem; padding: 0.5rem 0.75rem;">
                                    <span style="font-size: 0.8rem; color: #44403c; font-weight: 500;">Oral Test <span style="color: #a8a29e; font-size: 0.65rem;">(max 20)</span></span>
                                    <input type="number" min="0" max="20" id="grade-oral" style="width: 60px; text-align: center; padding: 0.3rem; border: 1px solid #d6d3d1; border-radius: 0.375rem; font-size: 0.8rem; font-family: 'DM Sans', sans-serif;" data-testid="input-grade-oral">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; background: #fafaf9; border-radius: 0.5rem; padding: 0.5rem 0.75rem;">
                                    <span style="font-size: 0.8rem; color: #44403c; font-weight: 500;">Assiduidade <span style="color: #a8a29e; font-size: 0.65rem;">(max 10)</span></span>
                                    <input type="number" min="0" max="10" id="grade-attendance" style="width: 60px; text-align: center; padding: 0.3rem; border: 1px solid #d6d3d1; border-radius: 0.375rem; font-size: 0.8rem; font-family: 'DM Sans', sans-serif;" data-testid="input-grade-attendance">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; background: #fafaf9; border-radius: 0.5rem; padding: 0.5rem 0.75rem;">
                                    <span style="font-size: 0.8rem; color: #44403c; font-weight: 500;">Participação <span style="color: #a8a29e; font-size: 0.65rem;">(max 10)</span></span>
                                    <input type="number" min="0" max="10" id="grade-participation" style="width: 60px; text-align: center; padding: 0.3rem; border: 1px solid #d6d3d1; border-radius: 0.375rem; font-size: 0.8rem; font-family: 'DM Sans', sans-serif;" data-testid="input-grade-participation">
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-top: 0.75rem;">
                                <span style="font-size: 0.8rem; font-weight: 700; color: #44403c;" id="grade-total-display" data-testid="text-grade-total">Total: 0 / 100</span>
                                <button onclick="saveStudentGrades()" style="background: #8671d1; color: white; border: none; border-radius: 0.5rem; padding: 0.5rem 1rem; font-size: 0.8rem; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif;" data-testid="button-save-grades">Salvar Notas</button>
                            </div>
                            <p id="grade-save-feedback" style="display: none; font-size: 0.7rem; margin-top: 0.5rem; text-align: center;"></p>
                        </div>

                        <div id="detail-tab-streaks" style="display: none;">
                            <div id="student-streaks-list" style="display: flex; flex-direction: column; gap: 0.3rem;">
                                <p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 1rem 0;">Carregando streaks...</p>
                            </div>
                        </div>

                        <div id="detail-tab-links" style="display: none;">
                            <div id="links-level-tabs" style="display: flex; gap: 0.35rem; margin-bottom: 0.75rem; flex-wrap: wrap;"></div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div>
                                    <label style="font-size: 0.7rem; font-weight: 700; color: #78716c; margin-bottom: 0.2rem; display: block;">Link do CP (Baixar CP)</label>
                                    <input type="text" id="student-cp-link" placeholder="Cole o link do CP deste aluno..." style="width: 100%; padding: 0.5rem 0.75rem; border: 2px solid #e7e5e4; border-radius: 0.5rem; font-size: 0.8rem; font-family: 'DM Sans', sans-serif; outline: none; box-sizing: border-box;" data-testid="input-student-cp-link">
                                </div>
                                <div>
                                    <label style="font-size: 0.7rem; font-weight: 700; color: #78716c; margin-bottom: 0.2rem; display: block;">Link das Aulas Gravadas</label>
                                    <input type="text" id="student-recorded-link" placeholder="Cole o link das aulas gravadas deste aluno..." style="width: 100%; padding: 0.5rem 0.75rem; border: 2px solid #e7e5e4; border-radius: 0.5rem; font-size: 0.8rem; font-family: 'DM Sans', sans-serif; outline: none; box-sizing: border-box;" data-testid="input-student-recorded-link">
                                </div>
                                <button onclick="saveStudentLinks()" style="background: #8671d1; color: white; border: none; border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.75rem; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif; margin-top: 0.25rem;" data-testid="button-save-student-links">Salvar Links</button>
                                <p id="student-links-save-feedback" style="display: none; font-size: 0.7rem; text-align: center; margin-top: 0.25rem;"></p>
                            </div>
                        </div>

                        <div id="detail-tab-level" style="display: none;">
                            <div style="padding: 0.75rem 0;">
                                <p style="font-size: 0.8rem; color: #44403c; margin-bottom: 0.75rem; font-weight: 500;">N&#237;vel atual do aluno:</p>
                                <select id="student-level-select" style="width: 100%; padding: 0.5rem 0.75rem; border: 2px solid #e7e5e4; border-radius: 0.5rem; font-size: 0.85rem; font-family: 'DM Sans', sans-serif; outline: none; background: white; cursor: pointer;" data-testid="select-student-level">
                                    <option value="starter1">Starter 1 - Iniciante</option>
                                    <option value="starter2">Starter 2 - B&#225;sico</option>
                                </select>
                                <p style="font-size: 0.65rem; color: #a8a29e; margin-top: 0.4rem;">O aluno poder&#225; acessar este n&#237;vel e todos os anteriores.</p>
                                <button onclick="saveStudentLevel()" style="background: #8671d1; color: white; border: none; border-radius: 0.5rem; padding: 0.5rem 1rem; font-size: 0.8rem; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif; margin-top: 0.75rem; width: 100%;" data-testid="button-save-level">Salvar N&#237;vel</button>
                                <p id="level-save-feedback" style="display: none; font-size: 0.7rem; text-align: center; margin-top: 0.5rem;"></p>
                            </div>
                        </div>

                        <div id="detail-tab-approval" style="display: none;">
                            <div style="text-align: center; padding: 1rem 0;">
                                <p style="font-size: 0.8rem; color: #44403c; margin-bottom: 0.75rem;">Status atual: <strong id="detail-approval-status" data-testid="text-approval-status"></strong></p>
                                <button id="btn-toggle-approval" onclick="toggleStudentApproval()" style="border: none; border-radius: 0.5rem; padding: 0.5rem 1.5rem; font-size: 0.8rem; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif;" data-testid="button-toggle-approval"></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TEACHER: RANKING SECTION -->
            <div id="teacher-section-ranking" class="w-full" style="padding: 0 1.5rem 2rem; display: none;">
                <div style="max-width: 960px; margin: 0 auto;">
                    <div id="teacher-ranking-level-tabs" style="display: flex; gap: 0.35rem; margin-bottom: 1rem; flex-wrap: wrap;"></div>
                    <div id="teacher-ranking-content" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 2rem 0;">Carregando ranking...</p>
                    </div>
                </div>
            </div>

        </div><!-- close teacher app-content -->
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="main-wrapper" class="hidden">

        <!-- SIDEBAR -->
        <nav class="app-sidebar" id="app-sidebar" data-testid="nav-sidebar">
            <div style="padding: 2rem 1rem 0.75rem; text-align: center;">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" style="width: 80px; margin: 0 auto 0.75rem;">
                <div style="position: relative; width: 64px; height: 64px; margin: 0 auto 0.5rem; cursor: pointer;" onclick="document.getElementById('avatar-upload-input').click()" data-testid="button-avatar-upload">
                    <div id="sidebar-avatar" style="width: 64px; height: 64px; border-radius: 50%; background: #ede9fe; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #8671d1;">
                        <svg id="sidebar-avatar-placeholder" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#8671d1" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <img id="sidebar-avatar-img" src="" alt="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    </div>
                    <div style="position: absolute; bottom: -2px; right: -2px; width: 22px; height: 22px; background: #8671d1; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    </div>
                    <input type="file" id="avatar-upload-input" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)" data-testid="input-avatar-file">
                </div>
                <p style="font-size: 0.75rem; color: #a8a29e; font-weight: 500;">Bem-vindo,</p>
                <p style="font-size: 0.95rem; font-weight: 800; color: #1c1917;" id="sidebar-user-name" data-testid="text-sidebar-username"></p>
            </div>

            <div style="padding: 0.5rem 0.75rem; flex: 1; display: flex; flex-direction: column; gap: 0.15rem;">
                <p style="font-size: 0.6rem; font-weight: 700; color: #a8a29e; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.5rem 1rem 0.25rem;">Menu</p>

                <a href="#" id="sidebar-cp-link" target="_blank" class="sidebar-item" data-testid="link-sidebar-cp">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    Baixar CP
                </a>

                <button onclick="openGradesModal(); closeSidebar();" class="sidebar-item" data-testid="button-sidebar-grades">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                    Minhas Notas
                </button>

                <button onclick="openRulesModal(); closeSidebar();" class="sidebar-item" data-testid="button-sidebar-rules">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    Boas Pr&#225;ticas
                </button>

                <a href="#" id="sidebar-recorded-link" target="_blank" class="sidebar-item" data-testid="link-sidebar-recorded">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                    Aulas Gravadas
                </a>

                <button onclick="openTopStudentsModal(); closeSidebar();" class="sidebar-item" data-testid="button-sidebar-top-students">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7 4 7 7 7 7"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5C17 4 17 7 17 7"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                    Top Students
                </button>

                <div style="height: 1px; background: #e7e5e4; margin: 0.35rem 0.75rem;"></div>

                <button onclick="showScreen('journey'); closeSidebar();" class="sidebar-item" style="color: #8671d1;" data-testid="button-sidebar-levels">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Trocar de N&#237;vel
                </button>
            </div>

            <div style="padding: 0.75rem 1rem; border-top: 1px solid #e7e5e4; display: flex; justify-content: center;">
                <button onclick="handleLogout()" class="sidebar-item" style="color: #ef4444; justify-content: center;" data-testid="button-sidebar-logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Sair da Conta
                </button>
            </div>

            <div style="padding: 0.75rem 1rem; border-top: 1px solid #e7e5e4; text-align: center;">
                <span style="font-size: 0.6rem; font-weight: 700; color: #a8a29e; text-transform: uppercase; letter-spacing: 1px;">Siga o SLAP</span>
                <div style="display: flex; justify-content: center; gap: 0.4rem; margin-top: 0.4rem;">
                    <a href="https://www.instagram.com/slapingles" target="_blank" style="width: 30px; height: 30px; border-radius: 50%; background: #f5f3ff; display: flex; align-items: center; justify-content: center;" data-testid="link-social-instagram">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="#8671d1"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                    </a>
                    <a href="https://www.tiktok.com/@slapingles" target="_blank" style="width: 30px; height: 30px; border-radius: 50%; background: #f5f3ff; display: flex; align-items: center; justify-content: center;" data-testid="link-social-tiktok">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="#8671d1"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                    </a>
                    <a href="https://www.youtube.com/@slapingles" target="_blank" style="width: 30px; height: 30px; border-radius: 50%; background: #f5f3ff; display: flex; align-items: center; justify-content: center;" data-testid="link-social-youtube">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="#8671d1"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                    </a>
                </div>
            </div>
        </nav>
        <div class="app-sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

        <!-- MOBILE SIDEBAR TOGGLE -->
        <button class="sidebar-toggle" id="sidebar-toggle-btn" onclick="toggleSidebar()" data-testid="button-toggle-sidebar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#44403c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>

        <!-- MAIN CONTENT AREA -->
        <div class="app-content">
            <header id="main-header" class="mb-10 relative">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1771626232/SLAP_HEADER-PORTAL-ALUNO_STARTER1_qsxwvh.png" alt="SLAP - Portal do Aluno Starter 1" style="width: 100%; display: block;">
            </header>

        <div id="dashboard-view" class="w-full">
            <div class="max-w-xl mx-auto mb-6">
                <div class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a8a29e" stroke-width="2" class="absolute left-3 top-1/2 -translate-y-1/2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    <input type="text" id="search-input" placeholder="Pesquisar aula..." class="w-full pl-10 pr-4 py-3 rounded-xl border-2 border-stone-200 focus:border-primary focus:outline-none text-stone-700 font-medium" oninput="filterModules(this.value)">
                </div>
            </div>
            <div id="level-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20"></div>
        </div>

        <div id="generator-view" class="hidden w-full pb-32">
            <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl mx-auto mb-20">
                <button class="back-button mb-4 flex items-center gap-2" onclick="showDashboard()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
                    Voltar ao Menu
                </button>
                <div class="flex items-center justify-center gap-2 mb-4">
                    <h2 class="text-xl font-bold text-stone-800" id="current-hw-display"></h2>
                    <button class="w-6 h-6 rounded-full bg-stone-200 hover:bg-stone-300 text-stone-600 font-bold text-sm flex items-center justify-center" onclick="showHelpModal()">?</button>
                </div>
                <div id="quiz-streak-bar" class="streak-container"></div>
                <div id="feedback-alert" class="hidden p-3 mb-6 rounded-lg text-white font-semibold text-center"></div>
                <div class="challenge-box mb-6  p-6 bg-yellow-50">
                    <p id="main-question" class="text-lg font-bold text-slate-800"></p>
                </div>
                <div id="options-container" class="space-y-3"></div>
                <div id="rationale-display" class="hidden mt-6">
                    <div id="rationale-content" class="p-4 bg-green-50 text-green-900 rounded-lg mb-4 text-sm "></div>
                </div>
                <div id="next-btn-container" class="hidden mt-4">
                    <button class="action-button w-full" onclick="loadNextQuestion()">Próximo Exercício</button>
                </div>
            </div>
        </div>

        <div id="study-view" class="hidden w-full">
            <div class="study-container max-w-4xl mx-auto text-center">
                 <button class="back-button mb-4 flex items-center gap-2" onclick="showDashboard()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
                    Voltar ao Menu
                 </button>
                 <div class="flex items-center justify-center gap-2 mb-2">
                    <h2 class="text-2xl font-bold text-stone-800" id="study-title"></h2>
                    <button id="help-btn" class="w-6 h-6 rounded-full bg-stone-200 hover:bg-stone-300 text-stone-600 font-bold text-sm flex items-center justify-center" onclick="showHelpModal()">?</button>
                 </div>
                 <p class="text-stone-500 mb-0 italic text-sm" id="study-instruction"></p>
                 <div id="streak-bar-container" class="hidden mb-0"></div>
                 <div id="preloading-status" class="text-xs text-primary font-bold mb-1 h-4"></div>
                 <div id="study-content-area" class="py-4"></div>
            </div>
        </div>
        </div><!-- close app-content -->
    </div>

    <!-- RULES POPUP -->
    <div id="rules-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20000; align-items: center; justify-content: center; padding: 1rem;">
        <div style="background: white; border-radius: 1rem; max-width: 420px; width: 100%; max-height: 85vh; overflow-y: auto; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2); position: relative;" data-testid="modal-rules">
            <button onclick="closeRulesModal()" data-testid="button-close-rules" style="position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; cursor: pointer; color: #78716c; font-size: 1.25rem; line-height: 1; z-index: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <div style="text-align: center; margin-bottom: 1rem;">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1759294967/SLAP_TIPO_PRETO_2_kismg9.png" alt="SLAP Logo" style="width: 70px; margin: 0 auto 0.75rem;">
                <h3 style="font-size: 1.15rem; font-weight: 800; color: #1c1917; font-family: 'DM Sans', sans-serif;">Boas Pr&#225;ticas</h3>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.6rem;">
                <div style="display: flex; gap: 0.6rem; align-items: flex-start; padding: 0.6rem 0.75rem; background: #fafaf9; border-radius: 0.5rem;">
                    <div style="width: 22px; height: 22px; border-radius: 50%; background: #8671d1; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.7rem; font-weight: 700;">1</div>
                    <p style="font-size: 0.8rem; color: #44403c; line-height: 1.4;"><strong>Acesso Individual:</strong> N&#227;o compartilhe sua senha. Monitoramos acessos por IP.</p>
                </div>
                <div style="display: flex; gap: 0.6rem; align-items: flex-start; padding: 0.6rem 0.75rem; background: #fafaf9; border-radius: 0.5rem;">
                    <div style="width: 22px; height: 22px; border-radius: 50%; background: #8671d1; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.7rem; font-weight: 700;">2</div>
                    <p style="font-size: 0.8rem; color: #44403c; line-height: 1.4;"><strong>Frequ&#234;ncia:</strong> A evolu&#231;&#227;o vem da pr&#225;tica constante. Tente completar um m&#243;dulo de Homework ap&#243;s cada aula.</p>
                </div>
                <div style="display: flex; gap: 0.6rem; align-items: flex-start; padding: 0.6rem 0.75rem; background: #fafaf9; border-radius: 0.5rem;">
                    <div style="width: 22px; height: 22px; border-radius: 50%; background: #8671d1; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.7rem; font-weight: 700;">3</div>
                    <p style="font-size: 0.8rem; color: #44403c; line-height: 1.4;"><strong>Listening:</strong> Use fones de ouvido para captar os detalhes nas atividades com &#225;udio.</p>
                </div>
                <div style="display: flex; gap: 0.6rem; align-items: flex-start; padding: 0.6rem 0.75rem; background: #fafaf9; border-radius: 0.5rem;">
                    <div style="width: 22px; height: 22px; border-radius: 50%; background: #8671d1; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.7rem; font-weight: 700;">4</div>
                    <p style="font-size: 0.8rem; color: #44403c; line-height: 1.4;"><strong>Revis&#227;o:</strong> Refazer atividades j&#225; conclu&#237;das &#233; uma das melhores formas de fixar o conte&#250;do.</p>
                </div>
                <div style="display: flex; gap: 0.6rem; align-items: flex-start; padding: 0.6rem 0.75rem; background: #fafaf9; border-radius: 0.5rem;">
                    <div style="width: 22px; height: 22px; border-radius: 50%; background: #8671d1; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.7rem; font-weight: 700;">5</div>
                    <p style="font-size: 0.8rem; color: #44403c; line-height: 1.4;"><strong>Pron&#250;ncia:</strong> Repita em voz alta as palavras e frases dos exerc&#237;cios. Falar &#233; treinar!</p>
                </div>
                <div style="display: flex; gap: 0.6rem; align-items: flex-start; padding: 0.6rem 0.75rem; background: #fafaf9; border-radius: 0.5rem;">
                    <div style="width: 22px; height: 22px; border-radius: 50%; background: #8671d1; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.7rem; font-weight: 700;">6</div>
                    <p style="font-size: 0.8rem; color: #44403c; line-height: 1.4;"><strong>Consist&#234;ncia:</strong> Estudar um pouco todo dia vale mais do que estudar muito de vez em quando. Mantenha seu streak!</p>
                </div>
            </div>
            <button onclick="closeRulesModal()" style="width: 100%; margin-top: 1rem; padding: 0.65rem; background: #8671d1; color: white; border: none; border-radius: 0.5rem; font-size: 0.85rem; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif;" data-testid="button-rules-confirm">Entendi, vamos l&#225;!</button>
        </div>
    </div>

    <!-- INSTRUCTIONS POPUP -->
    <div id="instructions-modal" class="modal-overlay" onclick="if(event.target === this) this.classList.remove('active')">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-black text-stone-800 mb-5 text-center">Como Funcionam os Modos de Estudo</h3>
            <div class="space-y-2 text-left max-h-[60vh] overflow-y-auto pr-2">
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">FLASHCARDS</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Cartões de memorização! Clique no cartão para virar e ver a tradução/resposta. Use as setas ou clique para avançar. Ideal para memorizar vocabulário e expressões.</div>
                </div>
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">LISTENING</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Pratique sua compreensão auditiva! Ouça o áudio e escolha a opção correta. Use fones de ouvido para captar melhor os detalhes da pronúncia.</div>
                </div>
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">CHUNKS</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Monte a frase correta! Arraste ou clique nas palavras na ordem certa para formar a frase em inglês. Ajuda a internalizar estruturas gramaticais.</div>
                </div>
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">HOMEWORK</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Quiz de múltipla escolha! Responda perguntas sobre o conteúdo da aula. Complete 10 acertos seguidos (streak) para finalizar com sucesso.</div>
                </div>
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">FORCA</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Jogo da forca! Adivinhe a palavra letra por letra. Você tem 6 tentativas antes de perder. Complete 5 palavras seguidas para finalizar.</div>
                </div>
                <div class="accordion-item rounded-lg border border-yellow-300 overflow-hidden">
                    <button class="accordion-header w-full p-3 bg-yellow-50 flex items-center justify-between cursor-pointer hover:bg-yellow-100 transition-all" onclick="this.parentElement.classList.toggle('open')">
                        <span class="font-bold text-stone-800">CAÇA-PALAVRAS</span>
                        <svg class="accordion-arrow w-5 h-5 text-stone-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="accordion-content hidden p-3 bg-white text-stone-600 text-sm border-t border-yellow-200">Caça-palavras! Encontre as palavras escondidas na grade clicando nas letras. Complete 2 puzzles seguidos para finalizar com sucesso.</div>
                </div>
            </div>
            <button class="action-button w-full mt-6" onclick="document.getElementById('instructions-modal').classList.remove('active')">Entendi!</button>
        </div>
    </div>
    <style>
        .accordion-item.open .accordion-content { display: block; }
        .accordion-item.open .accordion-arrow { transform: rotate(180deg); }
    </style>

    <!-- JOURNEY MODAL -->
    <div id="journey-modal" class="modal-overlay" onclick="if(event.target === this) this.classList.remove('active')">
        <div class="modal-content" style="max-width: 360px; max-height: 85vh; overflow-y: auto; padding: 1.2rem 1.2rem 0.75rem; background: linear-gradient(180deg, #f5f3ff 0%, #fefce8 50%, #f5f3ff 100%); border-radius: 1.2rem;">
            <div style="text-align: center; margin-bottom: 1rem;">
                <div style="font-size: 0.6rem; font-weight: 700; color: #8671d1; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 0.2rem;">Sua Trilha</div>
                <h3 style="font-size: 1.2rem; font-weight: 900; color: #44403c; margin: 0;">Jornada SLAP</h3>
            </div>
            <div class="journey-trail" data-testid="journey-trail">
                <div class="trail-line"></div>
                <div class="trail-node trail-left current" data-testid="trail-node-1">
                    <div class="trail-circle pulse-glow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                    </div>
                    <div class="trail-label">
                        <span class="trail-name">Starter 1</span>
                        <span class="trail-level">Iniciante</span>
                        <span class="trail-badge-current">Você está aqui</span>
                    </div>
                </div>
                <div class="trail-node trail-right locked" data-testid="trail-node-2">
                    <div class="trail-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <div class="trail-label">
                        <span class="trail-name">Starter 2</span>
                        <span class="trail-level">Básico</span>
                    </div>
                </div>
                <div class="trail-node trail-left locked" data-testid="trail-node-3">
                    <div class="trail-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <div class="trail-label">
                        <span class="trail-name">Freshman 1</span>
                        <span class="trail-level">Pré-intermediário</span>
                    </div>
                </div>
                <div class="trail-node trail-right locked" data-testid="trail-node-4">
                    <div class="trail-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <div class="trail-label">
                        <span class="trail-name">Freshman 2</span>
                        <span class="trail-level">Pré-intermediário</span>
                    </div>
                </div>
                <div class="trail-node trail-left locked" data-testid="trail-node-5">
                    <div class="trail-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <div class="trail-label">
                        <span class="trail-name">Sophomore 1</span>
                        <span class="trail-level">Intermediário</span>
                    </div>
                </div>
                <div class="trail-node trail-right locked" data-testid="trail-node-6">
                    <div class="trail-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <div class="trail-label">
                        <span class="trail-name">Sophomore 2</span>
                        <span class="trail-level">Intermediário</span>
                    </div>
                </div>
                <div class="trail-node trail-left locked" data-testid="trail-node-7">
                    <div class="trail-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <div class="trail-label">
                        <span class="trail-name">Senior 1</span>
                        <span class="trail-level">Avançado</span>
                    </div>
                </div>
                <div class="trail-node trail-right locked" data-testid="trail-node-8">
                    <div class="trail-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <div class="trail-label">
                        <span class="trail-name">Senior 2</span>
                        <span class="trail-level">Avançado</span>
                    </div>
                </div>
                <div class="trail-node trail-center locked" data-testid="trail-node-9">
                    <div class="trail-circle trail-trophy">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                    </div>
                    <div class="trail-label">
                        <span class="trail-name">ACC</span>
                        <span class="trail-level">Conversação Avançada</span>
                    </div>
                </div>
            </div>
            <button class="action-button w-full mt-3" onclick="document.getElementById('journey-modal').classList.remove('active')" data-testid="button-close-journey">Fechar</button>
        </div>
    </div>
    <style>
        .journey-trail {
            position: relative;
            padding: 0.75rem 0 0.5rem;
        }
        .trail-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 3px;
            transform: translateX(-50%);
            background: repeating-linear-gradient(to bottom, #c4b5fd 0px, #c4b5fd 6px, transparent 6px, transparent 12px);
            z-index: 0;
        }
        .trail-node {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.15rem 0;
            z-index: 1;
        }
        .trail-node.trail-left {
            margin-right: 50%;
            flex-direction: row-reverse;
            padding-right: 0;
        }
        .trail-node.trail-left .trail-label {
            text-align: right;
            align-items: flex-end;
            flex: 1;
        }
        .trail-node.trail-left .trail-circle {
            margin-right: -22px;
        }
        .trail-node.trail-right {
            margin-left: 50%;
            padding-left: 0;
        }
        .trail-node.trail-right .trail-label {
            text-align: left;
            align-items: flex-start;
            flex: 1;
        }
        .trail-node.trail-right .trail-circle {
            margin-left: -22px;
        }
        .trail-node.trail-center {
            justify-content: center;
            flex-direction: column;
            text-align: center;
            padding-top: 0.4rem;
        }
        .trail-node.trail-center .trail-label {
            align-items: center;
            margin-top: 0.25rem;
        }
        .trail-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            background: white;
        }
        .trail-node.current .trail-circle {
            background: linear-gradient(135deg, #8671d1, #a78bfa);
            color: white;
            box-shadow: 0 0 0 4px rgba(134,113,209,0.2), 0 4px 15px rgba(134,113,209,0.4);
        }
        .trail-node.locked .trail-circle {
            background: #ede9fe;
            color: #a8a29e;
            border: 2px dashed #d4d0ec;
        }
        .trail-circle.trail-trophy {
            background: linear-gradient(135deg, #F1D24B, #f59e0b) !important;
            color: white !important;
            border: 2px solid #F1D24B !important;
        }
        .trail-label {
            display: flex;
            flex-direction: column;
        }
        .trail-name {
            font-weight: 800;
            font-size: 0.85rem;
            color: #44403c;
            line-height: 1.2;
        }
        .trail-node.locked .trail-name { color: #a8a29e; }
        .trail-level {
            font-size: 0.65rem;
            color: #78716c;
            font-weight: 500;
        }
        .trail-node.locked .trail-level { color: #c7c5c2; }
        .trail-badge-current {
            font-size: 0.55rem;
            font-weight: 800;
            color: white;
            background: linear-gradient(135deg, #8671d1, #a78bfa);
            padding: 0.1rem 0.45rem;
            border-radius: 1rem;
            margin-top: 0.15rem;
            display: inline-block;
            width: fit-content;
            letter-spacing: 0.3px;
        }
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 4px rgba(134,113,209,0.2), 0 4px 15px rgba(134,113,209,0.4); }
            50% { box-shadow: 0 0 0 8px rgba(134,113,209,0.1), 0 4px 20px rgba(134,113,209,0.5); }
        }
    </style>

    <!-- HELP MODAL -->
    <div id="help-modal" class="modal-overlay" onclick="if(event.target === this) this.classList.remove('active')">
        <div class="modal-content" style="max-width: 400px;">
            <h3 class="text-lg font-black text-stone-800 mb-3 text-center" id="help-modal-title">Como Jogar</h3>
            <p class="text-stone-600 text-sm leading-relaxed" id="help-modal-text"></p>
            <button class="action-button w-full mt-5" onclick="document.getElementById('help-modal').classList.remove('active')">Entendi!</button>
        </div>
    </div>

    <script>
        // ===== FIREBASE AUTH =====
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;
        let currentUser = null;

        async function initFirebase() {
            try {
                let config = null;
                try {
                    const res = await fetch('/api/firebase-config');
                    if (res.ok) {
                        const data = await res.json();
                        if (data.apiKey) config = data;
                    }
                } catch (e) {}
                if (!config) {
                    config = {
                        apiKey: "AIzaSyDlleaDp-GKGDgn6A1oFG8THsMPsz1if1E",
                        authDomain: "starter1-ff48b.firebaseapp.com",
                        projectId: "starter1-ff48b"
                    };
                }
                firebaseApp = firebase.initializeApp(config);
                firebaseAuth = firebase.auth();
                firebaseDb = firebase.firestore();
                return true;
            } catch (e) {
                console.error('Could not initialize Firebase:', e);
                return false;
            }
        }

        function switchLoginTab(tab) {
            const tabs = document.querySelectorAll('.login-tab');
            tabs[0].classList.toggle('active', tab === 'login');
            tabs[1].classList.toggle('active', tab === 'register');
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('register-error').style.display = 'none';
        }

        function getFirebaseErrorMessage(code) {
            const messages = {
                'auth/invalid-email': 'Email inválido.',
                'auth/user-disabled': 'Esta conta foi desativada.',
                'auth/user-not-found': 'Email não cadastrado.',
                'auth/wrong-password': 'Senha incorreta.',
                'auth/invalid-credential': 'Email ou senha incorretos.',
                'auth/email-already-in-use': 'Este email já está cadastrado.',
                'auth/weak-password': 'A senha deve ter pelo menos 6 caracteres.',
                'auth/too-many-requests': 'Muitas tentativas. Tente novamente mais tarde.',
                'auth/network-request-failed': 'Erro de conexão. Verifique sua internet.',
                'auth/operation-not-allowed': 'Login por email/senha não está ativado. Ative em Firebase Console > Authentication > Sign-in method.',
                'auth/admin-restricted-operation': 'Cadastro não permitido. Ative Email/Senha em Firebase Console > Authentication > Sign-in method.',
                'auth/configuration-not-found': 'Configuração do Firebase não encontrada. Verifique o projeto no Firebase Console.',
                'auth/internal-error': 'Erro interno. Verifique se Email/Senha está ativado no Firebase Console.',
                'auth/missing-password': 'Digite uma senha.',
                'auth/missing-email': 'Digite um email.',
            };
            console.log('Firebase auth error code:', code);
            return messages[code] || 'Erro: ' + (code || 'desconhecido') + '. Verifique as configurações do Firebase.';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const btn = document.getElementById('login-submit-btn');
            errorEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'ENTRANDO...';
            try {
                await firebaseAuth.signInWithEmailAndPassword(email, password);
            } catch (err) {
                errorEl.textContent = getFirebaseErrorMessage(err.code);
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'ENTRAR';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');
            const btn = document.getElementById('register-submit-btn');
            errorEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'CRIANDO...';
            try {
                const cred = await firebaseAuth.createUserWithEmailAndPassword(email, password);
                await cred.user.updateProfile({ displayName: name });
                await firebaseDb.collection('users').doc(cred.user.uid).set({
                    name: name,
                    email: email,
                    approved: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (err) {
                errorEl.textContent = getFirebaseErrorMessage(err.code);
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'CRIAR CONTA';
            }
        }

        function handleLogout() {
            if (firebaseAuth) {
                currentUser = null;
                showScreen('login');
                firebaseAuth.signOut();
            }
        }

        async function handleAvatarUpload(event) {
            var file = event.target.files[0];
            if (!file || !currentUser || !firebaseDb) return;
            if (!file.type.startsWith('image/')) return;
            if (file.size > 500 * 1024) {
                alert('A imagem deve ter no máximo 500KB. Tente uma foto menor.');
                return;
            }
            var reader = new FileReader();
            reader.onload = async function(e) {
                var canvas = document.createElement('canvas');
                var img = new Image();
                img.onload = async function() {
                    var size = 200;
                    canvas.width = size;
                    canvas.height = size;
                    var ctx = canvas.getContext('2d');
                    var sx = 0, sy = 0, sw = img.width, sh = img.height;
                    if (sw > sh) { sx = (sw - sh) / 2; sw = sh; }
                    else { sy = (sh - sw) / 2; sh = sw; }
                    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, size, size);
                    var dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    try {
                        await firebaseDb.collection('users').doc(currentUser.uid).update({ profilePhoto: dataUrl });
                        setAvatarImage(dataUrl);
                    } catch(err) {
                        console.error('Erro ao salvar foto:', err);
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function setAvatarImage(url) {
            var imgEl = document.getElementById('sidebar-avatar-img');
            var placeholder = document.getElementById('sidebar-avatar-placeholder');
            if (url) {
                imgEl.src = url;
                imgEl.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                imgEl.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        async function loadUserAvatar() {
            if (!firebaseDb || !currentUser) return;
            try {
                var doc = await firebaseDb.collection('users').doc(currentUser.uid).get();
                if (doc.exists && doc.data().profilePhoto) {
                    setAvatarImage(doc.data().profilePhoto);
                }
            } catch(e) {
                console.warn('Erro ao carregar foto:', e);
            }
        }

        async function openGradesModal() {
            var modal = document.getElementById('grades-modal');
            modal.style.display = 'flex';
            var container = document.getElementById('student-grades-content');
            container.innerHTML = '<p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 1rem 0;">Carregando notas...</p>';
            if (!firebaseDb || !currentUser) return;
            try {
                var userDoc = await firebaseDb.collection('users').doc(currentUser.uid).get();
                var userData = userDoc.exists ? userDoc.data() : {};
                var assignedLevel = userData.currentLevel || 'starter1';
                var studentLevels = ['starter1', 'starter2', 'freshman1', 'freshman2', 'sophomore1', 'sophomore2', 'senior1', 'senior2'];
                var lvlLabels = { starter1: 'Starter 1', starter2: 'Starter 2', freshman1: 'Freshman 1', freshman2: 'Freshman 2', sophomore1: 'Sophomore 1', sophomore2: 'Sophomore 2', senior1: 'Senior 1', senior2: 'Senior 2' };
                var assignedIdx = studentLevels.indexOf(assignedLevel);
                if (assignedIdx === -1) assignedIdx = 0;

                var gradeLabels = [
                    { key: 'midterm', name: 'Midterm Test', max: 20 },
                    { key: 'listening', name: 'Listening Test', max: 20 },
                    { key: 'grammar', name: 'Grammar Test', max: 20 },
                    { key: 'oral', name: 'Oral Test', max: 20 },
                    { key: 'attendance', name: 'Assiduidade', max: 10 },
                    { key: 'participation', name: 'Participação', max: 10 }
                ];
                function gradeDisplay(val, max) {
                    return (val !== undefined && val !== null && val !== '' ? val : '--') + ' / ' + max;
                }

                var html = '';
                for (var i = assignedIdx; i <= assignedIdx; i++) {
                    var lvl = studentLevels[i];
                    var doc = await firebaseDb.collection('users').doc(currentUser.uid).collection('grades').doc(lvl).get();
                    var g = doc.exists ? doc.data() : {};
                    if (!doc.exists && lvl === 'starter1') {
                        var oldDoc = await firebaseDb.collection('users').doc(currentUser.uid).collection('grades').doc('current').get();
                        if (oldDoc.exists) g = oldDoc.data() || {};
                    }
                    var total = 0;
                    var allFilled = true;
                    gradeLabels.forEach(function(gl) {
                        if (g[gl.key] === undefined || g[gl.key] === null || g[gl.key] === '') {
                            allFilled = false;
                        } else {
                            total += parseFloat(g[gl.key]);
                        }
                    });
                    var statusHtml = '';
                    var totalDisplay = '';
                    var totalColor = '#44403c';
                    if (allFilled) {
                        totalDisplay = total + ' / 100';
                        totalColor = total >= 70 ? '#16a34a' : '#ef4444';
                        if (total >= 70) {
                            statusHtml = '<span style="font-size: 0.7rem; font-weight: 800; padding: 0.15rem 0.5rem; border-radius: 1rem; background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0;">APROVADO</span>';
                        } else {
                            statusHtml = '<span style="font-size: 0.7rem; font-weight: 800; padding: 0.15rem 0.5rem; border-radius: 1rem; background: #fef9c3; color: #a16207; border: 1px solid #fde68a;">PENDENTE</span>';
                        }
                    } else {
                        totalDisplay = (total > 0 ? total : '--') + ' / 100';
                        statusHtml = '<span style="font-size: 0.7rem; font-weight: 800; padding: 0.15rem 0.5rem; border-radius: 1rem; background: #fef9c3; color: #a16207; border: 1px solid #fde68a;">PENDENTE</span>';
                    }

                    html += '<div style="margin-bottom: 1rem; border: 1.5px solid #e7e5e4; border-radius: 0.75rem; overflow: hidden;" data-testid="card-grades-' + lvl + '">';
                    html += '<div style="background: #f5f3ff; padding: 0.5rem 0.75rem; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">';
                    html += '<span style="font-size: 0.85rem; font-weight: 800; color: #44403c;" data-testid="text-grade-level-' + lvl + '">' + lvlLabels[lvl] + '</span>';
                    html += statusHtml;
                    html += '</div>';
                    html += '<div style="padding: 0.5rem 0.75rem; display: flex; flex-direction: column; gap: 0.35rem;">';
                    gradeLabels.forEach(function(gl) {
                        html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.35rem 0;">';
                        html += '<span style="font-size: 0.78rem; color: #44403c; font-weight: 500;">' + gl.name + '</span>';
                        html += '<span style="font-size: 0.73rem; color: #78716c; background: #f5f5f4; padding: 0.1rem 0.4rem; border-radius: 1rem; font-weight: 600;" data-testid="text-grade-' + gl.key + '-' + lvl + '">' + gradeDisplay(g[gl.key], gl.max) + '</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                    html += '<div style="padding: 0.4rem 0.75rem; background: #fafaf9; border-top: 1px solid #e7e5e4; display: flex; justify-content: space-between; align-items: center;">';
                    html += '<span style="font-size: 0.8rem; font-weight: 800; color: #44403c;">Total</span>';
                    html += '<span style="font-size: 0.8rem; font-weight: 800; color: ' + totalColor + ';" data-testid="text-grade-total-' + lvl + '">' + totalDisplay + '</span>';
                    html += '</div>';
                    html += '</div>';
                }
                container.innerHTML = html;
            } catch(e) {
                console.warn('Erro ao carregar notas:', e);
                container.innerHTML = '<p style="text-align: center; color: #ef4444; font-size: 0.8rem; padding: 1rem 0;">Erro ao carregar notas</p>';
            }
        }
        function openRulesModal() {
            document.getElementById('rules-modal').style.display = 'flex';
        }
        function closeRulesModal() {
            document.getElementById('rules-modal').style.display = 'none';
        }

        function closeGradesModal() {
            document.getElementById('grades-modal').style.display = 'none';
        }

        var allStudentsCache = [];
        var selectedStudentUid = null;

        var teacherCurrentPage = 1;
        var teacherPageSize = 10;

        function initTeacherDashboard() {
            allStudentsCache = [];
            selectedStudentUid = null;
            teacherCurrentPage = 1;
            document.getElementById('teacher-student-detail-overlay').style.display = 'none';
            document.getElementById('teacher-student-detail').style.display = 'none';
            if (currentUser) {
                var displayName = currentUser.displayName || currentUser.email.split('@')[0];
                var firstName = displayName.split(' ')[0];
                document.getElementById('teacher-sidebar-user-name').textContent = firstName;
                firebaseDb.collection('users').doc(currentUser.uid).get().then(function(doc) {
                    if (doc.exists) {
                        var data = doc.data();
                        if (data.avatarUrl) {
                            var imgEl = document.getElementById('teacher-sidebar-avatar-img');
                            var placeholderEl = document.getElementById('teacher-sidebar-avatar-placeholder');
                            imgEl.src = data.avatarUrl;
                            imgEl.style.display = '';
                            placeholderEl.style.display = 'none';
                        }
                    }
                });
            }
            loadAllStudents();
        }

        async function loadAllStudents() {
            var listEl = document.getElementById('teacher-students-list');
            listEl.innerHTML = '<p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 1rem 0;">Carregando...</p>';
            try {
                var snapshot = await firebaseDb.collection('users').get();
                allStudentsCache = [];
                snapshot.forEach(function(doc) {
                    var data = doc.data();
                    if (data.role !== 'teacher') {
                        allStudentsCache.push({ uid: doc.id, ...data });
                    }
                });
                updateTeacherStats();
                teacherCurrentPage = 1;
                renderStudentsPaginated();
            } catch(e) {
                console.error('Erro ao carregar alunos:', e);
                listEl.innerHTML = '<p style="text-align: center; color: #ef4444; font-size: 0.8rem; padding: 1rem 0;">Erro ao carregar alunos. Tente novamente.</p>';
            }
        }

        function updateTeacherStats() {
            var total = allStudentsCache.length;
            var levelNames = { starter1: 'Starter 1', starter2: 'Starter 2' };
            var counts = {};
            allStudentsCache.forEach(function(s) {
                var lvl = s.currentLevel || 'starter1';
                counts[lvl] = (counts[lvl] || 0) + 1;
            });
            var statsEl = document.getElementById('teacher-stats-bar');
            var html = '<div style="flex: 1; min-width: 100px; background: #f5f3ff; border: 1px solid #ede9fe; border-radius: 0.5rem; padding: 0.6rem 0.75rem; text-align: center;">' +
                '<p style="font-size: 1.25rem; font-weight: 800; color: #8671d1;">' + total + '</p>' +
                '<p style="font-size: 0.65rem; font-weight: 600; color: #78716c;">Total de Alunos</p></div>';
            Object.keys(levelNames).forEach(function(lvl) {
                html += '<div style="flex: 1; min-width: 100px; background: #fafaf9; border: 1px solid #e7e5e4; border-radius: 0.5rem; padding: 0.6rem 0.75rem; text-align: center;">' +
                    '<p style="font-size: 1.25rem; font-weight: 800; color: #44403c;">' + (counts[lvl] || 0) + '</p>' +
                    '<p style="font-size: 0.65rem; font-weight: 600; color: #78716c;">' + levelNames[lvl] + '</p></div>';
            });
            statsEl.innerHTML = html;
        }

        function getFilteredStudents() {
            var query = document.getElementById('teacher-search-input').value.toLowerCase().trim();
            if (!query) return allStudentsCache;
            return allStudentsCache.filter(function(s) {
                return (s.name || '').toLowerCase().includes(query) || (s.email || '').toLowerCase().includes(query);
            });
        }

        function renderStudentsPaginated() {
            var filtered = getFilteredStudents();
            var totalPages = Math.max(1, Math.ceil(filtered.length / teacherPageSize));
            if (teacherCurrentPage > totalPages) teacherCurrentPage = totalPages;
            var start = (teacherCurrentPage - 1) * teacherPageSize;
            var pageStudents = filtered.slice(start, start + teacherPageSize);
            renderStudentsList(pageStudents);
            renderPagination(filtered.length, totalPages);
        }

        function renderPagination(total, totalPages) {
            var pagEl = document.getElementById('teacher-pagination');
            if (totalPages <= 1) {
                pagEl.style.display = 'none';
                return;
            }
            pagEl.style.display = 'flex';
            var html = '<button onclick="teacherGoToPage(' + Math.max(1, teacherCurrentPage - 1) + ')" style="background: none; border: 1px solid #e7e5e4; border-radius: 0.375rem; padding: 0.35rem 0.6rem; cursor: pointer; font-family: \'DM Sans\', sans-serif; font-size: 0.75rem; color: #44403c;"' + (teacherCurrentPage <= 1 ? ' disabled style="opacity:0.4; cursor: default; background: none; border: 1px solid #e7e5e4; border-radius: 0.375rem; padding: 0.35rem 0.6rem; font-family: \'DM Sans\', sans-serif; font-size: 0.75rem; color: #44403c;"' : '') + '>&lt;</button>';
            for (var i = 1; i <= totalPages; i++) {
                var isActive = i === teacherCurrentPage;
                html += '<button onclick="teacherGoToPage(' + i + ')" style="border: 1px solid ' + (isActive ? '#8671d1' : '#e7e5e4') + '; border-radius: 0.375rem; padding: 0.35rem 0.6rem; cursor: pointer; font-family: \'DM Sans\', sans-serif; font-size: 0.75rem; font-weight: ' + (isActive ? '700' : '500') + '; color: ' + (isActive ? 'white' : '#44403c') + '; background: ' + (isActive ? '#8671d1' : 'white') + ';">' + i + '</button>';
            }
            html += '<button onclick="teacherGoToPage(' + Math.min(totalPages, teacherCurrentPage + 1) + ')" style="background: none; border: 1px solid #e7e5e4; border-radius: 0.375rem; padding: 0.35rem 0.6rem; cursor: pointer; font-family: \'DM Sans\', sans-serif; font-size: 0.75rem; color: #44403c;"' + (teacherCurrentPage >= totalPages ? ' disabled style="opacity:0.4; cursor: default; background: none; border: 1px solid #e7e5e4; border-radius: 0.375rem; padding: 0.35rem 0.6rem; font-family: \'DM Sans\', sans-serif; font-size: 0.75rem; color: #44403c;"' : '') + '>&gt;</button>';
            pagEl.innerHTML = html;
        }

        function teacherGoToPage(page) {
            teacherCurrentPage = page;
            renderStudentsPaginated();
        }

        function searchStudents() {
            teacherCurrentPage = 1;
            renderStudentsPaginated();
        }

        function formatFirebaseDate(timestamp) {
            if (!timestamp) return '—';
            var date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else if (typeof timestamp === 'number') {
                date = new Date(timestamp);
            } else {
                return '—';
            }
            var day = String(date.getDate()).padStart(2, '0');
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var year = date.getFullYear();
            return day + '/' + month + '/' + year;
        }

        function updateStudentDatesDisplay(student) {
            document.getElementById('detail-student-created').textContent = formatFirebaseDate(student.createdAt);
            document.getElementById('detail-student-approved').textContent = student.approved ? formatFirebaseDate(student.approvedAt) : '—';
        }

        function renderStudentsList(students) {
            var listEl = document.getElementById('teacher-students-list');
            if (students.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 1rem 0;">Nenhum aluno encontrado</p>';
                return;
            }
            var levelNames = { starter1: 'Starter 1', starter2: 'Starter 2' };
            listEl.innerHTML = students.map(function(s) {
                var statusClass = s.approved ? 'student-approved' : 'student-pending';
                var statusText = s.approved ? 'Aprovado' : 'Pendente';
                var statusIcon = s.approved
                    ? '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
                var lvlLabel = levelNames[s.currentLevel] || 'Starter 1';
                var createdDate = formatFirebaseDate(s.createdAt);
                var approvedDate = s.approved ? formatFirebaseDate(s.approvedAt) : '—';
                return '<div class="student-card" onclick="openStudentDetail(\'' + s.uid + '\')" data-testid="card-student-' + s.uid + '">' +
                    '<div style="flex: 1; min-width: 0;">' +
                        '<div style="display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">' +
                            '<span style="font-size: 0.85rem; font-weight: 600; color: #1c1917;">' + (s.name || 'Sem nome') + '</span>' +
                            '<span style="font-size: 0.6rem; font-weight: 600; color: #8671d1; background: #f5f3ff; padding: 0.1rem 0.4rem; border-radius: 0.25rem;">' + lvlLabel + '</span>' +
                        '</div>' +
                        '<p style="font-size: 0.65rem; color: #78716c; margin-top: 0.1rem;">' + (s.email || '') + '</p>' +
                        '<div style="display: flex; gap: 0.75rem; margin-top: 0.25rem;">' +
                            '<span style="font-size: 0.6rem; color: #a8a29e;">Cadastro: ' + createdDate + '</span>' +
                            '<span style="font-size: 0.6rem; color: #a8a29e;">Aprovação: ' + approvedDate + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<span class="' + statusClass + '" style="font-size: 0.65rem; font-weight: 700; display: flex; align-items: center; gap: 0.2rem; flex-shrink: 0;">' + statusIcon + ' ' + statusText + '</span>' +
                '</div>';
            }).join('');
        }

        async function openStudentDetail(uid) {
            selectedStudentUid = uid;
            var student = allStudentsCache.find(function(s) { return s.uid === uid; });
            if (!student) return;

            document.getElementById('detail-student-name').textContent = student.name || 'Sem nome';
            document.getElementById('detail-student-email').textContent = student.email || '';
            document.getElementById('teacher-student-detail-overlay').style.display = 'block';
            document.getElementById('teacher-student-detail').style.display = 'block';
            updateStudentDatesDisplay(student);

            var statusEl = document.getElementById('detail-approval-status');
            var btnEl = document.getElementById('btn-toggle-approval');
            if (student.approved) {
                statusEl.textContent = 'Aprovado';
                statusEl.style.color = '#16a34a';
                btnEl.textContent = 'Revogar Acesso';
                btnEl.style.background = '#ef4444';
                btnEl.style.color = 'white';
            } else {
                statusEl.textContent = 'Pendente';
                statusEl.style.color = '#f59e0b';
                btnEl.textContent = 'Aprovar Aluno';
                btnEl.style.background = '#16a34a';
                btnEl.style.color = 'white';
            }

            document.getElementById('student-level-select').value = student.currentLevel || 'starter1';

            selectedGradeLevel = student.currentLevel || 'starter1';
            renderGradeLevelTabs(student.currentLevel || 'starter1');
            selectedLinksLevel = student.currentLevel || 'starter1';
            renderLinksLevelTabs(student.currentLevel || 'starter1');
            showDetailTab('grades');
            await loadStudentGrades(uid);
            await loadStudentStreaks(uid);
            await loadStudentLinksForTeacher(uid);
        }

        function closeStudentDetail() {
            document.getElementById('teacher-student-detail-overlay').style.display = 'none';
            document.getElementById('teacher-student-detail').style.display = 'none';
            selectedStudentUid = null;
        }

        function showDetailTab(tab) {
            document.getElementById('detail-tab-grades').style.display = tab === 'grades' ? 'block' : 'none';
            document.getElementById('detail-tab-streaks').style.display = tab === 'streaks' ? 'block' : 'none';
            document.getElementById('detail-tab-links').style.display = tab === 'links' ? 'block' : 'none';
            document.getElementById('detail-tab-level').style.display = tab === 'level' ? 'block' : 'none';
            document.getElementById('detail-tab-approval').style.display = tab === 'approval' ? 'block' : 'none';
            document.querySelectorAll('.teacher-tab').forEach(function(t) { t.classList.remove('active'); });
            document.getElementById('tab-' + tab).classList.add('active');
        }

        var selectedGradeLevel = 'starter1';
        var selectedLinksLevel = 'starter1';
        var allLevelsList = ['starter1', 'starter2', 'freshman1', 'freshman2', 'sophomore1', 'sophomore2', 'senior1', 'senior2'];
        var allLevelLabels = { starter1: 'Starter 1', starter2: 'Starter 2', freshman1: 'Freshman 1', freshman2: 'Freshman 2', sophomore1: 'Sophomore 1', sophomore2: 'Sophomore 2', senior1: 'Senior 1', senior2: 'Senior 2', acc: 'ACC' };

        function renderGradeLevelTabs(studentLevel) {
            var container = document.getElementById('grade-level-tabs');
            var assignedIdx = allLevelsList.indexOf(studentLevel);
            if (assignedIdx === -1) assignedIdx = 0;
            var html = '';
            for (var i = 0; i <= assignedIdx; i++) {
                var lvl = allLevelsList[i];
                var isActive = lvl === selectedGradeLevel;
                html += '<button onclick="switchGradeLevel(\'' + lvl + '\')" data-testid="button-grade-level-' + lvl + '" style="padding: 0.3rem 0.6rem; font-size: 0.7rem; font-weight: 700; border-radius: 0.375rem; cursor: pointer; font-family: \'DM Sans\', sans-serif; border: 1.5px solid ' + (isActive ? '#8671d1' : '#d6d3d1') + '; background: ' + (isActive ? '#8671d1' : 'white') + '; color: ' + (isActive ? 'white' : '#78716c') + ';">' + allLevelLabels[lvl] + '</button>';
            }
            container.innerHTML = html;
        }

        window.switchGradeLevel = function(lvl) {
            selectedGradeLevel = lvl;
            if (!selectedStudentUid || !allStudentsCache) return;
            var student = allStudentsCache.find(function(s) { return s.uid === selectedStudentUid; });
            var studentLevel = (student && student.currentLevel) || 'starter1';
            renderGradeLevelTabs(studentLevel);
            loadStudentGrades(selectedStudentUid);
        };

        function renderLinksLevelTabs(studentLevel) {
            var container = document.getElementById('links-level-tabs');
            var assignedIdx = allLevelsList.indexOf(studentLevel);
            if (assignedIdx < 0) assignedIdx = 0;
            var html = '';
            for (var i = 0; i <= assignedIdx; i++) {
                var lvl = allLevelsList[i];
                var isActive = lvl === selectedLinksLevel;
                html += '<button onclick="switchLinksLevel(\'' + lvl + '\')" style="padding: 0.3rem 0.6rem; border-radius: 0.4rem; font-size: 0.7rem; font-weight: 700; cursor: pointer; border: 1.5px solid ' + (isActive ? '#8671d1' : '#e7e5e4') + '; background: ' + (isActive ? '#8671d1' : 'white') + '; color: ' + (isActive ? 'white' : '#78716c') + '; font-family: \'DM Sans\', sans-serif;" data-testid="tab-links-' + lvl + '">' + allLevelLabels[lvl] + '</button>';
            }
            container.innerHTML = html;
        }

        window.switchLinksLevel = function(lvl) {
            selectedLinksLevel = lvl;
            if (!selectedStudentUid || !allStudentsCache) return;
            var student = allStudentsCache.find(function(s) { return s.uid === selectedStudentUid; });
            var studentLevel = (student && student.currentLevel) || 'starter1';
            renderLinksLevelTabs(studentLevel);
            loadStudentLinksForTeacher(selectedStudentUid);
        };

        async function loadStudentGrades(uid) {
            try {
                var doc = await firebaseDb.collection('users').doc(uid).collection('grades').doc(selectedGradeLevel).get();
                var grades = doc.exists ? doc.data() : {};
                if (!doc.exists && selectedGradeLevel === 'starter1') {
                    var oldDoc = await firebaseDb.collection('users').doc(uid).collection('grades').doc('current').get();
                    if (oldDoc.exists) {
                        grades = oldDoc.data() || {};
                        await firebaseDb.collection('users').doc(uid).collection('grades').doc('starter1').set(grades);
                    }
                }
                document.getElementById('grade-midterm').value = grades.midterm !== undefined && grades.midterm !== null ? grades.midterm : '';
                document.getElementById('grade-listening').value = grades.listening !== undefined && grades.listening !== null ? grades.listening : '';
                document.getElementById('grade-grammar').value = grades.grammar !== undefined && grades.grammar !== null ? grades.grammar : '';
                document.getElementById('grade-oral').value = grades.oral !== undefined && grades.oral !== null ? grades.oral : '';
                document.getElementById('grade-attendance').value = grades.attendance !== undefined && grades.attendance !== null ? grades.attendance : '';
                document.getElementById('grade-participation').value = grades.participation !== undefined && grades.participation !== null ? grades.participation : '';
                updateGradeTotal();
            } catch(e) {
                console.warn('Erro ao carregar notas:', e);
            }
        }

        function updateGradeTotal() {
            var fields = ['grade-midterm', 'grade-listening', 'grade-grammar', 'grade-oral', 'grade-attendance', 'grade-participation'];
            var total = 0;
            fields.forEach(function(f) {
                var val = parseFloat(document.getElementById(f).value);
                if (!isNaN(val)) total += val;
            });
            document.getElementById('grade-total-display').textContent = 'Total: ' + total + ' / 100';
            document.getElementById('grade-total-display').style.color = total >= 70 ? '#16a34a' : '#44403c';
        }

        document.addEventListener('input', function(e) {
            if (['grade-midterm', 'grade-listening', 'grade-grammar', 'grade-oral', 'grade-attendance', 'grade-participation'].includes(e.target.id)) {
                updateGradeTotal();
            }
        });

        async function saveStudentGrades() {
            if (!selectedStudentUid) return;
            var fb = document.getElementById('grade-save-feedback');
            fb.style.display = 'block';
            fb.textContent = 'Salvando...';
            fb.style.color = '#78716c';
            try {
                function parseGradeVal(id) {
                    var v = document.getElementById(id).value.trim();
                    if (v === '') return null;
                    var n = parseFloat(v);
                    return isNaN(n) ? null : n;
                }
                var grades = {
                    midterm: parseGradeVal('grade-midterm'),
                    listening: parseGradeVal('grade-listening'),
                    grammar: parseGradeVal('grade-grammar'),
                    oral: parseGradeVal('grade-oral'),
                    attendance: parseGradeVal('grade-attendance'),
                    participation: parseGradeVal('grade-participation'),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await firebaseDb.collection('users').doc(selectedStudentUid).collection('grades').doc(selectedGradeLevel).set(grades);
                fb.textContent = 'Notas salvas com sucesso!';
                fb.style.color = '#16a34a';
                setTimeout(function() { fb.style.display = 'none'; }, 2000);
            } catch(e) {
                console.error('Erro ao salvar notas:', e);
                fb.textContent = 'Erro ao salvar. Tente novamente.';
                fb.style.color = '#ef4444';
            }
        }

        async function loadStudentStreaks(uid) {
            var container = document.getElementById('student-streaks-list');
            try {
                var doc = await firebaseDb.collection('users').doc(uid).collection('streaks').doc('completed').get();
                var streaks = doc.exists ? doc.data() : {};
                var keys = Object.keys(streaks).filter(function(k) { return streaks[k] === true; });
                if (keys.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 1rem 0;">Nenhum streak completado ainda</p>';
                    return;
                }
                var student = allStudentsCache.find(function(s) { return s.uid === uid; });
                var studentLevel = (student && student.currentLevel) || 'starter1';
                var aulaList = studentLevel === 'starter2' ? aulaStarter2 : aulaNames;
                var modeNames = { homework: 'Homework', flashcards: 'Flashcards', listening: 'Listening', chunks: 'Chunks', scramble: 'Unscramble', mistake: 'Detetive', dictation: 'Ditado', hangman: 'Forca', wordsearch: 'Caça-Palavras' };
                var levelNames = { starter1: 'Starter 1', starter2: 'Starter 2', freshman1: 'Freshman 1', freshman2: 'Freshman 2', sophomore1: 'Sophomore 1', sophomore2: 'Sophomore 2', senior1: 'Senior 1', senior2: 'Senior 2', acc: 'ACC' };
                var parsed = keys.map(function(key) {
                    var parts = key.split('_');
                    var level, aulaId, mode;
                    if (parts.length >= 3 && levelNames[parts[0]]) {
                        level = parts[0];
                        aulaId = parseInt(parts[1]) || 0;
                        mode = parts.slice(2).join('_');
                    } else if (parts.length >= 3 && levelNames[parts[0] + parts[1]]) {
                        level = parts[0] + parts[1];
                        aulaId = parseInt(parts[2]) || 0;
                        mode = parts.slice(3).join('_');
                    } else {
                        level = 'starter1';
                        aulaId = parseInt(parts[0]) || 0;
                        mode = parts.slice(1).join('_');
                    }
                    return { level: level, aulaId: aulaId, mode: mode };
                });
                parsed.sort(function(a, b) {
                    if (a.level !== b.level) return (a.level || '').localeCompare(b.level || '');
                    return a.aulaId - b.aulaId;
                });
                container.innerHTML = parsed.map(function(item) {
                    var modeName = modeNames[item.mode] || item.mode;
                    var lvlLabel = levelNames[item.level] || item.level;
                    var aulaListForLevel = item.level === 'starter2' ? aulaStarter2 : aulaNames;
                    var aula = aulaListForLevel.find(function(a) { return a.id === item.aulaId; });
                    var aulaTitle = aula ? aula.name : '';
                    var label = lvlLabel + ' - Aula ' + item.aulaId + (aulaTitle ? ' (' + aulaTitle + ')' : '') + ' - ' + modeName;
                    return '<div style="display: flex; align-items: center; gap: 0.4rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; padding: 0.5rem 0.75rem;">' +
                        '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' +
                        '<span style="font-size: 0.8rem; font-weight: 600; color: #166534;">' + label + '</span>' +
                    '</div>';
                }).join('');
            } catch(e) {
                console.warn('Erro ao carregar streaks:', e);
                container.innerHTML = '<p style="text-align: center; color: #ef4444; font-size: 0.8rem; padding: 1rem 0;">Erro ao carregar streaks</p>';
            }
        }

        async function loadStudentLinksForTeacher(uid) {
            try {
                var doc = await firebaseDb.collection('users').doc(uid).collection('links').doc(selectedLinksLevel).get();
                var data = doc.exists ? doc.data() : {};
                if (!doc.exists && selectedLinksLevel === 'starter1') {
                    var userDoc = await firebaseDb.collection('users').doc(uid).get();
                    var userData = userDoc.exists ? userDoc.data() : {};
                    if (userData.cpLink || userData.recordedLink) {
                        data = { cpLink: userData.cpLink || '', recordedLink: userData.recordedLink || '' };
                        await firebaseDb.collection('users').doc(uid).collection('links').doc('starter1').set(data);
                    }
                }
                document.getElementById('student-cp-link').value = data.cpLink || '';
                document.getElementById('student-recorded-link').value = data.recordedLink || '';
            } catch(e) {
                console.warn('Erro ao carregar links do aluno:', e);
            }
        }

        async function saveStudentLinks() {
            if (!selectedStudentUid) return;
            var fb = document.getElementById('student-links-save-feedback');
            fb.style.display = 'block';
            fb.textContent = 'Salvando...';
            fb.style.color = '#78716c';
            try {
                var cpLink = document.getElementById('student-cp-link').value.trim();
                var recordedLink = document.getElementById('student-recorded-link').value.trim();
                await firebaseDb.collection('users').doc(selectedStudentUid).collection('links').doc(selectedLinksLevel).set({
                    cpLink: cpLink,
                    recordedLink: recordedLink
                });
                fb.textContent = 'Links salvos com sucesso!';
                fb.style.color = '#16a34a';
                setTimeout(function() { fb.style.display = 'none'; }, 2000);
            } catch(e) {
                console.error('Erro ao salvar links:', e);
                fb.textContent = 'Erro ao salvar. Tente novamente.';
                fb.style.color = '#ef4444';
            }
        }

        async function toggleStudentApproval() {
            if (!selectedStudentUid) return;
            var student = allStudentsCache.find(function(s) { return s.uid === selectedStudentUid; });
            if (!student) return;
            var newStatus = !student.approved;
            try {
                var updateData = { approved: newStatus };
                if (newStatus) {
                    updateData.approvedAt = firebase.firestore.FieldValue.serverTimestamp();
                } else {
                    updateData.approvedAt = null;
                }
                await firebaseDb.collection('users').doc(selectedStudentUid).update(updateData);
                student.approved = newStatus;
                student.approvedAt = newStatus ? new Date() : null;
                var statusEl = document.getElementById('detail-approval-status');
                var btnEl = document.getElementById('btn-toggle-approval');
                if (newStatus) {
                    statusEl.textContent = 'Aprovado';
                    statusEl.style.color = '#16a34a';
                    btnEl.textContent = 'Revogar Acesso';
                    btnEl.style.background = '#ef4444';
                } else {
                    statusEl.textContent = 'Pendente';
                    statusEl.style.color = '#f59e0b';
                    btnEl.textContent = 'Aprovar Aluno';
                    btnEl.style.background = '#16a34a';
                }
                updateStudentDatesDisplay(student);
                renderStudentsPaginated();
            } catch(e) {
                console.error('Erro ao alterar aprovação:', e);
            }
        }

        async function saveStudentLevel() {
            if (!selectedStudentUid) return;
            var level = document.getElementById('student-level-select').value;
            var feedback = document.getElementById('level-save-feedback');
            try {
                await firebaseDb.collection('users').doc(selectedStudentUid).update({ currentLevel: level });
                var student = allStudentsCache.find(function(s) { return s.uid === selectedStudentUid; });
                if (student) student.currentLevel = level;
                feedback.textContent = 'N\u00edvel salvo com sucesso!';
                feedback.style.color = '#16a34a';
                feedback.style.display = 'block';
                setTimeout(function() { feedback.style.display = 'none'; }, 2500);
            } catch(e) {
                console.error('Erro ao salvar n\u00edvel:', e);
                feedback.textContent = 'Erro ao salvar. Tente novamente.';
                feedback.style.color = '#ef4444';
                feedback.style.display = 'block';
            }
        }

        async function loadStudentLinks() {
            if (!firebaseDb || !firebaseAuth.currentUser) return;
            try {
                var uid = firebaseAuth.currentUser.uid;
                var doc = await firebaseDb.collection('users').doc(uid).collection('links').doc(currentLevel).get();
                var data = doc.exists ? doc.data() : {};
                if (!doc.exists && currentLevel === 'starter1') {
                    var userDoc = await firebaseDb.collection('users').doc(uid).get();
                    var userData = userDoc.exists ? userDoc.data() : {};
                    if (userData.cpLink || userData.recordedLink) {
                        data = { cpLink: userData.cpLink || '', recordedLink: userData.recordedLink || '' };
                        await firebaseDb.collection('users').doc(uid).collection('links').doc('starter1').set(data);
                    }
                }
                var cpEl = document.getElementById('sidebar-cp-link');
                if (cpEl) cpEl.href = data.cpLink || '#';
                var recordedEl = document.getElementById('sidebar-recorded-link');
                if (recordedEl) recordedEl.href = data.recordedLink || '#';
            } catch(e) {
                console.warn('Erro ao carregar links:', e);
            }
        }

        function toggleSidebar() {
            document.getElementById('app-sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('open');
        }
        function closeSidebar() {
            document.getElementById('app-sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('open');
        }

        function toggleTeacherSidebar() {
            document.getElementById('teacher-sidebar').classList.toggle('open');
            document.getElementById('teacher-sidebar-overlay').classList.toggle('open');
        }
        function closeTeacherSidebar() {
            document.getElementById('teacher-sidebar').classList.remove('open');
            document.getElementById('teacher-sidebar-overlay').classList.remove('open');
        }

        function showTeacherSection(section) {
            var sections = ['students', 'grades', 'links', 'streaks', 'ranking'];
            sections.forEach(function(s) {
                var el = document.getElementById('teacher-section-' + s);
                if (el) el.style.display = 'none';
            });
            var target = document.getElementById('teacher-section-' + section);
            if (target) target.style.display = '';
            document.querySelectorAll('.teacher-sidebar-nav').forEach(function(btn) {
                btn.classList.remove('active');
            });
            var activeBtn = document.getElementById('teacher-nav-' + section);
            if (activeBtn) activeBtn.classList.add('active');
            if (section === 'ranking') {
                loadTeacherRanking();
            }
        }

        async function handleTeacherAvatarUpload(event) {
            var file = event.target.files[0];
            if (!file || !currentUser) return;
            try {
                var reader = new FileReader();
                reader.onload = async function(e) {
                    var dataUrl = e.target.result;
                    await firebaseDb.collection('users').doc(currentUser.uid).update({ avatarUrl: dataUrl });
                    var imgEl = document.getElementById('teacher-sidebar-avatar-img');
                    var placeholderEl = document.getElementById('teacher-sidebar-avatar-placeholder');
                    imgEl.src = dataUrl;
                    imgEl.style.display = '';
                    placeholderEl.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } catch(err) {
                console.error('Erro ao enviar avatar:', err);
            }
        }

        function showScreen(screen) {
            var screens = ['login-screen', 'pending-screen', 'journey-map-screen', 'main-wrapper', 'teacher-screen'];
            screens.forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            if (screen === 'login') {
                document.getElementById('login-screen').style.display = 'flex';
            }
            if (screen === 'pending') {
                document.getElementById('pending-screen').style.display = 'flex';
            }
            if (screen === 'journey') {
                document.getElementById('journey-map-screen').style.display = 'flex';
            }
            if (screen === 'app') {
                document.getElementById('main-wrapper').style.display = '';
                document.getElementById('main-wrapper').classList.remove('hidden');
            }
            if (screen === 'teacher') {
                document.getElementById('teacher-screen').style.display = '';
            }
        }

        function enterLevel(level) {
            if (level === 'starter1' || level === 'starter2') {
                currentLevel = level;
                showScreen('app');
                const displayName = currentUser.displayName || currentUser.email.split('@')[0];
                const firstName = displayName.split(' ')[0];
                document.getElementById('sidebar-user-name').textContent = firstName;
                var levelLabel = level === 'starter2' ? 'Starter 2' : 'Starter 1';
                var headerTitle = document.querySelector('#main-header h1');
                if (headerTitle) headerTitle.textContent = 'Portal do Aluno - ' + levelLabel;
                renderDashboard();
                loadStudentLinks();
                loadUserAvatar();
            }
        }

        function updateJourneyMap(assignedLevel) {
            var allLevels = ['starter1', 'starter2', 'freshman1', 'freshman2', 'sophomore1', 'sophomore2', 'senior1', 'senior2', 'acc'];
            var levelTestIds = {
                'starter1': 'button-level-starter1',
                'starter2': 'button-level-starter2',
                'freshman1': 'button-level-freshman1',
                'freshman2': 'button-level-freshman2',
                'sophomore1': 'button-level-sophomore1',
                'sophomore2': 'button-level-sophomore2',
                'senior1': 'button-level-senior1',
                'senior2': 'button-level-senior2',
                'acc': 'button-level-acc'
            };
            var assignedIdx = allLevels.indexOf(assignedLevel);
            if (assignedIdx === -1) assignedIdx = 0;

            var boltIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>';
            var lockIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>';

            allLevels.forEach(function(lvl, idx) {
                var node = document.querySelector('[data-testid="' + levelTestIds[lvl] + '"]');
                if (!node) return;
                var circle = node.querySelector('.jmap-circle');

                if (idx <= assignedIdx) {
                    node.className = 'jmap-snode jmap-current';
                    node.onclick = function() { enterLevel(lvl); };
                    node.style.cursor = 'pointer';
                    circle.className = 'jmap-circle jmap-circle-active pulse-glow';
                    circle.innerHTML = boltIcon;
                    var badge = node.querySelector('.jmap-badge-active');
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'jmap-badge-active';
                        node.appendChild(badge);
                    }
                    badge.textContent = 'Selecionar';
                } else {
                    node.className = 'jmap-snode jmap-locked';
                    node.onclick = null;
                    node.style.cursor = 'default';
                    if (lvl === 'acc') {
                        circle.className = 'jmap-circle jmap-circle-trophy';
                    } else {
                        circle.className = 'jmap-circle jmap-circle-locked';
                    }
                    circle.innerHTML = lockIcon;
                    var badge = node.querySelector('.jmap-badge-active');
                    if (badge) badge.remove();
                }
            });
        }

        async function checkUserApproval(user) {
            try {
                const doc = await firebaseDb.collection('users').doc(user.uid).get();
                if (!doc.exists) {
                    await firebaseDb.collection('users').doc(user.uid).set({
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        approved: false,
                        role: 'student',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return { approved: false, role: 'student' };
                }
                var data = doc.data();
                return { approved: data.approved === true, role: data.role || 'student', currentLevel: data.currentLevel || 'starter1' };
            } catch (e) {
                console.error('Erro ao verificar aprovação:', e);
                return { approved: false, role: 'student' };
            }
        }

        async function onAuthStateChanged(user) {
            currentUser = user;
            if (user) {
                const result = await checkUserApproval(user);
                if (result.role === 'teacher') {
                    showScreen('teacher');
                    initTeacherDashboard();
                } else if (result.approved) {
                    await loadUserStreaks();
                    syncChunksStreaks();
                    const displayName = user.displayName || user.email.split('@')[0];
                    document.getElementById('journey-user-name').textContent = displayName;
                    updateJourneyMap(result.currentLevel || 'starter1');
                    showScreen('journey');
                } else {
                    document.getElementById('pending-user-email').textContent = user.email;
                    showScreen('pending');
                }
            } else {
                showScreen('login');
                document.getElementById('login-submit-btn').disabled = false;
                document.getElementById('login-submit-btn').textContent = 'ENTRAR';
                document.getElementById('register-submit-btn').disabled = false;
                document.getElementById('register-submit-btn').textContent = 'CRIAR CONTA';
            }
        }

        const audioCache = new Map();

        function playCorrectSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 523;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.15;
                oscillator.start();
                setTimeout(() => { oscillator.frequency.value = 659; }, 100);
                setTimeout(() => { oscillator.frequency.value = 784; }, 200);
                oscillator.stop(audioCtx.currentTime + 0.3);
            } catch(e) {}
        }

        function playIncorrectSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 200;
                oscillator.type = 'square';
                gainNode.gain.value = 0.1;
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.25);
            } catch(e) {}
        }

        let currentStreak = 0;
        let quizStreak = 0;
        const STREAK_GOAL = 10;
        const SCRAMBLE_STREAK_GOAL = 7;
        const HANGMAN_STREAK_GOAL = 3;
        const WORDSEARCH_STREAK_GOAL = 2;
        let currentAulaId = 0;
        let currentStudyMode = '';

        var userStreaksCache = {};

        async function loadUserStreaks() {
            if (!firebaseDb || !currentUser) return;
            try {
                var doc = await firebaseDb.collection('users').doc(currentUser.uid).collection('streaks').doc('completed').get();
                if (doc.exists) {
                    userStreaksCache = doc.data() || {};
                    var needsSave = false;
                    var keys = Object.keys(userStreaksCache);
                    for (var k of keys) {
                        if (k.match(/^\d+_\w+$/) && !k.startsWith('starter')) {
                            var newKey = 'starter1_' + k;
                            if (!userStreaksCache[newKey]) {
                                userStreaksCache[newKey] = true;
                                needsSave = true;
                            }
                            delete userStreaksCache[k];
                            needsSave = true;
                        }
                    }
                    if (needsSave) {
                        await firebaseDb.collection('users').doc(currentUser.uid).collection('streaks').doc('completed').set(userStreaksCache);
                    }
                } else {
                    userStreaksCache = {};
                }
            } catch(e) {
                console.warn('Erro ao carregar streaks:', e);
                userStreaksCache = {};
            }
        }

        async function markStreakDone(aulaId, mode) {
            var key = currentLevel + '_' + aulaId + '_' + mode;
            userStreaksCache[key] = true;
            var oldKey = aulaId + '_' + mode;
            if (userStreaksCache[oldKey]) delete userStreaksCache[oldKey];
            if (firebaseDb && currentUser) {
                try {
                    await firebaseDb.collection('users').doc(currentUser.uid).collection('streaks').doc('completed').set(userStreaksCache);
                } catch(e) {
                    console.warn('Erro ao salvar streak:', e);
                }
            }
        }

        function isStreakDone(aulaId, mode) {
            return !!userStreaksCache[currentLevel + '_' + aulaId + '_' + mode];
        }

        async function openTopStudentsModal() {
            var modal = document.getElementById('top-students-modal');
            modal.style.display = 'flex';
            var levelNames = { starter1: 'Starter 1', starter2: 'Starter 2' };
            document.getElementById('top-students-level-label').textContent = levelNames[currentLevel] || currentLevel;
            var contentEl = document.getElementById('top-students-content');
            contentEl.innerHTML = '<p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 2rem 0;">Carregando ranking...</p>';
            try {
                var usersSnap = await firebaseDb.collection('users').where('approved', '==', true).get();
                var students = [];
                var promises = [];
                usersSnap.forEach(function(doc) {
                    var data = doc.data();
                    if (data.role === 'teacher') return;
                    students.push({ uid: doc.id, name: data.name || data.email || 'Aluno', avatarUrl: data.avatarUrl || null });
                    promises.push(firebaseDb.collection('users').doc(doc.id).collection('streaks').doc('completed').get());
                });
                var streakDocs = await Promise.all(promises);
                for (var i = 0; i < students.length; i++) {
                    var streakCount = 0;
                    if (streakDocs[i].exists) {
                        var streakData = streakDocs[i].data();
                        var keys = Object.keys(streakData);
                        for (var k = 0; k < keys.length; k++) {
                            if (keys[k].startsWith(currentLevel + '_') && streakData[keys[k]]) {
                                streakCount++;
                            }
                        }
                    }
                    students[i].streaks = streakCount;
                }
                students.sort(function(a, b) { return b.streaks - a.streaks; });
                var top5 = students.slice(0, 5);
                if (top5.length === 0 || top5[0].streaks === 0) {
                    contentEl.innerHTML = '<p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 2rem 0;">Nenhum aluno com streaks neste n\u00edvel ainda.</p>';
                    return;
                }
                var medalIcons = [
                    '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#F1D24B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/><text x="12" y="11" text-anchor="middle" font-size="7" font-weight="900" fill="#F1D24B" stroke="none">1</text></svg>',
                    '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#a8a29e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/><text x="12" y="11" text-anchor="middle" font-size="7" font-weight="900" fill="#a8a29e" stroke="none">2</text></svg>',
                    '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fb923c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/><text x="12" y="11" text-anchor="middle" font-size="7" font-weight="900" fill="#fb923c" stroke="none">3</text></svg>',
                    '<div style="width: 24px; height: 24px; border-radius: 50%; background: #f5f5f4; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 800; color: #78716c;">4</div>',
                    '<div style="width: 24px; height: 24px; border-radius: 50%; background: #f5f5f4; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 800; color: #78716c;">5</div>'
                ];
                var bgColors = ['#fef9c3', '#f5f5f4', '#fed7aa', '#fafaf9', '#fafaf9'];
                var borderColors = ['#F1D24B', '#d6d3d1', '#fb923c', '#e7e5e4', '#e7e5e4'];
                contentEl.innerHTML = top5.map(function(s, idx) {
                    var isMe = currentUser && s.uid === currentUser.uid;
                    var highlight = isMe ? 'border: 2px solid #8671d1;' : 'border: 1px solid ' + borderColors[idx] + ';';
                    var avatarHtml = s.avatarUrl
                        ? '<img src="' + s.avatarUrl + '" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">'
                        : '<div style="width: 36px; height: 36px; border-radius: 50%; background: #ede9fe; display: flex; align-items: center; justify-content: center;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8671d1" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>';
                    var fullName = s.name;
                    return '<div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.75rem; background: ' + bgColors[idx] + '; ' + highlight + '" data-testid="card-top-student-' + idx + '">' +
                        '<div style="min-width: 28px; display: flex; align-items: center; justify-content: center;">' + medalIcons[idx] + '</div>' +
                        avatarHtml +
                        '<div style="flex: 1; min-width: 0;">' +
                            '<p style="font-size: 0.85rem; font-weight: 700; color: #1c1917; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + fullName + (isMe ? ' <span style="font-size: 0.65rem; color: #8671d1; font-weight: 600;">(voc\u00ea)</span>' : '') + '</p>' +
                        '</div>' +
                        '<div style="display: flex; align-items: center; gap: 0.3rem; background: white; padding: 0.3rem 0.6rem; border-radius: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#F1D24B" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>' +
                            '<span style="font-size: 0.8rem; font-weight: 800; color: #44403c;">' + s.streaks + '</span>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch(e) {
                console.error('Erro ao carregar ranking:', e);
                contentEl.innerHTML = '<p style="text-align: center; color: #ef4444; font-size: 0.8rem; padding: 2rem 0;">Erro ao carregar ranking. Tente novamente.</p>';
            }
        }

        function closeTopStudentsModal() {
            document.getElementById('top-students-modal').style.display = 'none';
        }

        var teacherRankingLevel = 'starter1';

        async function loadTeacherRanking() {
            var levelNames = { starter1: 'Starter 1', starter2: 'Starter 2' };
            var tabsEl = document.getElementById('teacher-ranking-level-tabs');
            tabsEl.innerHTML = Object.keys(levelNames).map(function(lvl) {
                var isActive = lvl === teacherRankingLevel;
                return '<button onclick="teacherRankingLevel=\'' + lvl + '\'; loadTeacherRanking();" class="teacher-tab' + (isActive ? ' active' : '') + '" data-testid="button-ranking-tab-' + lvl + '">' + levelNames[lvl] + '</button>';
            }).join('');
            var contentEl = document.getElementById('teacher-ranking-content');
            contentEl.innerHTML = '<p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 2rem 0;">Carregando ranking...</p>';
            try {
                var usersSnap = await firebaseDb.collection('users').where('approved', '==', true).get();
                var students = [];
                var promises = [];
                usersSnap.forEach(function(doc) {
                    var data = doc.data();
                    if (data.role === 'teacher') return;
                    students.push({ uid: doc.id, name: data.name || data.email || 'Aluno', avatarUrl: data.avatarUrl || null });
                    promises.push(firebaseDb.collection('users').doc(doc.id).collection('streaks').doc('completed').get());
                });
                var streakDocs = await Promise.all(promises);
                for (var i = 0; i < students.length; i++) {
                    var streakCount = 0;
                    if (streakDocs[i].exists) {
                        var streakData = streakDocs[i].data();
                        var keys = Object.keys(streakData);
                        for (var k = 0; k < keys.length; k++) {
                            if (keys[k].startsWith(teacherRankingLevel + '_') && streakData[keys[k]]) {
                                streakCount++;
                            }
                        }
                    }
                    students[i].streaks = streakCount;
                }
                students.sort(function(a, b) { return b.streaks - a.streaks; });
                var top10 = students.slice(0, 10);
                if (top10.length === 0 || top10[0].streaks === 0) {
                    contentEl.innerHTML = '<p style="text-align: center; color: #a8a29e; font-size: 0.8rem; padding: 2rem 0;">Nenhum aluno com streaks neste n\u00edvel ainda.</p>';
                    return;
                }
                function tRankIcon(n) {
                    if (n === 1) return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#F1D24B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/><text x="12" y="11" text-anchor="middle" font-size="7" font-weight="900" fill="#F1D24B" stroke="none">1</text></svg>';
                    if (n === 2) return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#a8a29e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/><text x="12" y="11" text-anchor="middle" font-size="7" font-weight="900" fill="#a8a29e" stroke="none">2</text></svg>';
                    if (n === 3) return '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fb923c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/><text x="12" y="11" text-anchor="middle" font-size="7" font-weight="900" fill="#fb923c" stroke="none">3</text></svg>';
                    return '<div style="width: 24px; height: 24px; border-radius: 50%; background: #f5f5f4; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 800; color: #78716c;">' + n + '</div>';
                }
                function tRankBg(n) { return n === 1 ? '#fef9c3' : n === 2 ? '#f5f5f4' : n === 3 ? '#fed7aa' : '#fafaf9'; }
                function tRankBorder(n) { return n === 1 ? '#F1D24B' : n === 2 ? '#d6d3d1' : n === 3 ? '#fb923c' : '#e7e5e4'; }
                contentEl.innerHTML = top10.map(function(s, idx) {
                    var pos = idx + 1;
                    var avatarHtml = s.avatarUrl
                        ? '<img src="' + s.avatarUrl + '" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">'
                        : '<div style="width: 36px; height: 36px; border-radius: 50%; background: #ede9fe; display: flex; align-items: center; justify-content: center;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8671d1" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>';
                    return '<div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.75rem; background: ' + tRankBg(pos) + '; border: 1px solid ' + tRankBorder(pos) + ';" data-testid="card-teacher-ranking-' + idx + '">' +
                        '<div style="min-width: 28px; display: flex; align-items: center; justify-content: center;">' + tRankIcon(pos) + '</div>' +
                        avatarHtml +
                        '<div style="flex: 1; min-width: 0;">' +
                            '<p style="font-size: 0.85rem; font-weight: 700; color: #1c1917; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + s.name + '</p>' +
                        '</div>' +
                        '<div style="display: flex; align-items: center; gap: 0.3rem; background: white; padding: 0.3rem 0.6rem; border-radius: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#F1D24B" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>' +
                            '<span style="font-size: 0.8rem; font-weight: 800; color: #44403c;">' + s.streaks + '</span>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch(e) {
                console.error('Erro ao carregar ranking:', e);
                contentEl.innerHTML = '<p style="text-align: center; color: #ef4444; font-size: 0.8rem; padding: 2rem 0;">Erro ao carregar ranking.</p>';
            }
        }

        const helpTexts = {
            flashcards: { title: "Como estudar com os Flashcards", text: "Toque no cartão para virar e ver a tradução em inglês. Use as setas para navegar entre os cartões. Clique no ícone de som para ouvir a pronúncia." },
            listening: { title: "Como estudar com o Listening", text: "Toque em cada item para ouvir como se pronuncia em inglês. Pratique repetindo em voz alta!" },
            chunks: { title: "Como estudar com os Chunks", text: "Leia a frase em português e digite a tradução em inglês. Se acertar, fica verde e o áudio fica disponível! Complete todos os chunks para finalizar a missão." },
            dictation: { title: "Como estudar com o Ditado", text: "Ouça o áudio e escreva exatamente o que ouviu. Pode ser o número ou a palavra por extenso. Acerte 5 seguidas para completar!" },
            scramble: { title: "Como estudar com o Unscramble", text: "As palavras estão embaralhadas. Toque nelas na ordem correta para formar a frase. Acerte 5 seguidas para completar!" },
            mistake: { title: "Como estudar com o Mistake", text: "Uma das palavras está errada. Encontre e clique nela! Acerte 5 seguidas para completar!" },
            hangman: { title: "Como estudar com a Forca", text: "Adivinhe a palavra letra por letra. Cada erro desenha uma parte do boneco. Se completar o desenho, você perde!" },
            wordsearch: { title: "Como estudar com o Caça-Palavras", text: "Encontre as palavras escondidas no grid. Elas podem estar na horizontal ou vertical. Você tem 2 minutos!" },
            homework: { title: "Como estudar com o Homework", text: "Responda as questões corretamente. Leia a explicação quando acertar. Acerte 10 seguidas para completar a missão!" }
        };

        function showHelpModal() {
            const modal = document.getElementById('help-modal');
            const help = helpTexts[currentStudyMode] || { title: "Como estudar", text: "Siga as instruções na tela para completar a atividade." };
            document.getElementById('help-modal-title').textContent = help.title;
            document.getElementById('help-modal-text').textContent = help.text;
            modal.classList.add('active');
        } 

        // --- APP DATA ---
        var currentLevel = 'starter1';

        const aulaStarter2 = [
            { id: 1, name: "Open House", hasHomework: false, desc: "Aula introdut\u00f3ria do Starter 2." },
            { id: 2, name: "Frequency", hasHomework: true, specialMode: 'flashcards', thirdBtn: 'chunks', desc: "Aprenda advérbios de frequência em inglês." },
            { id: 3, name: "Routine", hasHomework: true, desc: "Pratique vocabulário e frases sobre rotina diária." },
            { id: 4, name: "Why & Because", hasHomework: true, desc: "Treine perguntas com Why e respostas com Because." },
            { id: 5, name: "Places In Town", hasHomework: true, desc: "Vocabulário de lugares na cidade." },
            { id: 6, name: "Prepositions Of Place", hasHomework: true, desc: "Pratique in, on, at, next to, between, behind..." },
            { id: 7, name: "In, On, At + Transportations", hasHomework: true, desc: "Preposições com meios de transporte." },
            { id: 8, name: "Possessives", hasHomework: true, desc: "Treine o uso do possessivo com 's e of." },
            { id: 9, name: "Parts of the House", hasHomework: true, desc: "Vocabulário dos cômodos da casa." },
            { id: 10, name: "Furniture & Chores", hasHomework: true, specialMode: 'flashcards', desc: "Móveis e tarefas domésticas em inglês." },
            { id: 11, name: "Present Continuous", hasHomework: true, desc: "Pratique o presente contínuo: am/is/are + -ing." },
            { id: 12, name: "Present Continuous For Future", hasHomework: true, desc: "Use o presente contínuo para falar de planos futuros." },
            { id: 13, name: "Many & Much", hasHomework: true, desc: "Aprenda quando usar many e much." },
            { id: 14, name: "Restaurant Pt. 1", hasHomework: true, desc: "Vocabulário e frases para restaurante." },
            { id: 15, name: "Restaurant Pt. 2", hasHomework: true, desc: "Continue praticando situações em restaurante." },
            { id: 16, name: "Midterm Test", hasHomework: false, desc: "Prova intermediária do módulo." },
            { id: 17, name: "Future Simple", hasHomework: true, desc: "Pratique o futuro simples com will." },
            { id: 18, name: "MT Correction", hasHomework: false, desc: "Correção da prova intermediária." },
            { id: 19, name: "What Will You Do?", hasHomework: true, desc: "Treine perguntas e respostas com will." },
            { id: 20, name: "Occupations", hasHomework: true, desc: "Vocabulário de profissões em inglês." },
            { id: 21, name: "False Friends", hasHomework: true, desc: "Cuidado com os falsos cognatos!" },
            { id: 22, name: "Agreeing & Disagreeing", hasHomework: true, desc: "Aprenda a concordar e discordar em inglês." },
            { id: 23, name: "Describing People", hasHomework: true, desc: "Descreva pessoas usando adjetivos em inglês." },
            { id: 24, name: "Movie Genres", hasHomework: true, specialMode: 'listening', thirdBtn: 'hangman', desc: "Vocabulário de gêneros de filmes.", items: [{n:"Action",w:"Ação"},{n:"Comedy",w:"Comédia"},{n:"Drama",w:"Drama"},{n:"Horror",w:"Terror"},{n:"Romance",w:"Romance"},{n:"Thriller",w:"Suspense"},{n:"Science Fiction",w:"Ficção Científica"},{n:"Animation",w:"Animação"},{n:"Adventure",w:"Aventura"},{n:"Fantasy",w:"Fantasia"},{n:"Documentary",w:"Documentário"},{n:"Musical",w:"Musical"},{n:"Mystery",w:"Mistério"},{n:"Western",w:"Faroeste"},{n:"Crime",w:"Crime"},{n:"War",w:"Guerra"},{n:"Biography",w:"Biografia"},{n:"Family",w:"Família"},{n:"Superhero",w:"Super-herói"},{n:"Historical",w:"Histórico"}] },
            { id: 25, name: "Presentation", hasHomework: false, desc: "Aula de apresentação oral." },
            { id: 26, name: "Prepositions Of Time", hasHomework: true, desc: "Pratique in, on, at com tempo e datas." },
            { id: 27, name: "Fast Food & Tastes", hasHomework: true, desc: "Vocabulário de fast food e sabores." },
            { id: 28, name: "Weather", hasHomework: true, desc: "Aprenda a falar sobre o clima em inglês." },
            { id: 29, name: "Kahoot Review", hasHomework: false, desc: "Revisão interativa com Kahoot." },
            { id: 30, name: "Listening Test", hasHomework: false, desc: "Prova de compreensão auditiva." },
            { id: 31, name: "Grammar Test", hasHomework: false, desc: "Prova de gramática do módulo." },
            { id: 32, name: "GT & LT Correction", hasHomework: false, desc: "Correção das provas de gramática e listening." },
            { id: 33, name: "OT Review", hasHomework: false, desc: "Revisão para a prova oral." },
            { id: 34, name: "Oral Test Day 1", hasHomework: false, desc: "Primeiro dia da prova oral." },
            { id: 35, name: "Oral Test Day 2", hasHomework: false, desc: "Segundo dia da prova oral." },
            { id: 36, name: "General Feedback", hasHomework: false, desc: "Feedback geral do módulo." }
        ];

        const quizDataStarter2 = {
            11: [ // Present Continuous (15 perguntas)
                {q: "Complete: 'She ____ reading a book right now.'", options: [{text:"is", isCorrect:true}, {text:"are", isCorrect:false}, {text:"am", isCorrect:false}, {text:"be", isCorrect:false}], rationale: "She + is (terceira pessoa do singular)."},
                {q: "Escolha a frase correta no Present Continuous:", options: [{text:"I am study English", isCorrect:false}, {text:"I am studying English", isCorrect:true}, {text:"I studying English", isCorrect:false}, {text:"I study English now", isCorrect:false}], rationale: "Present Continuous = am/is/are + verbo-ing."},
                {q: "Complete: 'They ____ playing soccer at the moment.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"are", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "They + are."},
                {q: "Qual frase está no Present Continuous?", options: [{text:"She works every day", isCorrect:false}, {text:"She is working right now", isCorrect:true}, {text:"She worked yesterday", isCorrect:false}, {text:"She will work tomorrow", isCorrect:false}], rationale: "'is working' = am/is/are + -ing = Present Continuous."},
                {q: "Complete a negativa: 'He ____ watching TV.'", options: [{text:"isn't", isCorrect:true}, {text:"aren't", isCorrect:false}, {text:"don't", isCorrect:false}, {text:"doesn't", isCorrect:false}], rationale: "Negativa no Present Continuous: He + isn't + verbo-ing."},
                {q: "Escolha a pergunta correta no Present Continuous:", options: [{text:"Do you eating?", isCorrect:false}, {text:"Are you eating?", isCorrect:true}, {text:"You are eating?", isCorrect:false}, {text:"Is you eating?", isCorrect:false}], rationale: "Pergunta: Are + you + verbo-ing?"},
                {q: "Qual é a forma -ing de 'run'?", options: [{text:"runing", isCorrect:false}, {text:"running", isCorrect:true}, {text:"runeing", isCorrect:false}, {text:"runing", isCorrect:false}], rationale: "Run dobra o 'n' antes de -ing: running."},
                {q: "Complete: 'We ____ not listening to music.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"are", isCorrect:true}, {text:"do", isCorrect:false}], rationale: "We + are not (aren't)."},
                {q: "Qual é a forma -ing de 'make'?", options: [{text:"makeing", isCorrect:false}, {text:"makking", isCorrect:false}, {text:"making", isCorrect:true}, {text:"mading", isCorrect:false}], rationale: "Verbos terminados em 'e' perdem o 'e' e ganham -ing: making."},
                {q: "Escolha a tradução correta: 'Ele está cozinhando agora.'", options: [{text:"He cooks now", isCorrect:false}, {text:"He is cooking now", isCorrect:true}, {text:"He cooked now", isCorrect:false}, {text:"He cook now", isCorrect:false}], rationale: "Ação acontecendo agora = Present Continuous."},
                {q: "Complete: '____ she sleeping?'", options: [{text:"Are", isCorrect:false}, {text:"Is", isCorrect:true}, {text:"Am", isCorrect:false}, {text:"Do", isCorrect:false}], rationale: "She + Is na pergunta."},
                {q: "Qual palavra indica que devemos usar Present Continuous?", options: [{text:"yesterday", isCorrect:false}, {text:"always", isCorrect:false}, {text:"right now", isCorrect:true}, {text:"last week", isCorrect:false}], rationale: "'Right now' indica ação acontecendo neste momento."},
                {q: "Qual é a forma -ing de 'sit'?", options: [{text:"siting", isCorrect:false}, {text:"sitting", isCorrect:true}, {text:"sitin", isCorrect:false}, {text:"sitteing", isCorrect:false}], rationale: "Sit dobra o 't' antes de -ing: sitting."},
                {q: "Complete: 'I ____ writing a message to my friend.'", options: [{text:"is", isCorrect:false}, {text:"are", isCorrect:false}, {text:"am", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "I + am."},
                {q: "Escolha a frase INCORRETA:", options: [{text:"She is dancing", isCorrect:false}, {text:"They are singing", isCorrect:false}, {text:"He are playing", isCorrect:true}, {text:"I am reading", isCorrect:false}], rationale: "He + is, não 'are'. O correto seria 'He is playing'."}
            ],
            12: [ // Present Continuous For Future Situations (15 perguntas)
                {q: "Complete: 'I ____ meeting my friend tomorrow.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:true}, {text:"are", isCorrect:false}, {text:"will", isCorrect:false}], rationale: "I + am + verbo-ing para planos futuros."},
                {q: "Qual frase usa o Present Continuous para o futuro?", options: [{text:"I study every day", isCorrect:false}, {text:"I studied yesterday", isCorrect:false}, {text:"I am traveling next week", isCorrect:true}, {text:"I will study later", isCorrect:false}], rationale: "'am traveling next week' = plano futuro com Present Continuous."},
                {q: "Complete: 'She ____ leaving on Friday.'", options: [{text:"are", isCorrect:false}, {text:"is", isCorrect:true}, {text:"am", isCorrect:false}, {text:"do", isCorrect:false}], rationale: "She + is para planos já decididos."},
                {q: "Quando usamos Present Continuous para o futuro?", options: [{text:"Para previsões", isCorrect:false}, {text:"Para planos já organizados", isCorrect:true}, {text:"Para hábitos", isCorrect:false}, {text:"Para fatos científicos", isCorrect:false}], rationale: "Usamos para planos e compromissos já marcados."},
                {q: "Complete: 'We ____ having dinner with our parents tonight.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"are", isCorrect:true}, {text:"do", isCorrect:false}], rationale: "We + are para plano de hoje à noite."},
                {q: "Escolha a frase correta para um plano futuro:", options: [{text:"They flying to London next month", isCorrect:false}, {text:"They are flying to London next month", isCorrect:true}, {text:"They fly to London next month", isCorrect:false}, {text:"They is flying to London next month", isCorrect:false}], rationale: "They + are + verbo-ing + marcador de tempo futuro."},
                {q: "Qual marcador de tempo indica futuro?", options: [{text:"yesterday", isCorrect:false}, {text:"last week", isCorrect:false}, {text:"right now", isCorrect:false}, {text:"tomorrow", isCorrect:true}], rationale: "'Tomorrow' indica um plano para o dia seguinte."},
                {q: "Complete: '____ you coming to the party on Saturday?'", options: [{text:"Is", isCorrect:false}, {text:"Am", isCorrect:false}, {text:"Are", isCorrect:true}, {text:"Do", isCorrect:false}], rationale: "Are + you para perguntar sobre planos."},
                {q: "Escolha a tradução: 'Eu estou viajando na próxima semana.'", options: [{text:"I travel next week", isCorrect:false}, {text:"I am traveling next week", isCorrect:true}, {text:"I traveled next week", isCorrect:false}, {text:"I will traveling next week", isCorrect:false}], rationale: "Plano organizado = Present Continuous + marcador futuro."},
                {q: "Complete: 'He ____ starting a new job on Monday.'", options: [{text:"are", isCorrect:false}, {text:"am", isCorrect:false}, {text:"is", isCorrect:true}, {text:"do", isCorrect:false}], rationale: "He + is para plano confirmado."},
                {q: "Qual frase NÃO usa Present Continuous para o futuro?", options: [{text:"I am meeting her later", isCorrect:false}, {text:"She is cooking right now", isCorrect:true}, {text:"We are moving next month", isCorrect:false}, {text:"They are visiting us tomorrow", isCorrect:false}], rationale: "'Right now' indica presente, não futuro."},
                {q: "Complete a negativa: 'I ____ not working tomorrow.'", options: [{text:"is", isCorrect:false}, {text:"are", isCorrect:false}, {text:"am", isCorrect:true}, {text:"do", isCorrect:false}], rationale: "I + am not para negar plano futuro."},
                {q: "Escolha a frase correta:", options: [{text:"She is go to the dentist tomorrow", isCorrect:false}, {text:"She is going to the dentist tomorrow", isCorrect:true}, {text:"She going to the dentist tomorrow", isCorrect:false}, {text:"She are going to the dentist tomorrow", isCorrect:false}], rationale: "She + is + going (verbo-ing)."},
                {q: "Complete: 'What ____ you doing this weekend?'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"are", isCorrect:true}, {text:"do", isCorrect:false}], rationale: "What + are + you + doing para perguntar planos."},
                {q: "Escolha o melhor contexto para 'I am having lunch with Ana on Sunday':", options: [{text:"Uma previsão", isCorrect:false}, {text:"Um plano já combinado", isCorrect:true}, {text:"Um hábito diário", isCorrect:false}, {text:"Uma ação no passado", isCorrect:false}], rationale: "Present Continuous para futuro = plano já combinado."}
            ],
            13: [ // Many & Much (15 perguntas)
                {q: "Complete: 'How ____ water do you drink per day?'", options: [{text:"many", isCorrect:false}, {text:"much", isCorrect:true}, {text:"lot", isCorrect:false}, {text:"some", isCorrect:false}], rationale: "Water é incontável, então usamos 'much'."},
                {q: "Complete: 'How ____ books do you have?'", options: [{text:"much", isCorrect:false}, {text:"many", isCorrect:true}, {text:"lot", isCorrect:false}, {text:"any", isCorrect:false}], rationale: "Books é contável (plural), então usamos 'many'."},
                {q: "Qual substantivo é INCONTÁVEL?", options: [{text:"apple", isCorrect:false}, {text:"chair", isCorrect:false}, {text:"money", isCorrect:true}, {text:"dog", isCorrect:false}], rationale: "Money (dinheiro) é incontável em inglês."},
                {q: "Complete: 'There aren't ____ students in the class today.'", options: [{text:"much", isCorrect:false}, {text:"many", isCorrect:true}, {text:"a lot", isCorrect:false}, {text:"more", isCorrect:false}], rationale: "Students é contável, então usamos 'many'."},
                {q: "Complete: 'I don't have ____ time.'", options: [{text:"many", isCorrect:false}, {text:"much", isCorrect:true}, {text:"a lot", isCorrect:false}, {text:"few", isCorrect:false}], rationale: "Time é incontável, então usamos 'much'."},
                {q: "Escolha a frase correta:", options: [{text:"How much friends do you have?", isCorrect:false}, {text:"How many friends do you have?", isCorrect:true}, {text:"How lot friends do you have?", isCorrect:false}, {text:"How few friends do you have?", isCorrect:false}], rationale: "Friends é contável = many."},
                {q: "Qual substantivo é CONTÁVEL?", options: [{text:"rice", isCorrect:false}, {text:"sugar", isCorrect:false}, {text:"milk", isCorrect:false}, {text:"egg", isCorrect:true}], rationale: "Egg (ovo) é contável: one egg, two eggs."},
                {q: "Complete: 'There isn't ____ sugar in my coffee.'", options: [{text:"many", isCorrect:false}, {text:"much", isCorrect:true}, {text:"few", isCorrect:false}, {text:"several", isCorrect:false}], rationale: "Sugar é incontável = much."},
                {q: "Complete: 'She has ____ cats at home.'", options: [{text:"much", isCorrect:false}, {text:"many", isCorrect:true}, {text:"a much", isCorrect:false}, {text:"lot", isCorrect:false}], rationale: "Cats é contável = many."},
                {q: "Qual alternativa pode substituir 'many' e 'much' em frases afirmativas?", options: [{text:"few", isCorrect:false}, {text:"little", isCorrect:false}, {text:"a lot of", isCorrect:true}, {text:"some of", isCorrect:false}], rationale: "'A lot of' funciona com contáveis e incontáveis."},
                {q: "Complete: 'Do you eat ____ fruit?'", options: [{text:"many", isCorrect:false}, {text:"much", isCorrect:true}, {text:"few", isCorrect:false}, {text:"several", isCorrect:false}], rationale: "Fruit (fruta em geral) é incontável = much."},
                {q: "Complete: 'How ____ languages do you speak?'", options: [{text:"much", isCorrect:false}, {text:"many", isCorrect:true}, {text:"lot", isCorrect:false}, {text:"any", isCorrect:false}], rationale: "Languages é contável = many."},
                {q: "Escolha a frase INCORRETA:", options: [{text:"I don't have much money", isCorrect:false}, {text:"There are many people here", isCorrect:false}, {text:"How much chairs are there?", isCorrect:true}, {text:"She doesn't drink much coffee", isCorrect:false}], rationale: "Chairs é contável, deveria ser 'How many chairs'."},
                {q: "Complete: 'We don't have ____ homework today.'", options: [{text:"many", isCorrect:false}, {text:"much", isCorrect:true}, {text:"few", isCorrect:false}, {text:"several", isCorrect:false}], rationale: "Homework é incontável = much."},
                {q: "Qual regra é correta?", options: [{text:"Much para contáveis, Many para incontáveis", isCorrect:false}, {text:"Many para contáveis, Much para incontáveis", isCorrect:true}, {text:"Many e Much são a mesma coisa", isCorrect:false}, {text:"Much é só para perguntas", isCorrect:false}], rationale: "Many = contáveis (plural). Much = incontáveis."}
            ],
            2: [ // Frequency - Adverbs of Frequency & How often (15 perguntas)
                {q: "Complete: 'I ____ go to the gym. I go every day.'", options: [{text:"always", isCorrect:true}, {text:"never", isCorrect:false}, {text:"rarely", isCorrect:false}, {text:"sometimes", isCorrect:false}], rationale: "'Every day' indica 100% de frequência = always."},
                {q: "Qual advérbio de frequência indica 0%?", options: [{text:"always", isCorrect:false}, {text:"usually", isCorrect:false}, {text:"sometimes", isCorrect:false}, {text:"never", isCorrect:true}], rationale: "Never = nunca = 0% de frequência."},
                {q: "Complete: 'How ____ do you study English?'", options: [{text:"many", isCorrect:false}, {text:"much", isCorrect:false}, {text:"often", isCorrect:true}, {text:"long", isCorrect:false}], rationale: "'How often' é usado para perguntar sobre frequência."},
                {q: "Onde fica o advérbio de frequência na frase?", options: [{text:"Depois do verbo principal", isCorrect:false}, {text:"Antes do verbo principal", isCorrect:true}, {text:"No final da frase", isCorrect:false}, {text:"No início da frase sempre", isCorrect:false}], rationale: "Advérbios de frequência vêm antes do verbo principal: 'I always study'."},
                {q: "Complete: 'She ____ eats breakfast. She prefers just coffee.'", options: [{text:"always", isCorrect:false}, {text:"usually", isCorrect:false}, {text:"rarely", isCorrect:true}, {text:"often", isCorrect:false}], rationale: "Rarely = raramente. Ela quase nunca come café da manhã."},
                {q: "Responda: 'How often do you go to the beach?' - 'I go ____.'", options: [{text:"twice a month", isCorrect:true}, {text:"at 3 o'clock", isCorrect:false}, {text:"with my friends", isCorrect:false}, {text:"to Copacabana", isCorrect:false}], rationale: "'How often' pergunta frequência, a resposta deve indicar frequência."},
                {q: "Escolha a frase correta:", options: [{text:"I go always to school", isCorrect:false}, {text:"I always go to school", isCorrect:true}, {text:"Always I go to school", isCorrect:false}, {text:"I go to always school", isCorrect:false}], rationale: "Advérbio de frequência vem antes do verbo principal: 'always go'."},
                {q: "Qual é a ordem correta de frequência (do maior para o menor)?", options: [{text:"always > usually > sometimes > never", isCorrect:true}, {text:"never > sometimes > usually > always", isCorrect:false}, {text:"usually > always > sometimes > never", isCorrect:false}, {text:"sometimes > usually > always > never", isCorrect:false}], rationale: "Always (100%) > Usually (80%) > Sometimes (50%) > Never (0%)."},
                {q: "Complete: 'He is ____ late for class. The teacher is angry.'", options: [{text:"never", isCorrect:false}, {text:"rarely", isCorrect:false}, {text:"always", isCorrect:true}, {text:"sometimes", isCorrect:false}], rationale: "O professor está bravo porque ele está SEMPRE atrasado."},
                {q: "Com o verbo 'to be', onde fica o advérbio?", options: [{text:"Antes do verbo to be", isCorrect:false}, {text:"Depois do verbo to be", isCorrect:true}, {text:"No final da frase", isCorrect:false}, {text:"Antes do sujeito", isCorrect:false}], rationale: "Com 'to be', o advérbio vem DEPOIS: 'She is always happy'."},
                {q: "Complete: 'How often does he exercise?' - 'He ____ exercises.'", options: [{text:"three times a week", isCorrect:false}, {text:"never", isCorrect:true}, {text:"on Monday", isCorrect:false}, {text:"at the gym", isCorrect:false}], rationale: "A resposta com advérbio de frequência antes do verbo: 'He never exercises'."},
                {q: "Escolha a tradução correta de 'Com que frequência você viaja?'", options: [{text:"How much do you travel?", isCorrect:false}, {text:"How often do you travel?", isCorrect:true}, {text:"How many do you travel?", isCorrect:false}, {text:"How long do you travel?", isCorrect:false}], rationale: "'Com que frequência' = 'How often'."},
                {q: "Complete: 'They ____ watch TV at night. Maybe 2 or 3 times a week.'", options: [{text:"always", isCorrect:false}, {text:"never", isCorrect:false}, {text:"sometimes", isCorrect:true}, {text:"rarely", isCorrect:false}], rationale: "2-3 vezes por semana = às vezes = sometimes."},
                {q: "Escolha a frase INCORRETA:", options: [{text:"She usually drinks tea", isCorrect:false}, {text:"I never eat meat", isCorrect:false}, {text:"He often is tired", isCorrect:true}, {text:"We sometimes go to the park", isCorrect:false}], rationale: "Com 'to be', o advérbio vem depois: 'He is often tired', não 'He often is tired'."},
                {q: "Complete: 'How often do you cook?' - '____.'", options: [{text:"I cook pasta", isCorrect:false}, {text:"In the kitchen", isCorrect:false}, {text:"Every day", isCorrect:true}, {text:"With my mom", isCorrect:false}], rationale: "'How often' pede resposta de frequência: 'Every day' (todo dia)."}
            ],
            6: [ // Prepositions Of Place (15 perguntas)
                {q: "Complete: 'The cat is ____ the table.'", options: [{text:"on", isCorrect:true}, {text:"at", isCorrect:false}, {text:"to", isCorrect:false}, {text:"of", isCorrect:false}], rationale: "On = em cima de. O gato está em cima da mesa."},
                {q: "Complete: 'The ball is ____ the box.'", options: [{text:"on", isCorrect:false}, {text:"in", isCorrect:true}, {text:"at", isCorrect:false}, {text:"to", isCorrect:false}], rationale: "In = dentro de. A bola está dentro da caixa."},
                {q: "Complete: 'She is standing ____ the door.'", options: [{text:"in front of", isCorrect:true}, {text:"in", isCorrect:false}, {text:"on", isCorrect:false}, {text:"below", isCorrect:false}], rationale: "In front of = na frente de."},
                {q: "Complete: 'The bank is ____ the supermarket and the pharmacy.'", options: [{text:"next to", isCorrect:false}, {text:"between", isCorrect:true}, {text:"behind", isCorrect:false}, {text:"under", isCorrect:false}], rationale: "Between = entre dois lugares."},
                {q: "Complete: 'The dog is ____ the chair.'", options: [{text:"under", isCorrect:true}, {text:"on", isCorrect:false}, {text:"in", isCorrect:false}, {text:"between", isCorrect:false}], rationale: "Under = embaixo de."},
                {q: "Complete: 'The school is ____ the hospital.'", options: [{text:"next to", isCorrect:true}, {text:"in", isCorrect:false}, {text:"under", isCorrect:false}, {text:"on", isCorrect:false}], rationale: "Next to = ao lado de."},
                {q: "Complete: 'The garden is ____ the house.'", options: [{text:"behind", isCorrect:true}, {text:"on", isCorrect:false}, {text:"in", isCorrect:false}, {text:"between", isCorrect:false}], rationale: "Behind = atrás de."},
                {q: "Qual preposição significa 'em cima de'?", options: [{text:"in", isCorrect:false}, {text:"under", isCorrect:false}, {text:"on", isCorrect:true}, {text:"behind", isCorrect:false}], rationale: "On = em cima de / sobre."},
                {q: "Complete: 'The lamp is ____ the desk.'", options: [{text:"above", isCorrect:true}, {text:"under", isCorrect:false}, {text:"behind", isCorrect:false}, {text:"between", isCorrect:false}], rationale: "Above = acima de (sem tocar)."},
                {q: "Complete: 'There is a mirror ____ the wall.'", options: [{text:"on", isCorrect:true}, {text:"in", isCorrect:false}, {text:"under", isCorrect:false}, {text:"next to", isCorrect:false}], rationale: "On the wall = na parede (preso à superfície)."},
                {q: "Complete: 'The park is ____ the library.'", options: [{text:"opposite", isCorrect:true}, {text:"under", isCorrect:false}, {text:"in", isCorrect:false}, {text:"on", isCorrect:false}], rationale: "Opposite = em frente / do lado oposto."},
                {q: "Escolha a frase correta:", options: [{text:"The book is in the shelf", isCorrect:false}, {text:"The book is on the shelf", isCorrect:true}, {text:"The book is at the shelf", isCorrect:false}, {text:"The book is to the shelf", isCorrect:false}], rationale: "On the shelf = na prateleira (em cima da superfície)."},
                {q: "Complete: 'The shoes are ____ the bed.'", options: [{text:"on", isCorrect:false}, {text:"under", isCorrect:true}, {text:"above", isCorrect:false}, {text:"in front of", isCorrect:false}], rationale: "Under the bed = embaixo da cama."},
                {q: "Qual é a tradução de 'between'?", options: [{text:"atrás de", isCorrect:false}, {text:"em cima de", isCorrect:false}, {text:"entre", isCorrect:true}, {text:"ao lado de", isCorrect:false}], rationale: "Between = entre (dois elementos)."},
                {q: "Escolha a frase INCORRETA:", options: [{text:"The cat is under the table", isCorrect:false}, {text:"The picture is on the wall", isCorrect:false}, {text:"She is in front of the school", isCorrect:false}, {text:"The book is between the shelf", isCorrect:true}], rationale: "Between precisa de dois elementos: 'between A and B'. A frase correta seria 'on the shelf'."}
            ],
            7: [ // In, On, At + Transportations (15 perguntas)
                {q: "Complete: 'I go to work ____ bus.'", options: [{text:"by", isCorrect:true}, {text:"in", isCorrect:false}, {text:"on", isCorrect:false}, {text:"at", isCorrect:false}], rationale: "By + transporte (sem artigo) = meio de transporte: by bus."},
                {q: "Complete: 'She is ____ the car.'", options: [{text:"in", isCorrect:true}, {text:"on", isCorrect:false}, {text:"at", isCorrect:false}, {text:"by", isCorrect:false}], rationale: "In the car = dentro do carro (espaço fechado e pequeno)."},
                {q: "Complete: 'They are ____ the bus.'", options: [{text:"on", isCorrect:true}, {text:"in", isCorrect:false}, {text:"at", isCorrect:false}, {text:"by", isCorrect:false}], rationale: "On the bus = no ônibus (transporte grande onde você fica de pé/sentado)."},
                {q: "Complete: 'He goes to school ____ foot.'", options: [{text:"on", isCorrect:true}, {text:"by", isCorrect:false}, {text:"in", isCorrect:false}, {text:"at", isCorrect:false}], rationale: "On foot = a pé (expressão fixa)."},
                {q: "Quando usamos 'in' com transporte?", options: [{text:"Com transportes grandes como ônibus e avião", isCorrect:false}, {text:"Com transportes pequenos como carro e táxi", isCorrect:true}, {text:"Quando estamos na parada de ônibus", isCorrect:false}, {text:"Nunca usamos 'in' com transporte", isCorrect:false}], rationale: "In = transportes pequenos e fechados: in the car, in the taxi."},
                {q: "Complete: 'We traveled ____ plane.'", options: [{text:"by", isCorrect:true}, {text:"in", isCorrect:false}, {text:"on", isCorrect:false}, {text:"at", isCorrect:false}], rationale: "By plane = de avião (meio de transporte geral)."},
                {q: "Complete: 'She is ____ the train.'", options: [{text:"on", isCorrect:true}, {text:"in", isCorrect:false}, {text:"at", isCorrect:false}, {text:"by", isCorrect:false}], rationale: "On the train = no trem (transporte grande)."},
                {q: "Escolha a frase correta:", options: [{text:"I am on the taxi", isCorrect:false}, {text:"I am in the taxi", isCorrect:true}, {text:"I am at the taxi", isCorrect:false}, {text:"I am by the taxi", isCorrect:false}], rationale: "In the taxi = no táxi (veículo pequeno e fechado)."},
                {q: "Complete: 'He arrived ____ the bus stop.'", options: [{text:"at", isCorrect:true}, {text:"in", isCorrect:false}, {text:"on", isCorrect:false}, {text:"by", isCorrect:false}], rationale: "At the bus stop = no ponto de ônibus (local específico)."},
                {q: "Quando usamos 'on' com transporte?", options: [{text:"Com carro e táxi", isCorrect:false}, {text:"Com ônibus, trem, avião e bicicleta", isCorrect:true}, {text:"Apenas com bicicleta", isCorrect:false}, {text:"Nunca usamos 'on' com transporte", isCorrect:false}], rationale: "On = transportes grandes ou abertos: on the bus, on the plane, on a bike."},
                {q: "Complete: 'She goes to work ____ bicycle.'", options: [{text:"by", isCorrect:true}, {text:"in", isCorrect:false}, {text:"at", isCorrect:false}, {text:"on", isCorrect:false}], rationale: "By bicycle = de bicicleta (meio de transporte sem artigo)."},
                {q: "Complete: 'I was ____ the airplane when it started to rain.'", options: [{text:"on", isCorrect:true}, {text:"in", isCorrect:false}, {text:"at", isCorrect:false}, {text:"by", isCorrect:false}], rationale: "On the airplane = dentro do avião (transporte grande)."},
                {q: "Escolha a frase INCORRETA:", options: [{text:"She goes by car", isCorrect:false}, {text:"He is in the bus", isCorrect:true}, {text:"They are on the train", isCorrect:false}, {text:"I arrived at the station", isCorrect:false}], rationale: "O correto é 'on the bus' (transporte grande), não 'in the bus'."},
                {q: "Complete: 'He is waiting ____ the airport.'", options: [{text:"at", isCorrect:true}, {text:"on", isCorrect:false}, {text:"in", isCorrect:false}, {text:"by", isCorrect:false}], rationale: "At the airport = no aeroporto (local/ponto específico)."},
                {q: "Qual alternativa usa 'in' corretamente?", options: [{text:"She is in the motorcycle", isCorrect:false}, {text:"He is in the car", isCorrect:true}, {text:"They are in the bus", isCorrect:false}, {text:"We are in the bicycle", isCorrect:false}], rationale: "In the car = correto. Carro é veículo pequeno e fechado."}
            ],
            8: [ // Possessives - Genitive Case, Possessive Pronouns & Adjectives (15 perguntas)
                {q: "Complete: 'This is ____  book.' (dela)", options: [{text:"she", isCorrect:false}, {text:"her", isCorrect:true}, {text:"hers", isCorrect:false}, {text:"she's", isCorrect:false}], rationale: "Her = adjetivo possessivo (antes do substantivo): her book."},
                {q: "Complete: 'The car is ____.' (deles)", options: [{text:"they", isCorrect:false}, {text:"their", isCorrect:false}, {text:"theirs", isCorrect:true}, {text:"them", isCorrect:false}], rationale: "Theirs = pronome possessivo (sem substantivo depois): The car is theirs."},
                {q: "Complete: 'This is ____ house.' (de João)", options: [{text:"João", isCorrect:false}, {text:"João's", isCorrect:true}, {text:"Joãos", isCorrect:false}, {text:"of João", isCorrect:false}], rationale: "Genitive case: nome + 's = João's house."},
                {q: "Qual é o adjetivo possessivo de 'I'?", options: [{text:"me", isCorrect:false}, {text:"mine", isCorrect:false}, {text:"my", isCorrect:true}, {text:"I's", isCorrect:false}], rationale: "I = my (adjetivo possessivo): my book, my car."},
                {q: "Complete: 'That phone is ____.' (meu)", options: [{text:"my", isCorrect:false}, {text:"me", isCorrect:false}, {text:"I", isCorrect:false}, {text:"mine", isCorrect:true}], rationale: "Mine = pronome possessivo (substitui my + substantivo): It's mine."},
                {q: "Complete: '____ dog is very friendly.' (deles)", options: [{text:"Theirs", isCorrect:false}, {text:"They", isCorrect:false}, {text:"Their", isCorrect:true}, {text:"Them", isCorrect:false}], rationale: "Their = adjetivo possessivo (antes do substantivo): their dog."},
                {q: "Complete: 'This is my ____ room.' (do irmão)", options: [{text:"brother", isCorrect:false}, {text:"brother's", isCorrect:true}, {text:"brothers", isCorrect:false}, {text:"of brother", isCorrect:false}], rationale: "Genitive case com 's: my brother's room."},
                {q: "Qual é a diferença entre 'your' e 'yours'?", options: [{text:"São iguais", isCorrect:false}, {text:"Your vem antes do substantivo, yours vem sozinho", isCorrect:true}, {text:"Yours vem antes do substantivo", isCorrect:false}, {text:"Your é mais formal", isCorrect:false}], rationale: "Your = adjetivo (your car). Yours = pronome (it's yours)."},
                {q: "Complete: 'Are these shoes ____?' (dele)", options: [{text:"he", isCorrect:false}, {text:"him", isCorrect:false}, {text:"his", isCorrect:true}, {text:"he's", isCorrect:false}], rationale: "His = pronome possessivo e adjetivo possessivo (mesma forma): his shoes / they're his."},
                {q: "Escolha a frase correta:", options: [{text:"The children's toys are new", isCorrect:true}, {text:"The childrens toys are new", isCorrect:false}, {text:"The childrens' toys are new", isCorrect:false}, {text:"The children toys are new", isCorrect:false}], rationale: "Plural irregular: children + 's = children's toys."},
                {q: "Complete: '____ name is Maria.' (dela)", options: [{text:"She", isCorrect:false}, {text:"Hers", isCorrect:false}, {text:"Her", isCorrect:true}, {text:"She's", isCorrect:false}], rationale: "Her = adjetivo possessivo antes do substantivo: Her name."},
                {q: "Complete: 'Is this bag ____?' (sua/tua)", options: [{text:"your", isCorrect:false}, {text:"yours", isCorrect:true}, {text:"you", isCorrect:false}, {text:"you're", isCorrect:false}], rationale: "Yours = pronome possessivo (sem substantivo depois)."},
                {q: "Complete: 'My ____ car is red.' (do pai)", options: [{text:"father", isCorrect:false}, {text:"fathers", isCorrect:false}, {text:"father's", isCorrect:true}, {text:"of father", isCorrect:false}], rationale: "Genitive case: father's car = o carro do pai."},
                {q: "Qual é o pronome possessivo de 'we'?", options: [{text:"our", isCorrect:false}, {text:"us", isCorrect:false}, {text:"ours", isCorrect:true}, {text:"we's", isCorrect:false}], rationale: "We = our (adjetivo) / ours (pronome): our house / it's ours."},
                {q: "Escolha a frase INCORRETA:", options: [{text:"This is her bag", isCorrect:false}, {text:"The bag is hers", isCorrect:false}, {text:"This is the teacher's desk", isCorrect:false}, {text:"This is mine book", isCorrect:true}], rationale: "Mine é pronome, não adjetivo. O correto seria 'This is my book' ou 'This book is mine'."}
            ],
            17: [ // Future Simple (15 perguntas)
                {q: "Complete: 'I ____ help you tomorrow.'", options: [{text:"will", isCorrect:true}, {text:"am", isCorrect:false}, {text:"do", isCorrect:false}, {text:"was", isCorrect:false}], rationale: "Futuro simples: will + verbo base."},
                {q: "Escolha a forma negativa correta:", options: [{text:"I willn't go", isCorrect:false}, {text:"I won't go", isCorrect:true}, {text:"I don't will go", isCorrect:false}, {text:"I not will go", isCorrect:false}], rationale: "Negativa do will: won't (will not)."},
                {q: "Complete: 'She ____ be a great doctor one day.'", options: [{text:"will", isCorrect:true}, {text:"is", isCorrect:false}, {text:"was", isCorrect:false}, {text:"does", isCorrect:false}], rationale: "Previsão sobre o futuro = will + verbo base."},
                {q: "Qual frase está no Future Simple?", options: [{text:"I am studying now", isCorrect:false}, {text:"I studied yesterday", isCorrect:false}, {text:"I will study later", isCorrect:true}, {text:"I study every day", isCorrect:false}], rationale: "'will study' = futuro simples."},
                {q: "Complete a pergunta: '____ you come to the party?'", options: [{text:"Do", isCorrect:false}, {text:"Are", isCorrect:false}, {text:"Will", isCorrect:true}, {text:"Did", isCorrect:false}], rationale: "Pergunta no futuro: Will + sujeito + verbo base?"},
                {q: "Quando usamos 'will' para decisões?", options: [{text:"Para planos antigos", isCorrect:false}, {text:"Para decisões tomadas no momento", isCorrect:true}, {text:"Para hábitos", isCorrect:false}, {text:"Para o passado", isCorrect:false}], rationale: "Will é usado para decisões espontâneas."},
                {q: "Complete: 'It ____ rain tomorrow.'", options: [{text:"will", isCorrect:true}, {text:"is", isCorrect:false}, {text:"does", isCorrect:false}, {text:"did", isCorrect:false}], rationale: "Previsão do tempo = will + verbo base."},
                {q: "Escolha a tradução: 'Eu não irei ao cinema.'", options: [{text:"I don't go to the cinema", isCorrect:false}, {text:"I won't go to the cinema", isCorrect:true}, {text:"I am not going to the cinema", isCorrect:false}, {text:"I didn't go to the cinema", isCorrect:false}], rationale: "Negativa no futuro simples: won't + verbo base."},
                {q: "Complete: 'They ____ arrive at 8 o'clock.'", options: [{text:"will", isCorrect:true}, {text:"are", isCorrect:false}, {text:"does", isCorrect:false}, {text:"has", isCorrect:false}], rationale: "They + will + verbo base."},
                {q: "Qual é a forma contraída de 'will not'?", options: [{text:"willn't", isCorrect:false}, {text:"won't", isCorrect:true}, {text:"wouldn't", isCorrect:false}, {text:"wont", isCorrect:false}], rationale: "Will not = won't."},
                {q: "Complete: 'I think it ____ be sunny this weekend.'", options: [{text:"will", isCorrect:true}, {text:"is", isCorrect:false}, {text:"was", isCorrect:false}, {text:"does", isCorrect:false}], rationale: "'I think' + will = opinião sobre o futuro."},
                {q: "Escolha a frase correta:", options: [{text:"She will goes to school", isCorrect:false}, {text:"She will go to school", isCorrect:true}, {text:"She will going to school", isCorrect:false}, {text:"She will went to school", isCorrect:false}], rationale: "Will + verbo na forma base (sem -s, -ing ou -ed)."},
                {q: "Complete: '____ it be expensive?'", options: [{text:"Does", isCorrect:false}, {text:"Is", isCorrect:false}, {text:"Will", isCorrect:true}, {text:"Did", isCorrect:false}], rationale: "Pergunta no futuro: Will + sujeito + verbo base?"},
                {q: "Qual palavra costuma acompanhar o Future Simple?", options: [{text:"yesterday", isCorrect:false}, {text:"now", isCorrect:false}, {text:"tomorrow", isCorrect:true}, {text:"ago", isCorrect:false}], rationale: "'Tomorrow' indica tempo futuro."},
                {q: "Escolha a frase INCORRETA:", options: [{text:"I will call you later", isCorrect:false}, {text:"She will helps us", isCorrect:true}, {text:"They won't come", isCorrect:false}, {text:"Will he be there?", isCorrect:false}], rationale: "Após 'will', o verbo fica na forma base: 'help', não 'helps'."}
            ],
            4: [ // Why & Because (15 perguntas)
                {q: "Complete: '____ are you happy?' - 'Because I passed my test!'", options: [{text:"Why", isCorrect:true}, {text:"Because", isCorrect:false}, {text:"What", isCorrect:false}, {text:"How", isCorrect:false}], rationale: "'Why' é usado para fazer perguntas sobre motivo/razão."},
                {q: "Complete: '____ do you study English?' - 'Because I want to travel.'", options: [{text:"Why", isCorrect:true}, {text:"Because", isCorrect:false}, {text:"Where", isCorrect:false}, {text:"When", isCorrect:false}], rationale: "'Why' pergunta o motivo; 'Because' responde."},
                {q: "Complete: 'I like pizza ____ it's delicious.'", options: [{text:"why", isCorrect:false}, {text:"because", isCorrect:true}, {text:"but", isCorrect:false}, {text:"so", isCorrect:false}], rationale: "'Because' introduz a razão/explicação."},
                {q: "Complete: 'She is tired ____ she worked all day.'", options: [{text:"why", isCorrect:false}, {text:"because", isCorrect:true}, {text:"and", isCorrect:false}, {text:"but", isCorrect:false}], rationale: "'Because' explica o motivo de ela estar cansada."},
                {q: "Qual é a tradução de 'Why'?", options: [{text:"Quando", isCorrect:false}, {text:"Onde", isCorrect:false}, {text:"Por quê", isCorrect:true}, {text:"Como", isCorrect:false}], rationale: "Why = Por quê (para perguntar razão/motivo)."},
                {q: "Qual é a tradução de 'Because'?", options: [{text:"Mas", isCorrect:false}, {text:"Então", isCorrect:false}, {text:"Porque", isCorrect:true}, {text:"Quando", isCorrect:false}], rationale: "Because = Porque (para dar a razão/resposta)."},
                {q: "Complete: 'Why do you like soccer?' - '____ it's fun and exciting.'", options: [{text:"Why", isCorrect:false}, {text:"Because", isCorrect:true}, {text:"But", isCorrect:false}, {text:"And", isCorrect:false}], rationale: "A resposta a 'Why' começa com 'Because'."},
                {q: "Escolha a opinião correta usando 'because':", options: [{text:"I think dogs are great because they are loyal", isCorrect:true}, {text:"I think dogs are great why they are loyal", isCorrect:false}, {text:"I think dogs are great so they are loyal", isCorrect:false}, {text:"I think dogs are great and why loyal", isCorrect:false}], rationale: "Para justificar uma opinião usamos 'because' + razão."},
                {q: "Complete: 'Why is she crying?' - 'Because she ____ her phone.'", options: [{text:"lost", isCorrect:true}, {text:"lose", isCorrect:false}, {text:"losing", isCorrect:false}, {text:"loses", isCorrect:false}], rationale: "'Because she lost her phone' = Porque ela perdeu o celular."},
                {q: "Escolha a frase correta para dar uma opinião:", options: [{text:"I like summer why it's warm", isCorrect:false}, {text:"I like summer because it's warm", isCorrect:true}, {text:"I like summer because warm", isCorrect:false}, {text:"I like summer so because warm", isCorrect:false}], rationale: "Estrutura: opinião + because + frase completa com razão."},
                {q: "Complete: 'Why don't you eat meat?' - 'Because I ____ a vegetarian.'", options: [{text:"am", isCorrect:true}, {text:"is", isCorrect:false}, {text:"are", isCorrect:false}, {text:"be", isCorrect:false}], rationale: "I + am. 'Because I am a vegetarian.'"},
                {q: "Qual frase expressa uma opinião com justificativa?", options: [{text:"I think chocolate is the best", isCorrect:false}, {text:"I think chocolate is the best because it makes me happy", isCorrect:true}, {text:"Why chocolate is the best", isCorrect:false}, {text:"Chocolate because best", isCorrect:false}], rationale: "Opinião completa: 'I think... because...' com justificativa."},
                {q: "Complete: 'Why ____ he late every day?'", options: [{text:"is", isCorrect:true}, {text:"do", isCorrect:false}, {text:"does", isCorrect:false}, {text:"are", isCorrect:false}], rationale: "Why + is + he (com verbo to be na pergunta)."},
                {q: "Complete: 'I don't like horror movies ____ they are scary.'", options: [{text:"why", isCorrect:false}, {text:"because", isCorrect:true}, {text:"but", isCorrect:false}, {text:"when", isCorrect:false}], rationale: "'Because they are scary' = porque são assustadores."},
                {q: "Escolha a resposta correta para: 'Why do you wake up early?'", options: [{text:"Because I go to school at 7", isCorrect:true}, {text:"Why I go to school at 7", isCorrect:false}, {text:"I wake up early and school", isCorrect:false}, {text:"Because early school why", isCorrect:false}], rationale: "Resposta com 'Because' + frase completa explicando o motivo."}
            ]
        };

        function getActiveAulas() {
            return currentLevel === 'starter2' ? aulaStarter2 : aulaNames;
        }

        function getActiveQuizData() {
            return currentLevel === 'starter2' ? quizDataStarter2 : quizData;
        }

        function getLevelTag() {
            return currentLevel === 'starter2' ? 'STARTER 2' : 'STARTER 1';
        }

        const aulaNames = [
            { id: 1, name: "Open House", hasHomework: false, desc: "Aula introdutória do curso." },
            { id: 2, name: "Feelings", hasHomework: true, specialMode: 'flashcards', desc: "Pratique vocabulário de sentimentos e emoções." },
            { id: 3, name: "Names & Greetings", hasHomework: true, specialMode: 'chunks', desc: "Treine apresentações e cumprimentos em inglês." },
            { id: 4, name: "Numbers pt. 1", hasHomework: true, specialMode: 'listening', thirdBtn: 'dictation', desc: "Pratique os números de 1 a 99.", items: [
                {n: "1", w: "One"}, {n: "2", w: "Two"}, {n: "3", w: "Three"}, {n: "4", w: "Four"}, {n: "5", w: "Five"},
                {n: "6", w: "Six"}, {n: "7", w: "Seven"}, {n: "8", w: "Eight"}, {n: "9", w: "Nine"}, {n: "10", w: "Ten"},
                {n: "11", w: "Eleven"}, {n: "12", w: "Twelve"}, {n: "13", w: "Thirteen"}, {n: "14", w: "Fourteen"}, {n: "15", w: "Fifteen"},
                {n: "16", w: "Sixteen"}, {n: "17", w: "Seventeen"}, {n: "18", w: "Eighteen"}, {n: "19", w: "Nineteen"}, {n: "20", w: "Twenty"},
                {n: "21", w: "Twenty-one"}, {n: "23", w: "Twenty-three"}, {n: "25", w: "Twenty-five"}, {n: "27", w: "Twenty-seven"}, {n: "29", w: "Twenty-nine"},
                {n: "30", w: "Thirty"}, {n: "32", w: "Thirty-two"}, {n: "34", w: "Thirty-four"}, {n: "36", w: "Thirty-six"}, {n: "38", w: "Thirty-eight"},
                {n: "40", w: "Forty"}, {n: "41", w: "Forty-one"}, {n: "43", w: "Forty-three"}, {n: "45", w: "Forty-five"}, {n: "47", w: "Forty-seven"},
                {n: "50", w: "Fifty"}, {n: "52", w: "Fifty-two"}, {n: "54", w: "Fifty-four"}, {n: "56", w: "Fifty-six"}, {n: "58", w: "Fifty-eight"},
                {n: "60", w: "Sixty"}, {n: "62", w: "Sixty-two"}, {n: "65", w: "Sixty-five"}, {n: "67", w: "Sixty-seven"}, {n: "69", w: "Sixty-nine"},
                {n: "70", w: "Seventy"}, {n: "71", w: "Seventy-one"}, {n: "73", w: "Seventy-three"}, {n: "75", w: "Seventy-five"}, {n: "78", w: "Seventy-eight"},
                {n: "80", w: "Eighty"}, {n: "82", w: "Eighty-two"}, {n: "84", w: "Eighty-four"}, {n: "87", w: "Eighty-seven"}, {n: "89", w: "Eighty-nine"},
                {n: "90", w: "Ninety"}, {n: "91", w: "Ninety-one"}, {n: "93", w: "Ninety-three"}, {n: "96", w: "Ninety-six"}, {n: "99", w: "Ninety-nine"}
            ]},
            { id: 5, name: "Numbers pt. 2", hasHomework: true, specialMode: 'listening', thirdBtn: 'dictation', desc: "Pratique números grandes: centenas, milhares e além.", items: [
                {n: "100", w: "One hundred"}, {n: "150", w: "One hundred and fifty"}, {n: "200", w: "Two hundred"}, {n: "300", w: "Three hundred"}, {n: "325", w: "Three hundred and twenty-five"}, {n: "400", w: "Four hundred"}, {n: "500", w: "Five hundred"}, {n: "505", w: "Five hundred and five"}, {n: "600", w: "Six hundred"}, {n: "700", w: "Seven hundred"}, {n: "800", w: "Eight hundred"}, {n: "900", w: "Nine hundred"}, {n: "1,000", w: "One thousand"}, {n: "1,200", w: "One thousand two hundred"}, {n: "2,000", w: "Two thousand"}, {n: "4,000", w: "Four thousand"}, {n: "5,500", w: "Five thousand five hundred"}, {n: "10,000", w: "Ten thousand"}, {n: "10,500", w: "Ten thousand five hundred"}, {n: "20,000", w: "Twenty thousand"}, {n: "30,000", w: "Thirty thousand"}, {n: "40,000", w: "Forty thousand"}, {n: "45,300", w: "Forty-five thousand three hundred"}, {n: "50,000", w: "Fifty thousand"}, {n: "60,000", w: "Sixty thousand"}, {n: "70,000", w: "Seventy thousand"}, {n: "80,000", w: "Eighty thousand"}, {n: "90,000", w: "Ninety thousand"}, {n: "100,000", w: "One hundred thousand"}, {n: "250,000", w: "Two hundred and fifty thousand"}, {n: "500,000", w: "Five hundred thousand"}, {n: "750,000", w: "Seven hundred and fifty thousand"}, {n: "3,000", w: "Three thousand"}, {n: "7,500", w: "Seven thousand five hundred"}, {n: "15,000", w: "Fifteen thousand"}, {n: "25,000", w: "Twenty-five thousand"}, {n: "99,000", w: "Ninety-nine thousand"}, {n: "120,000", w: "One hundred and twenty thousand"}
            ]},
            { id: 6, name: "Spelling", hasHomework: true, specialMode: 'listening', thirdBtn: 'dictation', desc: "Aprenda a soletrar e pronunciar as letras do alfabeto.", items: [
                {n: "A", w: "ay", p: "/eɪ/"}, {n: "B", w: "bee", p: "/biː/"}, {n: "C", w: "cee", p: "/siː/"}, {n: "D", w: "dee", p: "/diː/"},
                {n: "E", w: "ee", p: "/iː/"}, {n: "F", w: "ef", p: "/ɛf/"}, {n: "G", w: "gee", p: "/dʒiː/"}, {n: "H", w: "aitch", p: "/eɪtʃ/"},
                {n: "I", w: "eye", p: "/aɪ/"}, {n: "J", w: "jay", p: "/dʒeɪ/"}, {n: "K", w: "kay", p: "/keɪ/"}, {n: "L", w: "el", p: "/ɛl/"},
                {n: "M", w: "em", p: "/ɛm/"}, {n: "N", w: "en", p: "/ɛn/"}, {n: "O", w: "oh", p: "/oʊ/"}, {n: "P", w: "pee", p: "/piː/"},
                {n: "Q", w: "cue", p: "/kjuː/"}, {n: "R", w: "ar", p: "/ɑːr/"}, {n: "S", w: "ess", p: "/ɛs/"}, {n: "T", w: "tee", p: "/tiː/"},
                {n: "U", w: "you", p: "/juː/"}, {n: "V", w: "vee", p: "/viː/"}, {n: "W", w: "double you", p: "/ˈdʌbəljuː/"}, {n: "X", w: "ex", p: "/ɛks/"},
                {n: "Y", w: "why", p: "/waɪ/"}, {n: "Z", w: "zee", p: "/ziː/"}
            ] },
            { id: 7, name: "Ordinal Numbers", hasHomework: true, specialMode: 'listening', thirdBtn: 'dictation', desc: "Treine os números ordinais: first, second, third...", items: [{n:"1st",w:"First"},{n:"2nd",w:"Second"},{n:"3rd",w:"Third"},{n:"4th",w:"Fourth"},{n:"5th",w:"Fifth"},{n:"6th",w:"Sixth"},{n:"7th",w:"Seventh"},{n:"8th",w:"Eighth"},{n:"9th",w:"Ninth"},{n:"10th",w:"Tenth"},{n:"11th",w:"Eleventh"},{n:"12th",w:"Twelfth"},{n:"13th",w:"Thirteenth"},{n:"14th",w:"Fourteenth"},{n:"15th",w:"Fifteenth"},{n:"16th",w:"Sixteenth"},{n:"17th",w:"Seventeenth"},{n:"18th",w:"Eighteenth"},{n:"19th",w:"Nineteenth"},{n:"20th",w:"Twentieth"},{n:"21st",w:"Twenty-first"},{n:"22nd",w:"Twenty-second"},{n:"23rd",w:"Twenty-third"},{n:"24th",w:"Twenty-fourth"},{n:"25th",w:"Twenty-fifth"},{n:"26th",w:"Twenty-sixth"},{n:"27th",w:"Twenty-seventh"},{n:"28th",w:"Twenty-eighth"},{n:"29th",w:"Twenty-ninth"},{n:"30th",w:"Thirtieth"},{n:"31st",w:"Thirty-first"},{n:"32nd",w:"Thirty-second"},{n:"33rd",w:"Thirty-third"},{n:"34th",w:"Thirty-fourth"},{n:"35th",w:"Thirty-fifth"},{n:"40th",w:"Fortieth"},{n:"41st",w:"Forty-first"},{n:"42nd",w:"Forty-second"},{n:"43rd",w:"Forty-third"},{n:"45th",w:"Forty-fifth"},{n:"50th",w:"Fiftieth"},{n:"51st",w:"Fifty-first"},{n:"52nd",w:"Fifty-second"},{n:"53rd",w:"Fifty-third"},{n:"55th",w:"Fifty-fifth"},{n:"58th",w:"Fifty-eighth"},{n:"60th",w:"Sixtieth"},{n:"61st",w:"Sixty-first"},{n:"62nd",w:"Sixty-second"},{n:"63rd",w:"Sixty-third"},{n:"65th",w:"Sixty-fifth"},{n:"70th",w:"Seventieth"},{n:"71st",w:"Seventy-first"},{n:"72nd",w:"Seventy-second"},{n:"73rd",w:"Seventy-third"},{n:"75th",w:"Seventy-fifth"},{n:"77th",w:"Seventy-seventh"},{n:"80th",w:"Eightieth"},{n:"81st",w:"Eighty-first"},{n:"82nd",w:"Eighty-second"},{n:"83rd",w:"Eighty-third"},{n:"85th",w:"Eighty-fifth"},{n:"89th",w:"Eighty-ninth"},{n:"90th",w:"Ninetieth"},{n:"91st",w:"Ninety-first"},{n:"92nd",w:"Ninety-second"},{n:"93rd",w:"Ninety-third"},{n:"95th",w:"Ninety-fifth"},{n:"99th",w:"Ninety-ninth"},{n:"100th",w:"One hundredth"}] },
            { id: 8, name: "Basic Verbs", hasHomework: true, thirdBtn: 'dictation', desc: "Pratique os verbos mais usados no dia a dia." },
            { id: 9, name: "Basic Adjectives", hasHomework: true, thirdBtn: 'dictation', desc: "Aprenda adjetivos para descrever pessoas e coisas." },
            { id: 10, name: "Demonstrative Pronouns", hasHomework: true, specialMode: 'scramble', desc: "Treine this, that, these e those nas frases." },
            { id: 11, name: "Verb to be", hasHomework: true, desc: "Domine o verbo to be: am, is e are." },
            { id: 12, name: "Countries and Nationalities", hasHomework: true, specialMode: 'flashcards', desc: "Aprenda países e nacionalidades em inglês." },
            { id: 13, name: "Neighborhood", hasHomework: true, desc: "Vocabulário de lugares e locais do bairro." },
            { id: 14, name: "Family Members", hasHomework: true, desc: "Pratique os nomes dos membros da família." },
            { id: 15, name: "Midterm Test", hasHomework: false, desc: "Prova intermediária do módulo." },
            { id: 16, name: "Can e Can't", hasHomework: true, specialMode: 'scramble', desc: "Pratique frases com can e can't (habilidades)." },
            { id: 17, name: "Midterm Test Correction", hasHomework: false, desc: "Correção da prova intermediária." },
            { id: 18, name: "Simple Present pt. 1", hasHomework: true, specialMode: 'scramble', desc: "Monte frases no presente simples." },
            { id: 19, name: "Simple Present pt. 2", hasHomework: true, specialMode: 'scramble', desc: "Continue praticando o presente simples." },
            { id: 20, name: "Object Pronouns", hasHomework: true, specialMode: 'scramble', desc: "Treine me, you, him, her, us, them nas frases." },
            { id: 21, name: "Likes and Dislikes", hasHomework: true, desc: "Expresse gostos e preferências em inglês." },
            { id: 22, name: "Free Time Activities", hasHomework: true, desc: "Vocabulário de atividades de lazer e tempo livre." },
            { id: 23, name: "Months and Holidays", hasHomework: true, specialMode: 'listening', thirdBtn: 'flashcards', desc: "Aprenda os meses do ano e feriados.", items: [{n:"January",w:"Janeiro"},{n:"February",w:"Fevereiro"},{n:"March",w:"Março"},{n:"April",w:"Abril"},{n:"May",w:"Maio"},{n:"June",w:"Junho"},{n:"July",w:"Julho"},{n:"August",w:"Agosto"},{n:"September",w:"Setembro"},{n:"October",w:"Outubro"},{n:"November",w:"Novembro"},{n:"December",w:"Dezembro"},{n:"Christmas",w:"Natal"},{n:"New Year's Day",w:"Ano Novo"},{n:"Easter",w:"Páscoa"},{n:"Mother's Day",w:"Dia das Mães"},{n:"Father's Day",w:"Dia dos Pais"},{n:"Children's Day",w:"Dia das Crianças"},{n:"Carnival",w:"Carnaval"},{n:"Thanksgiving",w:"Ação de Graças"},{n:"Valentine's Day",w:"Dia dos Namorados"},{n:"Halloween",w:"Halloween"}] },
            { id: 24, name: "Possessive Adjectives", hasHomework: true, specialMode: 'scramble', desc: "Pratique my, your, his, her, our, their." },
            { id: 25, name: "Possessive Pronouns", hasHomework: true, specialMode: 'scramble', desc: "Treine mine, yours, his, hers, ours, theirs." },
            { id: 26, name: "Foods and Fruits", hasHomework: true, specialMode: 'flashcards', desc: "Vocabulário de comidas e frutas em inglês." },
            { id: 27, name: "Presentation", hasHomework: false, desc: "Aula de apresentação oral." },
            { id: 28, name: "Hours", hasHomework: true, specialMode: 'flashcards', thirdBtn: 'dictation', desc: "Aprenda a dizer as horas em inglês." },
            { id: 29, name: "Kahoot Review", hasHomework: false, desc: "Revisão interativa com Kahoot." },
            { id: 30, name: "Listening Test", hasHomework: false, desc: "Prova de compreensão auditiva." },
            { id: 31, name: "Grammar Test", hasHomework: false, desc: "Prova de gramática do módulo." },
            { id: 32, name: "GT e LT Review", hasHomework: false, desc: "Revisão das provas de gramática e listening." },
            { id: 33, name: "OT Review", hasHomework: false, desc: "Revisão para a prova oral." },
            { id: 34, name: "Oral Test Day 1", hasHomework: false, desc: "Primeiro dia da prova oral." },
            { id: 35, name: "Oral Test Day 2", hasHomework: false, desc: "Segundo dia da prova oral." },
            { id: 36, name: "General Feedback", hasHomework: false, desc: "Feedback geral do módulo." }
        ];

        const flashcardsData = {
            2: [
                { front: "Feliz", back: "Happy" }, { front: "Triste", back: "Sad" }, { front: "Bravo(a)", back: "Angry" },
                { front: "Cansado(a)", back: "Tired" }, { front: "Animado(a)", back: "Excited" }, { front: "Nervoso(a)", back: "Nervous" },
                { front: "Assustado(a)", back: "Scared" }, { front: "Entediado(a)", back: "Bored" }, { front: "Confuso(a)", back: "Confused" },
                { front: "Orgulhoso(a)", back: "Proud" }, { front: "Preocupado(a)", back: "Worried" }, { front: "Surpreso(a)", back: "Surprised" },
                { front: "Envergonhado(a)", back: "Embarrassed" }, { front: "Frustrado(a)", back: "Frustrated" }, { front: "Aliviado(a)", back: "Relieved" },
                { front: "Solitário(a)", back: "Lonely" }, { front: "Grato(a)", back: "Grateful" }, { front: "Ciumento(a)", back: "Jealous" },
                { front: "Calmo(a)", back: "Calm" }, { front: "Ansioso(a)", back: "Anxious" }
            ],
            12: [
                { front: "🇧🇷", back: "Brazil / Brazilian" }, { front: "🇺🇸", back: "USA / American" },
                { front: "🇬🇧", back: "England / British" }, { front: "🇫🇷", back: "France / French" },
                { front: "🇪🇸", back: "Spain / Spanish" }, { front: "🇮🇹", back: "Italy / Italian" },
                { front: "🇯🇵", back: "Japan / Japanese" }, { front: "🇨🇳", back: "China / Chinese" },
                { front: "🇩🇪", back: "Germany / German" }, { front: "🇵🇹", back: "Portugal / Portuguese" }
            ],
            23: [
                { front: "Natal", back: "Christmas" }, { front: "Ano Novo", back: "New Year's Day" }, 
                { front: "Páscoa", back: "Easter" }, { front: "Dia das Mães", back: "Mother's Day" }, 
                { front: "Dia dos Pais", back: "Father's Day" }, { front: "Dia das Crianças", back: "Children's Day" },
                { front: "Carnaval", back: "Carnival" }, { front: "Dia de Ação de Graças", back: "Thanksgiving" },
                { front: "Dia dos Namorados", back: "Valentine's Day" }, { front: "Halloween", back: "Halloween" }
            ],
            26: [
                { front: "🍎", back: "Apple" }, { front: "🍌", back: "Banana" }, { front: "🍊", back: "Orange" },
                { front: "🍇", back: "Grapes" }, { front: "🍓", back: "Strawberry" }, { front: "🍑", back: "Peach" },
                { front: "🍒", back: "Cherry" }, { front: "🍍", back: "Pineapple" }, { front: "🥭", back: "Mango" },
                { front: "🍉", back: "Watermelon" }, { front: "🍋", back: "Lemon" }, { front: "🍈", back: "Melon" },
                { front: "🥝", back: "Kiwi" }, { front: "🫐", back: "Blueberry" }, { front: "🍐", back: "Pear" },
                { front: "🥥", back: "Coconut" }, { front: "🍅", back: "Tomato" }, { front: "🥑", back: "Avocado" },
                { front: "🫒", back: "Olive" }, { front: "🍏", back: "Green Apple" }, { front: "🥒", back: "Cucumber" },
                { front: "🍕", back: "Pizza" }, { front: "🥦", back: "Broccoli" }, { front: "🥕", back: "Carrot" },
                { front: "🥩", back: "Steak" }, { front: "🍚", back: "Rice" }, { front: "🍦", back: "Ice cream" },
                { front: "🍞", back: "Bread" }, { front: "🧀", back: "Cheese" }, { front: "🥬", back: "Lettuce" }
            ],
            28: [
                { front: "08:00", back: "Eight o'clock" },
                { front: "08:30", back: "Eight thirty / Half past eight" },
                { front: "09:15", back: "Nine fifteen / Quarter past nine" },
                { front: "09:45", back: "Nine forty-five / Quarter to ten / Fifteen to ten" },
                { front: "10:20", back: "Ten twenty / Twenty past ten / Forty to eleven" },
                { front: "10:40", back: "Ten forty / Twenty to eleven / Forty past ten" },
                { front: "11:05", back: "Eleven oh five / Five past eleven" },
                { front: "11:55", back: "Eleven fifty-five / Five to twelve" },
                { front: "12:00", back: "Twelve o'clock / Noon / Midday" },
                { front: "00:00", back: "Twelve o'clock / Midnight" },
                { front: "03:30", back: "Three thirty / Half past three" },
                { front: "03:20", back: "Three twenty / Twenty past three / Forty to four" },
                { front: "04:10", back: "Four ten / Ten past four / Fifty to five" },
                { front: "05:25", back: "Five twenty-five / Twenty-five past five / Thirty-five to six" },
                { front: "06:35", back: "Six thirty-five / Thirty-five past six / Twenty-five to seven" },
                { front: "06:45", back: "Six forty-five / Quarter to seven / Fifteen to seven" },
                { front: "07:00", back: "Seven o'clock" },
                { front: "07:50", back: "Seven fifty / Ten to eight / Fifty past seven" },
                { front: "02:15", back: "Two fifteen / Quarter past two / Fifteen past two" },
                { front: "01:30", back: "One thirty / Half past one" }
            ]
        };

        const flashcardsDataStarter2 = {
            10: [
                { front: "Sofá", back: "Sofa / Couch" },
                { front: "Cadeira", back: "Chair" },
                { front: "Mesa", back: "Table" },
                { front: "Cama", back: "Bed" },
                { front: "Guarda-roupa", back: "Wardrobe" },
                { front: "Estante", back: "Bookshelf" },
                { front: "Escrivaninha", back: "Desk" },
                { front: "Cômoda", back: "Dresser" },
                { front: "Tapete", back: "Rug / Carpet" },
                { front: "Espelho", back: "Mirror" },
                { front: "Luminária", back: "Lamp" },
                { front: "Cortina", back: "Curtain" },
                { front: "Travesseiro", back: "Pillow" },
                { front: "Cobertor", back: "Blanket" },
                { front: "Prateleira", back: "Shelf" },
                { front: "Poltrona", back: "Armchair" },
                { front: "Lavar a louça", back: "Do the dishes" },
                { front: "Varrer o chão", back: "Sweep the floor" },
                { front: "Passar aspirador", back: "Vacuum" },
                { front: "Lavar roupa", back: "Do the laundry" },
                { front: "Passar roupa", back: "Iron the clothes" },
                { front: "Arrumar a cama", back: "Make the bed" },
                { front: "Tirar o lixo", back: "Take out the trash" },
                { front: "Cozinhar", back: "Cook" },
                { front: "Limpar o banheiro", back: "Clean the bathroom" },
                { front: "Organizar o quarto", back: "Tidy up the room" },
                { front: "Cortar a grama", back: "Mow the lawn" },
                { front: "Regar as plantas", back: "Water the plants" }
            ],
            2: [
                { front: "Sempre", back: "Always" },
                { front: "Geralmente", back: "Usually" },
                { front: "Frequentemente", back: "Often" },
                { front: "Às vezes", back: "Sometimes" },
                { front: "Raramente", back: "Rarely" },
                { front: "Quase nunca", back: "Hardly ever" },
                { front: "Nunca", back: "Never" },
                { front: "Com que frequência?", back: "How often?" },
                { front: "Todo dia", back: "Every day" },
                { front: "Toda semana", back: "Every week" },
                { front: "Todo mês", back: "Every month" },
                { front: "Uma vez por semana", back: "Once a week" },
                { front: "Duas vezes por semana", back: "Twice a week" },
                { front: "Três vezes por mês", back: "Three times a month" },
                { front: "De vez em quando", back: "Once in a while" },
                { front: "Normalmente", back: "Normally" },
                { front: "Quase sempre", back: "Almost always" },
                { front: "Constantemente", back: "Constantly" },
                { front: "Regularmente", back: "Regularly" },
                { front: "Ocasionalmente", back: "Occasionally" },
                { front: "Dia sim, dia não", back: "Every other day" },
                { front: "Nos finais de semana", back: "On weekends" },
                { front: "Durante a semana", back: "During the week" },
                { front: "De segunda a sexta", back: "From Monday to Friday" }
            ]
        };

        function getActiveFlashcards() {
            return currentLevel === 'starter2' ? flashcardsDataStarter2 : flashcardsData;
        }

        const chunksData = {
            3: [
                { en: "What's your name?", pt: "Qual é o seu nome?" }, 
                { en: "What's your first name?", pt: "Qual é o seu primeiro nome?" }, 
                { en: "What's your middle name?", pt: "Qual é o seu nome do meio?" }, 
                { en: "What's your nickname?", pt: "Qual é o seu apelido?" }, 
                { en: "What's your last name?", pt: "Qual é o seu sobrenome?" },
                { en: "My name is...", pt: "Meu nome é..." },
                { en: "Nice to meet you!", pt: "Prazer em conhecê-lo!" },
                { en: "Where are you from?", pt: "De onde você é?" },
                { en: "How old are you?", pt: "Quantos anos você tem?" },
                { en: "I'm from Brazil.", pt: "Eu sou do Brasil." }
            ]
        };

        const chunksDataStarter2 = {
            2: [
                { en: "I always wake up early.", pt: "Eu sempre acordo cedo." },
                { en: "She never eats fast food.", pt: "Ela nunca come fast food." },
                { en: "We usually study at night.", pt: "Nós geralmente estudamos à noite." },
                { en: "He sometimes plays video games.", pt: "Ele às vezes joga videogame." },
                { en: "They rarely go to the gym.", pt: "Eles raramente vão à academia." },
                { en: "How often do you read books?", pt: "Com que frequência você lê livros?" }
            ]
        };

        function getActiveChunks() {
            return currentLevel === 'starter2' ? chunksDataStarter2 : chunksData;
        }

        const gamesData = {
            // Demonstrative Pronouns (module 10)
            10: [
                { full: "this is my car", words: ["this", "is", "my", "car"] },
                { full: "that is your house", words: ["that", "is", "your", "house"] },
                { full: "these are my books", words: ["these", "are", "my", "books"] },
                { full: "those are her shoes", words: ["those", "are", "her", "shoes"] },
                { full: "this is a good idea", words: ["this", "is", "a", "good", "idea"] }
            ],
            // Can e Can't (module 16)
            16: [
                { full: "I can dance", words: ["I", "can", "dance"] },
                { full: "she can speak English", words: ["she", "can", "speak", "English"] },
                { full: "they can't swim", words: ["they", "can't", "swim"] },
                { full: "we can play soccer", words: ["we", "can", "play", "soccer"] },
                { full: "he can't drive a car", words: ["he", "can't", "drive", "a", "car"] }
            ],
            // Simple Present pt. 1 (module 18)
            18: [
                { full: "I drink water every day", words: ["I", "drink", "water", "every", "day"] },
                { full: "she works at a hospital", words: ["she", "works", "at", "a", "hospital"] },
                { full: "they study English", words: ["they", "study", "English"] },
                { full: "he plays soccer on weekends", words: ["he", "plays", "soccer", "on", "weekends"] },
                { full: "we eat breakfast together", words: ["we", "eat", "breakfast", "together"] }
            ],
            // Simple Present pt. 2 - negativas e interrogativas (module 19)
            19: [
                { full: "I don't like coffee", words: ["I", "don't", "like", "coffee"] },
                { full: "she doesn't work here", words: ["she", "doesn't", "work", "here"] },
                { full: "they don't speak French", words: ["they", "don't", "speak", "French"] },
                { full: "he doesn't have a car", words: ["he", "doesn't", "have", "a", "car"] },
                { full: "we don't eat meat", words: ["we", "don't", "eat", "meat"] },
                { full: "do you like pizza", words: ["do", "you", "like", "pizza"] },
                { full: "does she live here", words: ["does", "she", "live", "here"] },
                { full: "do they study English", words: ["do", "they", "study", "English"] },
                { full: "does he play guitar", words: ["does", "he", "play", "guitar"] },
                { full: "do we need help", words: ["do", "we", "need", "help"] }
            ],
            // Object Pronouns (module 20)
            20: [
                { full: "help me please", words: ["help", "me", "please"] },
                { full: "I love you", words: ["I", "love", "you"] },
                { full: "call him now", words: ["call", "him", "now"] },
                { full: "give her the book", words: ["give", "her", "the", "book"] },
                { full: "tell us the story", words: ["tell", "us", "the", "story"] }
            ],
            // Possessive Adjectives (module 24)
            24: [
                { full: "my book is new", words: ["my", "book", "is", "new"] },
                { full: "your car is fast", words: ["your", "car", "is", "fast"] },
                { full: "her dress is beautiful", words: ["her", "dress", "is", "beautiful"] },
                { full: "his name is John", words: ["his", "name", "is", "John"] },
                { full: "our house is big", words: ["our", "house", "is", "big"] }
            ],
            // Possessive Pronouns (module 25)
            25: [
                { full: "this pen is mine", words: ["this", "pen", "is", "mine"] },
                { full: "that book is yours", words: ["that", "book", "is", "yours"] },
                { full: "the car is hers", words: ["the", "car", "is", "hers"] },
                { full: "this phone is his", words: ["this", "phone", "is", "his"] },
                { full: "the house is ours", words: ["the", "house", "is", "ours"] }
            ],
            // Dictation data
            4: { dictation: ["one two three", "four five six", "seven eight nine", "ten one five", "three six nine", "two four eight", "five seven ten", "one four seven", "six eight two", "three five one", "nine two six", "four seven three", "eight ten five", "two nine four", "seven one eight"], isNumberCombo: true },
            5: { dictation: ["thirty", "fifty", "eighty", "one hundred", "two hundred", "three hundred fifty", "five hundred", "seven hundred twenty", "nine hundred ninety nine", "one thousand", "one thousand five hundred", "two thousand", "three thousand two hundred", "five thousand", "ten thousand", "fifteen thousand", "twenty five thousand", "fifty thousand", "one hundred thousand", "one million"] },
            6: { dictation: ["CAR", "DOG", "CAT", "BUS", "SUN", "HAT", "PEN", "RED", "BOX", "CUP", "BOOK", "TREE", "FISH", "BIRD", "HAND", "STAR", "MOON", "BALL", "CAKE", "MILK", "BILL", "DOOR", "RING", "LAMP"], isSpelling: true },
            7: { dictation: ["first", "second", "third", "fourth", "fifth", "sixth", "seventh", "eighth", "ninth", "tenth"] },
            8: { dictation: ["run", "walk", "eat", "drink", "sleep", "work", "play", "read", "write", "speak"] },
            9: { dictation: ["happy", "sad", "big", "small", "hot", "cold", "fast", "slow", "good", "bad"] },
            28: { dictation: ["08:00", "12:30", "03:15", "06:45", "09:00", "10:30", "02:00", "07:15", "11:45", "04:30"] }
        };

        // --- REAL HOMEWORK QUESTIONS (15 PER MODULE, 10 RANDOMLY SELECTED) ---
        const quizData = {
            2: [ // AULA 01: FEELINGS + VERB TO BE (15 perguntas)
                {q: "Complete a frase com a opção correta: After a long day, I am ____.", options: [{text:"happy", isCorrect:false}, {text:"tired", isCorrect:true}, {text:"excited", isCorrect:false}, {text:"relaxed", isCorrect:false}], rationale: "Após um longo dia, você fica cansado (tired)."},
                {q: "Escolha a frase mais natural em inglês:", options: [{text:"I am feel sad", isCorrect:false}, {text:"I feel sad", isCorrect:true}, {text:"I feeling sad", isCorrect:false}, {text:"I am sad feel", isCorrect:false}], rationale: "'I feel sad' é a forma correta."},
                {q: "Escolha o significado correto: 'She is angry.'", options: [{text:"Ela está cansada", isCorrect:false}, {text:"Ela está feliz", isCorrect:false}, {text:"Ela está brava", isCorrect:true}, {text:"Ela está animada", isCorrect:false}], rationale: "Angry = brava/irritada."},
                {q: "Complete a frase de acordo com a situação: When I don't sleep well, I feel ____.", options: [{text:"tired", isCorrect:true}, {text:"excited", isCorrect:false}, {text:"relaxed", isCorrect:false}, {text:"happy", isCorrect:false}], rationale: "Sem dormir bem, ficamos cansados (tired)."},
                {q: "Escolha o oposto de happy:", options: [{text:"angry", isCorrect:false}, {text:"sad", isCorrect:true}, {text:"tired", isCorrect:false}, {text:"scared", isCorrect:false}], rationale: "O oposto de feliz é triste (sad)."},
                {q: "Complete a frase com o verbo correto: 'I ____ scared of dogs.'", options: [{text:"is", isCorrect:false}, {text:"are", isCorrect:false}, {text:"am", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "'I' exige o verbo 'am'."},
                {q: "Qual opção NÃO é um sentimento?", options: [{text:"nervous", isCorrect:false}, {text:"tired", isCorrect:false}, {text:"smile", isCorrect:true}, {text:"angry", isCorrect:false}], rationale: "Smile (sorriso) é uma ação, não um sentimento."},
                {q: "Escolha a ordem mais natural das palavras:", options: [{text:"I am now angry", isCorrect:false}, {text:"I angry am now", isCorrect:false}, {text:"I now am angry", isCorrect:false}, {text:"I am angry now", isCorrect:true}], rationale: "A ordem padrão é Sujeito + Verbo + Adjetivo + Tempo."},
                {q: "Depois de uma boa notícia, você normalmente se sente:", options: [{text:"tired", isCorrect:false}, {text:"happy", isCorrect:true}, {text:"angry", isCorrect:false}, {text:"scared", isCorrect:false}], rationale: "Boas notícias trazem felicidade (happy)."},
                {q: "Depois de uma discussão ruim, você normalmente se sente:", options: [{text:"happy", isCorrect:false}, {text:"relaxed", isCorrect:false}, {text:"angry", isCorrect:true}, {text:"excited", isCorrect:false}], rationale: "Discussões ruins causam raiva (angry)."},
                {q: "Escolha o significado correto: 'He is nervous.'", options: [{text:"Ele está feliz", isCorrect:false}, {text:"Ele está nervoso", isCorrect:true}, {text:"Ele está cansado", isCorrect:false}, {text:"Ele está triste", isCorrect:false}], rationale: "Nervous = nervoso."},
                {q: "Complete: 'She ____ very excited about the trip.'", options: [{text:"are", isCorrect:false}, {text:"is", isCorrect:true}, {text:"am", isCorrect:false}, {text:"be", isCorrect:false}], rationale: "She + is."},
                {q: "Qual é o oposto de scared?", options: [{text:"angry", isCorrect:false}, {text:"brave", isCorrect:true}, {text:"sad", isCorrect:false}, {text:"tired", isCorrect:false}], rationale: "Scared (com medo) x Brave (corajoso)."},
                {q: "Complete: 'We ____ happy to be here.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"are", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "We + are."},
                {q: "Escolha o sentimento correto: Quando você ganha um presente, você fica ____.", options: [{text:"angry", isCorrect:false}, {text:"scared", isCorrect:false}, {text:"happy", isCorrect:true}, {text:"nervous", isCorrect:false}], rationale: "Ganhar presente nos deixa feliz (happy)."}
            ],
            3: [ // AULA 02: NAMES & GREETINGS (15 perguntas)
                {q: "Você está saindo da aula. O que você diz?", options: [{text:"Hi!", isCorrect:false}, {text:"Good morning!", isCorrect:false}, {text:"Have a good night", isCorrect:true}, {text:"What's up?", isCorrect:false}], rationale: "Ao sair, desejamos boa noite."},
                {q: "Complete a frase: '____ name is Daniela.'", options: [{text:"I", isCorrect:false}, {text:"My", isCorrect:true}, {text:"He", isCorrect:false}, {text:"You", isCorrect:false}], rationale: "My (meu/minha) é o possessivo correto."},
                {q: "Escolha a frase correta:", options: [{text:"My name Daniela", isCorrect:false}, {text:"My name is Daniela", isCorrect:true}, {text:"My is name Daniela", isCorrect:false}, {text:"Name is my Daniela", isCorrect:false}], rationale: "A estrutura é My name + is + Nome."},
                {q: "Você conhece seu professor pela primeira vez. O que você diz?", options: [{text:"Bye", isCorrect:false}, {text:"Hello, nice to meet you", isCorrect:true}, {text:"See you later", isCorrect:false}, {text:"Good night", isCorrect:false}], rationale: "Cumprimento padrão para o primeiro encontro."},
                {q: "Escolha a pergunta correta:", options: [{text:"What your name is?", isCorrect:false}, {text:"What is name you?", isCorrect:false}, {text:"What is your name?", isCorrect:true}, {text:"Your name what is?", isCorrect:false}], rationale: "Ordem correta: What is + your name?"},
                {q: "Complete a expressão: 'Nice to ____ you.'", options: [{text:"be", isCorrect:false}, {text:"say", isCorrect:false}, {text:"meet", isCorrect:true}, {text:"talk", isCorrect:false}], rationale: "Nice to meet you = Prazer em conhecê-lo."},
                {q: "'Hi, I'm Paulo' significa:", options: [{text:"Oi, eu sou Paulo", isCorrect:true}, {text:"Oi, qual é seu nome?", isCorrect:false}, {text:"Tchau, Paulo", isCorrect:false}, {text:"Prazer, Paulo", isCorrect:false}], rationale: "Tradução direta de apresentação."},
                {q: "Qual cumprimento é mais informal?", options: [{text:"Good evening", isCorrect:false}, {text:"Hello", isCorrect:false}, {text:"Hi", isCorrect:true}, {text:"Good afternoon", isCorrect:false}], rationale: "Hi é o mais informal."},
                {q: "Pergunta: What's your name?", options: [{text:"Hi!", isCorrect:false}, {text:"My name is Laura", isCorrect:true}, {text:"Nice to meet you", isCorrect:false}, {text:"Goodbye", isCorrect:false}], rationale: "Resposta direta à pergunta."},
                {q: "Quando normalmente dizemos 'Goodbye'?", options: [{text:"Quando chegamos", isCorrect:false}, {text:"Quando nos apresentamos", isCorrect:false}, {text:"Quando vamos embora", isCorrect:true}, {text:"Quando encontramos alguém", isCorrect:false}], rationale: "Goodbye é despedida."},
                {q: "Qual é a forma correta de dizer 'Boa tarde' em inglês?", options: [{text:"Good morning", isCorrect:false}, {text:"Good afternoon", isCorrect:true}, {text:"Good evening", isCorrect:false}, {text:"Good night", isCorrect:false}], rationale: "Good afternoon = Boa tarde."},
                {q: "Complete: 'See you ____!' (até mais tarde)", options: [{text:"after", isCorrect:false}, {text:"later", isCorrect:true}, {text:"before", isCorrect:false}, {text:"next", isCorrect:false}], rationale: "See you later = Até mais tarde."},
                {q: "Qual é a diferença entre 'Good evening' e 'Good night'?", options: [{text:"São iguais", isCorrect:false}, {text:"Evening é chegada, Night é despedida", isCorrect:true}, {text:"Night é chegada, Evening é despedida", isCorrect:false}, {text:"Nenhuma das opções", isCorrect:false}], rationale: "Good evening = cumprimento ao chegar à noite. Good night = despedida."},
                {q: "'How are you?' é usado para:", options: [{text:"Pedir o nome", isCorrect:false}, {text:"Se despedir", isCorrect:false}, {text:"Perguntar como a pessoa está", isCorrect:true}, {text:"Pedir a idade", isCorrect:false}], rationale: "How are you = Como você está?"},
                {q: "Escolha a resposta correta para 'How are you?':", options: [{text:"My name is Ana", isCorrect:false}, {text:"I'm fine, thanks", isCorrect:true}, {text:"Goodbye", isCorrect:false}, {text:"Nice to meet you", isCorrect:false}], rationale: "I'm fine, thanks é a resposta natural."}
            ],
            4: [ // AULA 03: NUMBERS (15 perguntas)
                {q: "Escolha o número correto: 'Eight'", options: [{text:"6", isCorrect:false}, {text:"7", isCorrect:false}, {text:"8", isCorrect:true}, {text:"9", isCorrect:false}], rationale: "Eight = 8."},
                {q: "Complete a frase: 'I have ____ cousins.'", options: [{text:"two", isCorrect:true}, {text:"second", isCorrect:false}, {text:"twice", isCorrect:false}, {text:"double", isCorrect:false}], rationale: "Usa-se número cardinal para quantidade."},
                {q: "O que vem depois de nine?", options: [{text:"eight", isCorrect:false}, {text:"ten", isCorrect:true}, {text:"eleven", isCorrect:false}, {text:"twelve", isCorrect:false}], rationale: "9, 10 (Ten)."},
                {q: "Complete a frase: 'I am ____ years old.'", options: [{text:"twenty", isCorrect:true}, {text:"twentieth", isCorrect:false}, {text:"twenties", isCorrect:false}, {text:"twentys", isCorrect:false}], rationale: "Idade usa números cardinais."},
                {q: "Escolha a frase correta:", options: [{text:"I have three brother", isCorrect:false}, {text:"I have three brothers", isCorrect:true}, {text:"I have brother three", isCorrect:false}, {text:"I have brothers three", isCorrect:false}], rationale: "Plural no substantivo após o número."},
                {q: "Complete a frase: '____ students are in the SLAP class.' (10)", options: [{text:"tenth", isCorrect:false}, {text:"ten", isCorrect:true}, {text:"teen", isCorrect:false}, {text:"tens", isCorrect:false}], rationale: "Quantidade 10 = Ten."},
                {q: "Four plus five is:", options: [{text:"eight", isCorrect:false}, {text:"nine", isCorrect:true}, {text:"ten", isCorrect:false}, {text:"eleven", isCorrect:false}], rationale: "4 + 5 = 9 (Nine)."},
                {q: "Escolha a frase mais natural em inglês:", options: [{text:"I have 30 years", isCorrect:false}, {text:"I am 30 years", isCorrect:false}, {text:"I am 30 years old", isCorrect:true}, {text:"I have 30 old", isCorrect:false}], rationale: "Em inglês, 'somos' a idade (I am), não 'temos'."},
                {q: "Escolha a grafia correta:", options: [{text:"for", isCorrect:false}, {text:"fore", isCorrect:false}, {text:"four", isCorrect:true}, {text:"fower", isCorrect:false}], rationale: "Quatro = Four."},
                {q: "Escolha a frase correta:", options: [{text:"I have two car", isCorrect:false}, {text:"I have two cars", isCorrect:true}, {text:"I have cars two", isCorrect:false}, {text:"I have two car's", isCorrect:false}], rationale: "Número + Substantivo Plural."},
                {q: "Escolha a grafia correta do número 3:", options: [{text:"tree", isCorrect:false}, {text:"three", isCorrect:true}, {text:"thre", isCorrect:false}, {text:"trhee", isCorrect:false}], rationale: "Três = Three."},
                {q: "Seven plus three is:", options: [{text:"nine", isCorrect:false}, {text:"eleven", isCorrect:false}, {text:"ten", isCorrect:true}, {text:"eight", isCorrect:false}], rationale: "7 + 3 = 10 (Ten)."},
                {q: "Qual é o número correto: 'Fifteen'?", options: [{text:"50", isCorrect:false}, {text:"5", isCorrect:false}, {text:"15", isCorrect:true}, {text:"14", isCorrect:false}], rationale: "Fifteen = 15."},
                {q: "Complete: 'There are ____ months in a year.' (12)", options: [{text:"twelve", isCorrect:true}, {text:"twenty", isCorrect:false}, {text:"ten", isCorrect:false}, {text:"eleven", isCorrect:false}], rationale: "Um ano tem 12 (twelve) meses."},
                {q: "Escolha a grafia correta do número 6:", options: [{text:"seis", isCorrect:false}, {text:"siks", isCorrect:false}, {text:"six", isCorrect:true}, {text:"siz", isCorrect:false}], rationale: "Seis = Six."}
            ],
            5: [ // AULA 04: NUMBERS (CONTEXTO REAL) (15 perguntas)
                {q: "Como normalmente falamos um número de telefone em inglês?", options: [{text:"In big numbers", isCorrect:false}, {text:"As one long number", isCorrect:false}, {text:"Digit by digit", isCorrect:true}, {text:"Using ordinal numbers", isCorrect:false}], rationale: "Telefones são ditos dígito a dígito."},
                {q: "Escolha a forma mais natural de dizer 358:", options: [{text:"Three five eight", isCorrect:false}, {text:"Three hundred fifty-eight", isCorrect:true}, {text:"Thirty five eight", isCorrect:false}, {text:"Three hundred eight", isCorrect:false}], rationale: "Centenas + dezenas."},
                {q: "Como normalmente dizemos o ano 2015 de forma formal?", options: [{text:"Two thousand and fifteen", isCorrect:true}, {text:"Twenty fifteen", isCorrect:false}, {text:"Two zero one five", isCorrect:false}, {text:"Two thousand five", isCorrect:false}], rationale: "Forma formal usa 'two thousand and...'."},
                {q: "Escolha a forma mais natural de dizer $12.99:", options: [{text:"Twelve ninety-nine", isCorrect:true}, {text:"Twelve dollars ninety-nine", isCorrect:false}, {text:"Twelve dollars and ninety-nine cents", isCorrect:false}, {text:"Ninety-nine dollars twelve", isCorrect:false}], rationale: "Forma curta comum para preços."},
                {q: "Complete a frase: 'My house number is ____.' (230)", options: [{text:"Two three zero", isCorrect:true}, {text:"Two hundred thirty zero", isCorrect:false}, {text:"Twenty three zero", isCorrect:false}, {text:"Two hundred three", isCorrect:false}], rationale: "Endereços costumam ser dígito a dígito."},
                {q: "Complete a frase: 'My phone number starts with ____.' (9)", options: [{text:"nine", isCorrect:true}, {text:"ninth", isCorrect:false}, {text:"nineteen", isCorrect:false}, {text:"ninety", isCorrect:false}], rationale: "Dígito 9 = Nine."},
                {q: "Que número vem depois de thirty-nine?", options: [{text:"thirty-ten", isCorrect:false}, {text:"forty", isCorrect:true}, {text:"fourteen", isCorrect:false}, {text:"forty-one", isCorrect:false}], rationale: "39 -> 40 (Forty)."},
                {q: "Escolha a frase correta:", options: [{text:"The price is 20 dollars and 50", isCorrect:false}, {text:"The price is twenty dollars fifty", isCorrect:false}, {text:"The price is twenty dollars and fifty cents", isCorrect:true}, {text:"The price is twenty fifty", isCorrect:false}], rationale: "Forma completa e correta de preço."},
                {q: "Como normalmente falamos números de apartamento?", options: [{text:"Using ordinal numbers", isCorrect:false}, {text:"Digit by digit", isCorrect:true}, {text:"Using letters", isCorrect:false}, {text:"Using plural numbers", isCorrect:false}], rationale: "Como telefones e endereços."},
                {q: "Escolha a grafia correta:", options: [{text:"Fourty", isCorrect:false}, {text:"Forty", isCorrect:true}, {text:"Fourti", isCorrect:false}, {text:"Fourtee", isCorrect:false}], rationale: "Quarenta se escreve Forty (sem o 'u')."},
                {q: "Como dizemos o número 0 em um telefone?", options: [{text:"zero", isCorrect:false}, {text:"oh", isCorrect:true}, {text:"null", isCorrect:false}, {text:"none", isCorrect:false}], rationale: "Em telefones, 0 é dito como 'oh'."},
                {q: "Escolha a forma correta de dizer $50.00:", options: [{text:"Five zero dollars", isCorrect:false}, {text:"Fifty dollars", isCorrect:true}, {text:"Five ten dollars", isCorrect:false}, {text:"Fivety dollars", isCorrect:false}], rationale: "50 = Fifty."},
                {q: "Como dizemos o ano 1990?", options: [{text:"One nine nine zero", isCorrect:false}, {text:"Nineteen ninety", isCorrect:true}, {text:"One thousand nine hundred ninety", isCorrect:false}, {text:"Nineteen nine zero", isCorrect:false}], rationale: "Anos antigos: dezenove + noventa."},
                {q: "Complete: 'The temperature is ____ degrees.' (100)", options: [{text:"one hundred", isCorrect:true}, {text:"ten zero", isCorrect:false}, {text:"hundred one", isCorrect:false}, {text:"a ten", isCorrect:false}], rationale: "100 = One hundred."},
                {q: "Como se diz R$ 3,50 em inglês?", options: [{text:"Three fifty", isCorrect:true}, {text:"Three and fifty", isCorrect:false}, {text:"Thirty five", isCorrect:false}, {text:"Three five zero", isCorrect:false}], rationale: "Preços curtos: Three fifty."}
            ],
            6: [ // AULA 05: SPELLING & PERSONAL INFORMATION (15 perguntas)
                {q: "Alguém pergunta: 'How do you spell your last name?' O que você responde?", options: [{text:"I am Silva", isCorrect:false}, {text:"Silva", isCorrect:false}, {text:"S-I-L-V-A", isCorrect:true}, {text:"My name is Silva", isCorrect:false}], rationale: "Soletrar = dizer letra por letra."},
                {q: "Escolha a grafia correta do nome: 'Maria'", options: [{text:"M-E-R-I-A", isCorrect:false}, {text:"M-A-R-I-A", isCorrect:true}, {text:"M-A-R-E-A", isCorrect:false}, {text:"M-E-R-E-A", isCorrect:false}], rationale: "A soletração correta."},
                {q: "Como dizemos o símbolo @ em inglês?", options: [{text:"at", isCorrect:true}, {text:"on", isCorrect:false}, {text:"in", isCorrect:false}, {text:"to", isCorrect:false}], rationale: "@ = at."},
                {q: "Complete a frase corretamente: 'My email is anna ____ hotmail.com'", options: [{text:"on", isCorrect:false}, {text:"at", isCorrect:true}, {text:"in", isCorrect:false}, {text:"to", isCorrect:false}], rationale: "Usa-se 'at' para o @."},
                {q: "Escolha a frase correta:", options: [{text:"Can you spell your name?", isCorrect:true}, {text:"Can you spell me your name?", isCorrect:false}, {text:"You spell your name?", isCorrect:false}, {text:"Spell you your name?", isCorrect:false}], rationale: "Pergunta correta para pedir soletração."},
                {q: "Como abreviamos Television?", options: [{text:"Tee-vee", isCorrect:false}, {text:"T-V", isCorrect:true}, {text:"Ti-vi", isCorrect:false}, {text:"Tee-vi", isCorrect:false}], rationale: "TV são as letras T e V."},
                {q: "Complete a frase: 'My name is Jacob. It has ____ letters.'", options: [{text:"five", isCorrect:true}, {text:"fifth", isCorrect:false}, {text:"fiveth", isCorrect:false}, {text:"fifteenth", isCorrect:false}], rationale: "J-A-C-O-B = 5 letras."},
                {q: "Quando soletramos informações, normalmente:", options: [{text:"falamos rápido", isCorrect:false}, {text:"usamos números ordinais", isCorrect:false}, {text:"dizemos cada letra claramente", isCorrect:true}, {text:"traduzimos a palavra", isCorrect:false}], rationale: "Clareza é essencial ao soletrar."},
                {q: "Escolha a abreviação correta de 'Speaking Like a Pro':", options: [{text:"SPARK", isCorrect:false}, {text:"SELIAPR", isCorrect:false}, {text:"SLP", isCorrect:false}, {text:"SLAP", isCorrect:true}], rationale: "SLAP = Speaking Like A Pro."},
                {q: "Qual pergunta gera a resposta 'M-A-R-I-A'?", options: [{text:"Can you spell your name for me?", isCorrect:true}, {text:"Can you spell your last name for me?", isCorrect:false}, {text:"How are you?", isCorrect:false}, {text:"Can you spell your middle name for me?", isCorrect:false}], rationale: "A resposta é a soletração do primeiro nome."},
                {q: "Como dizemos o ponto (.) em um email?", options: [{text:"point", isCorrect:false}, {text:"dot", isCorrect:true}, {text:"period", isCorrect:false}, {text:"stop", isCorrect:false}], rationale: "Em emails e sites, . = dot."},
                {q: "Escolha a soletração correta de 'Lucas':", options: [{text:"L-U-K-A-S", isCorrect:false}, {text:"L-U-C-A-S", isCorrect:true}, {text:"L-O-C-A-S", isCorrect:false}, {text:"L-U-C-A-Z", isCorrect:false}], rationale: "Lucas = L-U-C-A-S."},
                {q: "Complete: 'What is your ____?' — 'It's lucas@email.com'", options: [{text:"name", isCorrect:false}, {text:"phone", isCorrect:false}, {text:"email", isCorrect:true}, {text:"address", isCorrect:false}], rationale: "A resposta é um email."},
                {q: "Como dizemos a letra W em inglês?", options: [{text:"we", isCorrect:false}, {text:"double u", isCorrect:true}, {text:"wee", isCorrect:false}, {text:"vu", isCorrect:false}], rationale: "W = double u."},
                {q: "Qual letra do alfabeto em inglês se pronuncia parecido com 'ar'?", options: [{text:"A", isCorrect:false}, {text:"H", isCorrect:false}, {text:"R", isCorrect:true}, {text:"E", isCorrect:false}], rationale: "R em inglês soa como 'ar'."}
            ],
            7: [ // AULA 06: ORDINAL NUMBERS (15 perguntas)
                {q: "Escolha o número ordinal de 1:", options: [{text:"one", isCorrect:false}, {text:"first", isCorrect:true}, {text:"once", isCorrect:false}, {text:"oneth", isCorrect:false}], rationale: "1º = first."},
                {q: "Qual é o ordinal de 2?", options: [{text:"two", isCorrect:false}, {text:"second", isCorrect:true}, {text:"twoth", isCorrect:false}, {text:"twelve", isCorrect:false}], rationale: "2º = second."},
                {q: "Complete a frase: 'I live on the ____ floor.' (3)", options: [{text:"three", isCorrect:false}, {text:"third", isCorrect:true}, {text:"thirteen", isCorrect:false}, {text:"thirty", isCorrect:false}], rationale: "3º andar = third floor."},
                {q: "Complete a frase: 'My birthday is on the ____ of May.' (5)", options: [{text:"five", isCorrect:false}, {text:"fifth", isCorrect:true}, {text:"fifteen", isCorrect:false}, {text:"fifty", isCorrect:false}], rationale: "5º = fifth."},
                {q: "Qual é o ordinal de 4?", options: [{text:"four", isCorrect:false}, {text:"fourth", isCorrect:true}, {text:"forty", isCorrect:false}, {text:"fortieth", isCorrect:false}], rationale: "4º = fourth."},
                {q: "Escolha a frase correta:", options: [{text:"I am on the two floor", isCorrect:false}, {text:"I am on the second floor", isCorrect:true}, {text:"I am in the two floor", isCorrect:false}, {text:"I am in second floor", isCorrect:false}], rationale: "Usamos ordinal + on the."},
                {q: "Complete a frase: 'This is my ____ day at SLAP.' (1)", options: [{text:"one", isCorrect:false}, {text:"first", isCorrect:true}, {text:"once", isCorrect:false}, {text:"oneth", isCorrect:false}], rationale: "1º = first."},
                {q: "Qual é o ordinal de 6?", options: [{text:"six", isCorrect:false}, {text:"sixth", isCorrect:true}, {text:"sixt", isCorrect:false}, {text:"sixteen", isCorrect:false}], rationale: "6º = sixth."},
                {q: "Complete a frase: 'The meeting is on the ____ of June.' (2)", options: [{text:"two", isCorrect:false}, {text:"second", isCorrect:true}, {text:"twelve", isCorrect:false}, {text:"twenty", isCorrect:false}], rationale: "2º = second."},
                {q: "Quando usamos números ordinais?", options: [{text:"Para falar de quantidade", isCorrect:false}, {text:"Para falar de ordem", isCorrect:true}, {text:"Para falar de cor", isCorrect:false}, {text:"Para falar de preço", isCorrect:false}], rationale: "Ordinais indicam posição/ordem."},
                {q: "Qual é o ordinal de 10?", options: [{text:"ten", isCorrect:false}, {text:"tenth", isCorrect:true}, {text:"tenfth", isCorrect:false}, {text:"teen", isCorrect:false}], rationale: "10º = tenth."},
                {q: "Complete: 'She finished in ____ place.' (7)", options: [{text:"seven", isCorrect:false}, {text:"seventh", isCorrect:true}, {text:"seventeenth", isCorrect:false}, {text:"seventy", isCorrect:false}], rationale: "7º = seventh."},
                {q: "Qual é o ordinal de 9?", options: [{text:"nineth", isCorrect:false}, {text:"ninth", isCorrect:true}, {text:"ninethy", isCorrect:false}, {text:"nine", isCorrect:false}], rationale: "9º = ninth (sem o 'e')."},
                {q: "Complete: 'Today is my ____ birthday.' (8)", options: [{text:"eight", isCorrect:false}, {text:"eighth", isCorrect:true}, {text:"eighty", isCorrect:false}, {text:"eightth", isCorrect:false}], rationale: "8º = eighth."},
                {q: "Qual é o padrão da maioria dos ordinais?", options: [{text:"Adicionar -st", isCorrect:false}, {text:"Adicionar -th", isCorrect:true}, {text:"Adicionar -nd", isCorrect:false}, {text:"Adicionar -rd", isCorrect:false}], rationale: "A maioria dos ordinais termina em -th (fourth, fifth, sixth...)."}
            ],
            8: [ // AULA 07: BASIC VERBS (SIMPLE PRESENT) (15 perguntas)
                {q: "Complete a frase: 'I ____ breakfast in the morning.'", options: [{text:"eats", isCorrect:false}, {text:"eat", isCorrect:true}, {text:"eating", isCorrect:false}, {text:"ate", isCorrect:false}], rationale: "Com 'I' usamos o verbo na forma base."},
                {q: "Complete a frase: 'She ____ water every day.'", options: [{text:"drink", isCorrect:false}, {text:"drinks", isCorrect:true}, {text:"drinking", isCorrect:false}, {text:"drank", isCorrect:false}], rationale: "Com 'she' adicionamos -s ao verbo."},
                {q: "Complete a frase: 'They ____ soccer on weekends.'", options: [{text:"plays", isCorrect:false}, {text:"play", isCorrect:true}, {text:"playing", isCorrect:false}, {text:"played", isCorrect:false}], rationale: "Com 'they' usamos o verbo na forma base."},
                {q: "Escolha a frase correta:", options: [{text:"He read books", isCorrect:false}, {text:"He reads books", isCorrect:true}, {text:"He reading books", isCorrect:false}, {text:"He read books every day", isCorrect:false}], rationale: "Com 'he' adicionamos -s ao verbo."},
                {q: "Complete a frase: 'We ____ English at SLAP.'", options: [{text:"speaks", isCorrect:false}, {text:"speak", isCorrect:true}, {text:"speaking", isCorrect:false}, {text:"spoke", isCorrect:false}], rationale: "Com 'we' usamos o verbo na forma base."},
                {q: "Complete a frase: 'She ____ every morning.'", options: [{text:"run", isCorrect:false}, {text:"runs", isCorrect:true}, {text:"running", isCorrect:false}, {text:"ran", isCorrect:false}], rationale: "Com 'she' adicionamos -s ao verbo."},
                {q: "Escolha a frase correta:", options: [{text:"I write emails", isCorrect:true}, {text:"I writes emails", isCorrect:false}, {text:"I writing emails", isCorrect:false}, {text:"I wrote emails every day", isCorrect:false}], rationale: "Com 'I' usamos o verbo na forma base."},
                {q: "Complete a frase: 'He ____ his homework at night.'", options: [{text:"do", isCorrect:false}, {text:"does", isCorrect:true}, {text:"doing", isCorrect:false}, {text:"did", isCorrect:false}], rationale: "Com 'he' o verbo 'do' vira 'does'."},
                {q: "Complete a frase: 'She ____ a book before bed.'", options: [{text:"read", isCorrect:false}, {text:"reads", isCorrect:true}, {text:"reading", isCorrect:false}, {text:"readed", isCorrect:false}], rationale: "Com 'she' adicionamos -s ao verbo."},
                {q: "Escolha a frase correta:", options: [{text:"They drink coffee", isCorrect:true}, {text:"They drinks coffee", isCorrect:false}, {text:"They drinking coffee", isCorrect:false}, {text:"They drank coffee every day", isCorrect:false}], rationale: "Com 'they' usamos o verbo na forma base."},
                {q: "Complete: 'He ____ TV after dinner.'", options: [{text:"watch", isCorrect:false}, {text:"watches", isCorrect:true}, {text:"watching", isCorrect:false}, {text:"watched", isCorrect:false}], rationale: "Com 'he' + verbo terminado em -ch, adicionamos -es."},
                {q: "Complete: 'I ____ to school by bus.'", options: [{text:"goes", isCorrect:false}, {text:"go", isCorrect:true}, {text:"going", isCorrect:false}, {text:"went", isCorrect:false}], rationale: "Com 'I' usamos o verbo na forma base."},
                {q: "Complete: 'She ____ English and Portuguese.'", options: [{text:"speak", isCorrect:false}, {text:"speaks", isCorrect:true}, {text:"speaking", isCorrect:false}, {text:"spoke", isCorrect:false}], rationale: "Com 'she' adicionamos -s ao verbo."},
                {q: "Complete: 'We ____ dinner at 7 PM.'", options: [{text:"has", isCorrect:false}, {text:"have", isCorrect:true}, {text:"having", isCorrect:false}, {text:"had", isCorrect:false}], rationale: "Com 'we' usamos 'have' (forma base)."},
                {q: "Complete: 'He ____ to work every day.'", options: [{text:"go", isCorrect:false}, {text:"goes", isCorrect:true}, {text:"going", isCorrect:false}, {text:"went", isCorrect:false}], rationale: "Com 'he' + verbo 'go', adicionamos -es: goes."}
            ],
            9: [ // AULA 08: BASIC ADJECTIVES (15 perguntas)
                {q: "Escolha o oposto de big:", options: [{text:"tall", isCorrect:false}, {text:"small", isCorrect:true}, {text:"old", isCorrect:false}, {text:"good", isCorrect:false}], rationale: "Big (grande) x Small (pequeno)."},
                {q: "Escolha a frase correta:", options: [{text:"The house is big", isCorrect:true}, {text:"The house big is", isCorrect:false}, {text:"Big the house is", isCorrect:false}, {text:"House is the big", isCorrect:false}], rationale: "Ordem: Sujeito + is + adjetivo."},
                {q: "Escolha o oposto de tall:", options: [{text:"big", isCorrect:false}, {text:"old", isCorrect:false}, {text:"short", isCorrect:true}, {text:"small", isCorrect:false}], rationale: "Tall (alto) x Short (baixo)."},
                {q: "Complete a frase: 'The car is ____.' (not good)", options: [{text:"big", isCorrect:false}, {text:"bad", isCorrect:true}, {text:"old", isCorrect:false}, {text:"tall", isCorrect:false}], rationale: "Good (bom) x Bad (ruim)."},
                {q: "Complete a frase: 'He is ____.' (not old)", options: [{text:"old", isCorrect:false}, {text:"bad", isCorrect:false}, {text:"young", isCorrect:true}, {text:"short", isCorrect:false}], rationale: "Old (velho) x Young (jovem)."},
                {q: "Escolha o oposto de young:", options: [{text:"tall", isCorrect:false}, {text:"small", isCorrect:false}, {text:"old", isCorrect:true}, {text:"big", isCorrect:false}], rationale: "Young (jovem) x Old (velho)."},
                {q: "Escolha a frase correta:", options: [{text:"The dog is small", isCorrect:true}, {text:"The dog small is", isCorrect:false}, {text:"Small is the dog", isCorrect:false}, {text:"Dog is small the", isCorrect:false}], rationale: "Ordem: Sujeito + is + adjetivo."},
                {q: "Complete a frase: 'The building is ____.' (not short)", options: [{text:"tall", isCorrect:true}, {text:"small", isCorrect:false}, {text:"young", isCorrect:false}, {text:"bad", isCorrect:false}], rationale: "Short (baixo) x Tall (alto)."},
                {q: "Escolha o oposto de good:", options: [{text:"big", isCorrect:false}, {text:"old", isCorrect:false}, {text:"bad", isCorrect:true}, {text:"small", isCorrect:false}], rationale: "Good (bom) x Bad (ruim)."},
                {q: "Qual opção é um adjetivo?", options: [{text:"run", isCorrect:false}, {text:"eat", isCorrect:false}, {text:"old", isCorrect:true}, {text:"speak", isCorrect:false}], rationale: "Old é adjetivo, os outros são verbos."},
                {q: "Escolha o oposto de new:", options: [{text:"big", isCorrect:false}, {text:"old", isCorrect:true}, {text:"bad", isCorrect:false}, {text:"short", isCorrect:false}], rationale: "New (novo) x Old (velho)."},
                {q: "Complete: 'The food is ____.' (tasty)", options: [{text:"bad", isCorrect:false}, {text:"good", isCorrect:true}, {text:"old", isCorrect:false}, {text:"tall", isCorrect:false}], rationale: "Comida gostosa = good."},
                {q: "Escolha o oposto de hot:", options: [{text:"warm", isCorrect:false}, {text:"cold", isCorrect:true}, {text:"big", isCorrect:false}, {text:"small", isCorrect:false}], rationale: "Hot (quente) x Cold (frio)."},
                {q: "Complete: 'The movie is very ____.' (interesting)", options: [{text:"bad", isCorrect:false}, {text:"short", isCorrect:false}, {text:"good", isCorrect:true}, {text:"old", isCorrect:false}], rationale: "Filme interessante = good."},
                {q: "Onde fica o adjetivo em inglês?", options: [{text:"Depois do substantivo", isCorrect:false}, {text:"Antes do substantivo ou depois do verbo to be", isCorrect:true}, {text:"No final da frase sempre", isCorrect:false}, {text:"Antes do verbo", isCorrect:false}], rationale: "Adjetivos vêm antes do substantivo (big house) ou após to be (is big)."}
            ],
            10: [ // AULA 09: DEMONSTRATIVE PRONOUNS (15 perguntas)
                {q: "Complete a frase: '____ is my phone.' (perto, singular)", options: [{text:"that", isCorrect:false}, {text:"these", isCorrect:false}, {text:"this", isCorrect:true}, {text:"those", isCorrect:false}], rationale: "This = perto + singular."},
                {q: "Complete a frase: '____ are my keys.' (perto, plural)", options: [{text:"this", isCorrect:false}, {text:"that", isCorrect:false}, {text:"those", isCorrect:false}, {text:"these", isCorrect:true}], rationale: "These = perto + plural."},
                {q: "Complete a frase: '____ is my house over there.' (longe, singular)", options: [{text:"this", isCorrect:false}, {text:"these", isCorrect:false}, {text:"that", isCorrect:true}, {text:"those", isCorrect:false}], rationale: "That = longe + singular."},
                {q: "Complete a frase: '____ are those people.' (longe, plural)", options: [{text:"this", isCorrect:false}, {text:"that", isCorrect:false}, {text:"these", isCorrect:false}, {text:"those", isCorrect:true}], rationale: "Those = longe + plural."},
                {q: "Escolha a frase correta:", options: [{text:"This are my books", isCorrect:false}, {text:"These is my books", isCorrect:false}, {text:"These are my books", isCorrect:true}, {text:"Those is my books", isCorrect:false}], rationale: "These (plural) + are."},
                {q: "Complete a frase: '____ pen here is blue.' (perto)", options: [{text:"that", isCorrect:false}, {text:"those", isCorrect:false}, {text:"these", isCorrect:false}, {text:"this", isCorrect:true}], rationale: "This = perto + singular."},
                {q: "Complete a frase: '____ cars over there are expensive.'", options: [{text:"this", isCorrect:false}, {text:"that", isCorrect:false}, {text:"these", isCorrect:false}, {text:"those", isCorrect:true}], rationale: "Those = longe + plural."},
                {q: "Qual opção é plural?", options: [{text:"this", isCorrect:false}, {text:"that", isCorrect:false}, {text:"these", isCorrect:true}, {text:"thises", isCorrect:false}], rationale: "These é a forma plural de this."},
                {q: "Escolha a frase correta:", options: [{text:"That are my shoes", isCorrect:false}, {text:"Those are my shoes", isCorrect:true}, {text:"Those is my shoes", isCorrect:false}, {text:"That is my shoes", isCorrect:false}], rationale: "Those (plural) + are."},
                {q: "Quando usamos this?", options: [{text:"Para algo longe e plural", isCorrect:false}, {text:"Para algo perto e singular", isCorrect:true}, {text:"Para algo longe e singular", isCorrect:false}, {text:"Para algo perto e plural", isCorrect:false}], rationale: "This = perto + singular."},
                {q: "Complete: '____ dog over there is cute.' (longe, singular)", options: [{text:"this", isCorrect:false}, {text:"these", isCorrect:false}, {text:"that", isCorrect:true}, {text:"those", isCorrect:false}], rationale: "That = longe + singular."},
                {q: "Complete: '____ cookies here are delicious.' (perto, plural)", options: [{text:"this", isCorrect:false}, {text:"that", isCorrect:false}, {text:"those", isCorrect:false}, {text:"these", isCorrect:true}], rationale: "These = perto + plural."},
                {q: "Qual é o plural de 'that'?", options: [{text:"thats", isCorrect:false}, {text:"these", isCorrect:false}, {text:"those", isCorrect:true}, {text:"thoses", isCorrect:false}], rationale: "That (singular longe) -> Those (plural longe)."},
                {q: "Escolha a frase correta:", options: [{text:"This is a good idea", isCorrect:true}, {text:"These is a good idea", isCorrect:false}, {text:"This are a good idea", isCorrect:false}, {text:"That are a good idea", isCorrect:false}], rationale: "This (singular) + is."},
                {q: "Complete: 'Look at ____ stars in the sky!' (longe, plural)", options: [{text:"this", isCorrect:false}, {text:"that", isCorrect:false}, {text:"these", isCorrect:false}, {text:"those", isCorrect:true}], rationale: "Those = longe + plural."}
            ],
            11: [ // AULA 10: VERB TO BE (15 perguntas)
                {q: "Complete a frase: 'I ____ tired.'", options: [{text:"is", isCorrect:false}, {text:"are", isCorrect:false}, {text:"am", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "I + am."},
                {q: "Complete a frase: 'She ____ a teacher.'", options: [{text:"am", isCorrect:false}, {text:"are", isCorrect:false}, {text:"is", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "She + is."},
                {q: "Complete a frase: 'They ____ at home.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"be", isCorrect:false}, {text:"are", isCorrect:true}], rationale: "They + are."},
                {q: "Escolha a frase correta:", options: [{text:"He are happy", isCorrect:false}, {text:"He am happy", isCorrect:false}, {text:"He is happy", isCorrect:true}, {text:"He be happy", isCorrect:false}], rationale: "He + is."},
                {q: "Complete a frase: 'We ____ students.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"are", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "We + are."},
                {q: "Escolha a frase correta:", options: [{text:"I is Brazilian", isCorrect:false}, {text:"I are Brazilian", isCorrect:false}, {text:"I am Brazilian", isCorrect:true}, {text:"I be Brazilian", isCorrect:false}], rationale: "I + am."},
                {q: "Complete a pergunta: '____ you married?'", options: [{text:"am", isCorrect:false}, {text:"is", isCorrect:false}, {text:"are", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "You + are."},
                {q: "Escolha a resposta correta: — Are they friends?", options: [{text:"Yes, they is", isCorrect:false}, {text:"Yes, they are", isCorrect:true}, {text:"Yes, they am", isCorrect:false}, {text:"Yes, they be", isCorrect:false}], rationale: "They + are."},
                {q: "Escolha a forma negativa correta: 'She ____ happy.'", options: [{text:"isn't", isCorrect:true}, {text:"aren't", isCorrect:false}, {text:"am not", isCorrect:false}, {text:"don't", isCorrect:false}], rationale: "She + isn't (is not)."},
                {q: "Escolha a frase correta:", options: [{text:"We is ready", isCorrect:false}, {text:"We am ready", isCorrect:false}, {text:"We are ready", isCorrect:true}, {text:"We be ready", isCorrect:false}], rationale: "We + are."},
                {q: "Complete a negativa: 'I ____ from Japan.'", options: [{text:"isn't", isCorrect:false}, {text:"aren't", isCorrect:false}, {text:"am not", isCorrect:true}, {text:"don't", isCorrect:false}], rationale: "I + am not."},
                {q: "Complete a pergunta: '____ she your sister?'", options: [{text:"Am", isCorrect:false}, {text:"Is", isCorrect:true}, {text:"Are", isCorrect:false}, {text:"Be", isCorrect:false}], rationale: "She + is -> Is she...?"},
                {q: "Escolha a resposta correta: — Is he a doctor?", options: [{text:"Yes, he are", isCorrect:false}, {text:"Yes, he is", isCorrect:true}, {text:"Yes, he am", isCorrect:false}, {text:"Yes, he do", isCorrect:false}], rationale: "He + is."},
                {q: "Complete: 'You ____ very smart.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"are", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "You + are."},
                {q: "Escolha a negativa correta: 'They ____ at school today.'", options: [{text:"isn't", isCorrect:false}, {text:"aren't", isCorrect:true}, {text:"am not", isCorrect:false}, {text:"doesn't", isCorrect:false}], rationale: "They + aren't (are not)."}
            ],
            12: [ // AULA 11: COUNTRIES AND NATIONALITIES (15 perguntas)
                {q: "Complete a pergunta: 'Where ____ you from?'", options: [{text:"is", isCorrect:false}, {text:"do", isCorrect:false}, {text:"are", isCorrect:true}, {text:"does", isCorrect:false}], rationale: "'Where are you from?' é a forma correta para perguntar de onde alguém é."},
                {q: "Escolha a resposta correta: — Where are you from?", options: [{text:"I from Brazil", isCorrect:false}, {text:"I am from Brazil", isCorrect:true}, {text:"I is from Brazil", isCorrect:false}, {text:"Me from Brazil", isCorrect:false}], rationale: "'I am from Brazil' usa o verb to be corretamente."},
                {q: "Complete: 'She is from Japan. She is ____.'", options: [{text:"Japanish", isCorrect:false}, {text:"Japanian", isCorrect:false}, {text:"Japanese", isCorrect:true}, {text:"Japanes", isCorrect:false}], rationale: "A nacionalidade do Japão é Japanese."},
                {q: "Qual é a nacionalidade de quem é da França?", options: [{text:"Franch", isCorrect:false}, {text:"French", isCorrect:true}, {text:"Francian", isCorrect:false}, {text:"Frenchy", isCorrect:false}], rationale: "France = French."},
                {q: "Complete: 'He is from Italy. He is ____.'", options: [{text:"Italish", isCorrect:false}, {text:"Italiano", isCorrect:false}, {text:"Italian", isCorrect:true}, {text:"Italyan", isCorrect:false}], rationale: "Italy = Italian."},
                {q: "Complete a frase: 'I live ____ Brazil.'", options: [{text:"on", isCorrect:false}, {text:"at", isCorrect:false}, {text:"in", isCorrect:true}, {text:"to", isCorrect:false}], rationale: "Usamos 'in' com países e cidades: I live in Brazil."},
                {q: "Escolha a frase correta:", options: [{text:"She live in Spain", isCorrect:false}, {text:"She lives in Spain", isCorrect:true}, {text:"She living in Spain", isCorrect:false}, {text:"She is live in Spain", isCorrect:false}], rationale: "'She lives' usa o verbo no presente simples com 's' para terceira pessoa."},
                {q: "Complete: 'They are from Germany. They are ____.'", options: [{text:"Germanish", isCorrect:false}, {text:"Germanic", isCorrect:false}, {text:"Germanian", isCorrect:false}, {text:"German", isCorrect:true}], rationale: "Germany = German."},
                {q: "Qual é a nacionalidade de quem é dos Estados Unidos?", options: [{text:"United Statian", isCorrect:false}, {text:"American", isCorrect:true}, {text:"Statish", isCorrect:false}, {text:"US", isCorrect:false}], rationale: "Quem é dos Estados Unidos (USA) é American."},
                {q: "Complete: 'We ____ Brazilian. We live in Brazil.'", options: [{text:"is", isCorrect:false}, {text:"am", isCorrect:false}, {text:"are", isCorrect:true}, {text:"be", isCorrect:false}], rationale: "We + are."},
                {q: "Escolha a resposta correta: — Where does she live?", options: [{text:"She live in Portugal", isCorrect:false}, {text:"She lives in Portugal", isCorrect:true}, {text:"She living Portugal", isCorrect:false}, {text:"She is live Portugal", isCorrect:false}], rationale: "'She lives in Portugal' é a forma correta no presente simples."},
                {q: "Complete: 'He is from England. He is ____.'", options: [{text:"English", isCorrect:false}, {text:"Englandian", isCorrect:false}, {text:"British", isCorrect:true}, {text:"Englander", isCorrect:false}], rationale: "Quem é da Inglaterra (England) é British."},
                {q: "Escolha a pergunta correta para saber onde alguém mora:", options: [{text:"Where you live?", isCorrect:false}, {text:"Where do you live?", isCorrect:true}, {text:"Where are you live?", isCorrect:false}, {text:"Where is you live?", isCorrect:false}], rationale: "'Where do you live?' é a pergunta correta com o auxiliar 'do'."},
                {q: "Complete: 'I am ____. I am from China.'", options: [{text:"Chinish", isCorrect:false}, {text:"Chinian", isCorrect:false}, {text:"Chinese", isCorrect:true}, {text:"Chines", isCorrect:false}], rationale: "China = Chinese."},
                {q: "Escolha a frase correta sobre nacionalidade:", options: [{text:"He is Spanish. He is from Spain.", isCorrect:true}, {text:"He is Spain. He is from Spanish.", isCorrect:false}, {text:"He is Spainish. He is from Spain.", isCorrect:false}, {text:"He is Spanich. He is from Spain.", isCorrect:false}], rationale: "Spain = Spanish. O país é Spain e a nacionalidade é Spanish."}
            ],
            16: [ // CAN E CAN'T (15 perguntas)
                {q: "Complete a frase: 'I ____ speak English.'", options: [{text:"am", isCorrect:false}, {text:"do", isCorrect:false}, {text:"can", isCorrect:true}, {text:"have", isCorrect:false}], rationale: "Usamos 'can' para expressar habilidade: I can speak English."},
                {q: "Escolha a forma negativa correta: 'She ____ drive a car.'", options: [{text:"can not", isCorrect:false}, {text:"don't can", isCorrect:false}, {text:"can't", isCorrect:true}, {text:"doesn't can", isCorrect:false}], rationale: "A forma negativa de 'can' é 'can't' (cannot)."},
                {q: "Escolha a pergunta correta:", options: [{text:"Do you can swim?", isCorrect:false}, {text:"Can you swim?", isCorrect:true}, {text:"Are you can swim?", isCorrect:false}, {text:"You can swim?", isCorrect:false}], rationale: "Perguntas com 'can': Can + sujeito + verbo."},
                {q: "Complete: 'He ____ play the guitar very well.'", options: [{text:"cans", isCorrect:false}, {text:"can", isCorrect:true}, {text:"is can", isCorrect:false}, {text:"do can", isCorrect:false}], rationale: "'Can' nunca recebe -s, mesmo com he/she/it."},
                {q: "Escolha a resposta correta: — Can they cook?", options: [{text:"Yes, they can", isCorrect:true}, {text:"Yes, they do can", isCorrect:false}, {text:"Yes, they cans", isCorrect:false}, {text:"Yes, they are can", isCorrect:false}], rationale: "Resposta curta: Yes, they can."},
                {q: "Complete a frase: 'We ____ run very fast.'", options: [{text:"can't", isCorrect:true}, {text:"don't can", isCorrect:false}, {text:"aren't can", isCorrect:false}, {text:"not can", isCorrect:false}], rationale: "A negativa é 'can't' (cannot), nunca 'don't can'."},
                {q: "Qual frase está correta?", options: [{text:"She can to dance", isCorrect:false}, {text:"She can dances", isCorrect:false}, {text:"She can dance", isCorrect:true}, {text:"She cans dance", isCorrect:false}], rationale: "Depois de 'can' o verbo fica na forma base, sem 'to' e sem -s."},
                {q: "Complete: '____ he speak French?'", options: [{text:"Does", isCorrect:false}, {text:"Is", isCorrect:false}, {text:"Can", isCorrect:true}, {text:"Do", isCorrect:false}], rationale: "Perguntas sobre habilidade: Can + sujeito + verbo."},
                {q: "Escolha a frase correta:", options: [{text:"I can't to swim", isCorrect:false}, {text:"I can't swim", isCorrect:true}, {text:"I don't can swim", isCorrect:false}, {text:"I amn't can swim", isCorrect:false}], rationale: "Can't + verbo na forma base, sem 'to'."},
                {q: "Complete: 'My baby ____ walk yet.'", options: [{text:"don't can", isCorrect:false}, {text:"isn't can", isCorrect:false}, {text:"can't", isCorrect:true}, {text:"not can", isCorrect:false}], rationale: "A negativa correta é 'can't'."},
                {q: "Escolha a resposta correta: — Can you play soccer?", options: [{text:"No, I don't can", isCorrect:false}, {text:"No, I can't", isCorrect:true}, {text:"No, I am not can", isCorrect:false}, {text:"No, I not can", isCorrect:false}], rationale: "Resposta negativa curta: No, I can't."},
                {q: "Complete: 'She ____ sing beautifully.'", options: [{text:"can", isCorrect:true}, {text:"cans", isCorrect:false}, {text:"is can", isCorrect:false}, {text:"does can", isCorrect:false}], rationale: "'Can' é igual para todos os sujeitos, nunca 'cans'."},
                {q: "Qual é a diferença entre 'can' e 'can't'?", options: [{text:"Can = não consigo / Can't = consigo", isCorrect:false}, {text:"Can = consigo / Can't = não consigo", isCorrect:true}, {text:"São iguais", isCorrect:false}, {text:"Can't é mais formal que can", isCorrect:false}], rationale: "Can = habilidade positiva, Can't = habilidade negativa."},
                {q: "Escolha a frase correta:", options: [{text:"They can plays tennis", isCorrect:false}, {text:"They can play tennis", isCorrect:true}, {text:"They cans play tennis", isCorrect:false}, {text:"They can to play tennis", isCorrect:false}], rationale: "Can + verbo na forma base, sem -s e sem 'to'."},
                {q: "Complete: 'My grandmother ____ use the computer.'", options: [{text:"can't", isCorrect:true}, {text:"don't can", isCorrect:false}, {text:"isn't can", isCorrect:false}, {text:"doesn't can", isCorrect:false}], rationale: "A negativa de 'can' é sempre 'can't', nunca com 'do/does/is'."}
            ],
            24: [ // POSSESSIVE ADJECTIVES (15 perguntas)
                {q: "Complete: '____ name is Daniela.' (eu)", options: [{text:"I", isCorrect:false}, {text:"Me", isCorrect:false}, {text:"My", isCorrect:true}, {text:"Mine", isCorrect:false}], rationale: "My = meu/minha (adjetivo possessivo). Vem antes do substantivo."},
                {q: "Complete: 'What is ____ name?' (você)", options: [{text:"you", isCorrect:false}, {text:"your", isCorrect:true}, {text:"yours", isCorrect:false}, {text:"you're", isCorrect:false}], rationale: "Your = seu/sua. Adjetivo possessivo sempre vem antes do substantivo."},
                {q: "Complete: '____ car is very fast.' (dele)", options: [{text:"He", isCorrect:false}, {text:"Him", isCorrect:false}, {text:"His", isCorrect:true}, {text:"He's", isCorrect:false}], rationale: "His = dele. Adjetivo possessivo de 'he'."},
                {q: "Complete: '____ dress is beautiful.' (dela)", options: [{text:"She", isCorrect:false}, {text:"Her", isCorrect:true}, {text:"Hers", isCorrect:false}, {text:"She's", isCorrect:false}], rationale: "Her = dela. Adjetivo possessivo de 'she'."},
                {q: "Complete: '____ house is big.' (nosso)", options: [{text:"We", isCorrect:false}, {text:"Us", isCorrect:false}, {text:"Our", isCorrect:true}, {text:"Ours", isCorrect:false}], rationale: "Our = nosso/nossa. Adjetivo possessivo de 'we'."},
                {q: "Complete: '____ dog is very friendly.' (deles)", options: [{text:"They", isCorrect:false}, {text:"Them", isCorrect:false}, {text:"Their", isCorrect:true}, {text:"Theirs", isCorrect:false}], rationale: "Their = deles/delas. Adjetivo possessivo de 'they'."},
                {q: "Complete: 'The cat is eating ____ food.' (dele - do gato)", options: [{text:"it", isCorrect:false}, {text:"its", isCorrect:true}, {text:"it's", isCorrect:false}, {text:"his", isCorrect:false}], rationale: "Its = dele/dela (para coisas e animais). Cuidado: it's = it is."},
                {q: "Qual é a diferença entre 'your' e 'you're'?", options: [{text:"São iguais", isCorrect:false}, {text:"'Your' = possessivo, 'you're' = you are", isCorrect:true}, {text:"'You're' é mais informal", isCorrect:false}, {text:"'Your' é para plural", isCorrect:false}], rationale: "Your = seu (possessivo). You're = you are (contração)."},
                {q: "Escolha a frase correta:", options: [{text:"She loves she dog", isCorrect:false}, {text:"She loves hers dog", isCorrect:false}, {text:"She loves her dog", isCorrect:true}, {text:"She loves she's dog", isCorrect:false}], rationale: "Her + substantivo = adjetivo possessivo. 'She loves her dog.'"},
                {q: "Complete: 'I forgot ____ keys at home.' (meu)", options: [{text:"mine", isCorrect:false}, {text:"me", isCorrect:false}, {text:"my", isCorrect:true}, {text:"I", isCorrect:false}], rationale: "My + substantivo = adjetivo possessivo antes do nome."},
                {q: "Complete: 'They love ____ children very much.' (deles)", options: [{text:"them", isCorrect:false}, {text:"theirs", isCorrect:false}, {text:"their", isCorrect:true}, {text:"they", isCorrect:false}], rationale: "Their + substantivo = adjetivo possessivo."},
                {q: "Qual é a diferença entre 'its' e 'it's'?", options: [{text:"São iguais", isCorrect:false}, {text:"'Its' = possessivo, 'it's' = it is", isCorrect:true}, {text:"'It's' é possessivo", isCorrect:false}, {text:"'Its' é contração", isCorrect:false}], rationale: "Its = dele/dela (possessivo). It's = it is (contração)."},
                {q: "Complete: 'He always does ____ homework.' (dele)", options: [{text:"him", isCorrect:false}, {text:"he", isCorrect:false}, {text:"his", isCorrect:true}, {text:"he's", isCorrect:false}], rationale: "His + substantivo = adjetivo possessivo de 'he'."},
                {q: "Escolha a frase correta:", options: [{text:"We like we teacher", isCorrect:false}, {text:"We like ours teacher", isCorrect:false}, {text:"We like our teacher", isCorrect:true}, {text:"We like us teacher", isCorrect:false}], rationale: "Our + substantivo = adjetivo possessivo. 'We like our teacher.'"},
                {q: "Complete: 'Is this ____ phone?' (você)", options: [{text:"you", isCorrect:false}, {text:"yours", isCorrect:false}, {text:"your", isCorrect:true}, {text:"you're", isCorrect:false}], rationale: "Your + substantivo = adjetivo possessivo. 'Is this your phone?'"}
            ],
            25: [ // POSSESSIVE PRONOUNS (15 perguntas)
                {q: "Complete: 'This book is ____.' (eu)", options: [{text:"my", isCorrect:false}, {text:"me", isCorrect:false}, {text:"mine", isCorrect:true}, {text:"I", isCorrect:false}], rationale: "Mine = meu/minha (pronome possessivo, substitui 'my + noun')."},
                {q: "Escolha a frase correta:", options: [{text:"This car is your", isCorrect:false}, {text:"This car is yours", isCorrect:true}, {text:"This car is you", isCorrect:false}, {text:"This car is your's", isCorrect:false}], rationale: "Yours = seu/sua (pronome possessivo). Nunca leva apóstrofo."},
                {q: "Complete: 'That phone is ____.' (dele)", options: [{text:"him", isCorrect:false}, {text:"he", isCorrect:false}, {text:"his", isCorrect:true}, {text:"her", isCorrect:false}], rationale: "His = dele (pronome possessivo). 'His' serve como adjetivo e pronome."},
                {q: "Complete: 'The bag is ____.' (dela)", options: [{text:"she", isCorrect:false}, {text:"her", isCorrect:false}, {text:"hers", isCorrect:true}, {text:"she's", isCorrect:false}], rationale: "Hers = dela (pronome possessivo). 'Her' é adjetivo, 'hers' é pronome."},
                {q: "Complete: 'This house is ____.' (nosso)", options: [{text:"our", isCorrect:false}, {text:"ours", isCorrect:true}, {text:"us", isCorrect:false}, {text:"we", isCorrect:false}], rationale: "Ours = nosso/nossa (pronome possessivo). 'Our' é adjetivo possessivo."},
                {q: "Complete: 'Those seats are ____.' (deles)", options: [{text:"them", isCorrect:false}, {text:"their", isCorrect:false}, {text:"theirs", isCorrect:true}, {text:"they", isCorrect:false}], rationale: "Theirs = deles/delas (pronome possessivo). 'Their' é adjetivo."},
                {q: "Qual é a diferença entre 'my' e 'mine'?", options: [{text:"São iguais", isCorrect:false}, {text:"'My' vem antes do substantivo, 'mine' substitui o substantivo", isCorrect:true}, {text:"'Mine' é mais formal", isCorrect:false}, {text:"'My' é para objetos, 'mine' é para pessoas", isCorrect:false}], rationale: "My book (adjetivo + substantivo) = The book is mine (pronome sozinho)."},
                {q: "Escolha a frase correta:", options: [{text:"Is this pen your or mine?", isCorrect:false}, {text:"Is this pen yours or mine?", isCorrect:true}, {text:"Is this pen your's or my?", isCorrect:false}, {text:"Is this pen you or my?", isCorrect:false}], rationale: "Yours e mine são pronomes possessivos que substituem 'your pen' e 'my pen'."},
                {q: "Complete: 'Her dress is blue. ____ is red.' (meu)", options: [{text:"My", isCorrect:false}, {text:"Mine", isCorrect:true}, {text:"Me", isCorrect:false}, {text:"I", isCorrect:false}], rationale: "Mine substitui 'my dress': Mine is red = My dress is red."},
                {q: "Escolha a alternativa correta:", options: [{text:"A friend of mine", isCorrect:true}, {text:"A friend of my", isCorrect:false}, {text:"A friend of me", isCorrect:false}, {text:"A friend of I", isCorrect:false}], rationale: "'A friend of mine' é a expressão correta (um amigo meu)."},
                {q: "Complete: 'I have my keys. Do you have ____?'", options: [{text:"your", isCorrect:false}, {text:"yours", isCorrect:true}, {text:"you", isCorrect:false}, {text:"your's", isCorrect:false}], rationale: "Yours substitui 'your keys'. Pronomes possessivos nunca levam apóstrofo."},
                {q: "Complete: 'Our car is white. ____ is black.' (deles)", options: [{text:"Their", isCorrect:false}, {text:"Theirs", isCorrect:true}, {text:"Them", isCorrect:false}, {text:"They", isCorrect:false}], rationale: "Theirs substitui 'their car': Theirs is black."},
                {q: "Qual frase está correta?", options: [{text:"The dog is their's", isCorrect:false}, {text:"The dog is theirs", isCorrect:true}, {text:"The dog is them", isCorrect:false}, {text:"The dog is they", isCorrect:false}], rationale: "Theirs nunca leva apóstrofo. Pronomes possessivos não usam apóstrofo."},
                {q: "Complete: 'His bike is new. ____ is old.' (dela)", options: [{text:"Her", isCorrect:false}, {text:"Hers", isCorrect:true}, {text:"She", isCorrect:false}, {text:"She's", isCorrect:false}], rationale: "Hers substitui 'her bike': Hers is old."},
                {q: "Escolha a frase correta:", options: [{text:"This laptop is our", isCorrect:false}, {text:"This laptop is us", isCorrect:false}, {text:"This laptop is we", isCorrect:false}, {text:"This laptop is ours", isCorrect:true}], rationale: "Ours = nosso (pronome possessivo que substitui 'our laptop')."}
            ]
        };

        // Fallback generator for other modules to ensure 10 questions exist
        function shuffleArray(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function getQuizDataForModule(id) {
            const activeQuiz = getActiveQuizData();
            if (activeQuiz[id]) {
                const shuffled = shuffleArray(activeQuiz[id]);
                return shuffled.slice(0, 10);
            }

            const generic = [];
            for(let i=0; i<10; i++) {
                generic.push({
                    q: `Qual a opção correta?`,
                    options: [
                        {text: "Opção Correta", isCorrect: true},
                        {text: "Opção Errada 1", isCorrect: false},
                        {text: "Opção Errada 2", isCorrect: false},
                        {text: "Opção Errada 3", isCorrect: false}
                    ],
                    rationale: "Esta é uma pergunta de treino gerada para completar o exercício."
                });
            }
            return generic;
        }

        let currentQuestion = null;
        let questionsPool = [];
        let answerSubmitted = false;
        let currentFlashcardIdx = 0;
        let currentShuffledCards = [];
        let currentShuffledData = []; 
        let currentIdx = 0; 
        let scrambleResult = [];

        // Web Speech API - sempre em inglês independente do idioma do dispositivo
        let cachedEnglishVoice = null;
        function loadEnglishVoice() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                cachedEnglishVoice = voices.find(v => v.lang === 'en-US') 
                    || voices.find(v => v.lang === 'en-GB')
                    || voices.find(v => v.lang.startsWith('en-'))
                    || voices.find(v => v.lang.startsWith('en'));
            }
        }
        if ('speechSynthesis' in window) {
            loadEnglishVoice();
            window.speechSynthesis.onvoiceschanged = () => loadEnglishVoice();
        }

        function speakText(text) {
            return new Promise((resolve) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    let processedText = text;
                    if (text === "I") {
                        processedText = "i";
                    }
                    const utterance = new SpeechSynthesisUtterance(processedText);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    
                    if (!cachedEnglishVoice) loadEnglishVoice();
                    if (cachedEnglishVoice) {
                        utterance.voice = cachedEnglishVoice;
                    }
                    
                    utterance.onend = () => resolve();
                    utterance.onerror = () => resolve();
                    window.speechSynthesis.speak(utterance);
                } else {
                    resolve();
                }
            });
        }

        async function fetchTTSAudio(text) {
            // Retorna um objeto compatível com a interface esperada
            return {
                play: () => speakText(text),
                pause: () => window.speechSynthesis.cancel()
            };
        }

        window.showDashboard = function() {
            if (wsTimer) { clearInterval(wsTimer); wsTimer = null; }
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('generator-view').classList.add('hidden');
            document.getElementById('study-view').classList.add('hidden');
            renderDashboard();
        };

        window.scrollToModule = function(id) {
            const el = document.getElementById(`module-${id}`);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        window.filterModules = function(query) {
            const cards = document.querySelectorAll('#level-cards-container > div');
            const normalizedQuery = query.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            cards.forEach(card => {
                const title = card.querySelector('.font-bold')?.textContent || '';
                const normalizedTitle = title.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                if (normalizedTitle.includes(normalizedQuery) || normalizedQuery === '') {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function syncChunksStreaks() {
            if (!firebaseDb || !currentUser) return;
            var activeChunks = getActiveChunks();
            for (const aulaIdStr of Object.keys(activeChunks)) {
                const aulaId = parseInt(aulaIdStr);
                if (isStreakDone(aulaId, 'chunks')) continue;
                try {
                    var docId = currentLevel + '_' + aulaId;
                    const doc = await firebaseDb.collection('users').doc(currentUser.uid).collection('chunksAnswers').doc(docId).get();
                    if (doc.exists) {
                        const saved = doc.data() || {};
                        const total = activeChunks[aulaId].length;
                        if (Object.keys(saved).length >= total) {
                            await markStreakDone(aulaId, 'chunks');
                            renderDashboard();
                        }
                    }
                } catch(e) {}
            }
        }

        function renderDashboard() {
            const container = document.getElementById('level-cards-container');
            const activeAulas = getActiveAulas();
            const activeQuiz = getActiveQuizData();
            const levelTag = getLevelTag();
            container.innerHTML = activeAulas.map(aula => {
                let studyLabel = '';
                if (aula.specialMode === 'flashcards') studyLabel = 'FLASHCARDS';
                else if (aula.specialMode === 'listening') studyLabel = 'LISTENING';
                else if (aula.specialMode === 'chunks') studyLabel = 'CHUNKS';
                else if (aula.specialMode === 'mistake') studyLabel = 'DETETIVE';
                else if (aula.specialMode === 'scramble') studyLabel = 'UNSCRAMBLE';

                const isS1 = currentLevel === 'starter1';
                const sBtn = studyLabel ? `<button class="secondary-button-sm" onclick="openStudy(${aula.id})">${studyLabel}</button>` : '';
                const tBtn = (isS1 && aula.id === 23) ? `<button class="secondary-button-sm" onclick="openFlashcards(23)">FLASHCARDS</button>` : '';
                const dBtn = (aula.thirdBtn === 'dictation') ? `<button class="secondary-button-sm" onclick="openDictation(${aula.id})">DITADO</button>` : '';
                const chBtn = (aula.thirdBtn === 'chunks') ? `<button class="secondary-button-sm" onclick="openChunksThird(${aula.id})">CHUNKS</button>` : '';
                const hBtn = ((isS1 && [6, 23, 26].includes(aula.id)) || aula.thirdBtn === 'hangman') ? `<button class="secondary-button-sm" onclick="openHangman(${aula.id})">FORCA</button>` : '';
                const cBtn = (isS1 && [12, 14].includes(aula.id)) ? `<button class="secondary-button-sm" onclick="openWordSearch(${aula.id})">CAÇA-PALAVRAS</button>` : '';

                let allStreaks = [];
                if (aula.hasHomework && activeQuiz[aula.id]) allStreaks.push({ label: 'Homework', done: isStreakDone(aula.id, 'homework') });
                if (aula.specialMode === 'chunks') allStreaks.push({ label: 'Chunks', done: isStreakDone(aula.id, 'chunks') });
                if (aula.specialMode === 'scramble') allStreaks.push({ label: 'Unscramble', done: isStreakDone(aula.id, 'scramble') });
                if (aula.specialMode === 'mistake') allStreaks.push({ label: 'Detetive', done: isStreakDone(aula.id, 'mistake') });
                if (aula.thirdBtn === 'dictation') allStreaks.push({ label: 'Ditado', done: isStreakDone(aula.id, 'dictation') });
                if (aula.thirdBtn === 'chunks') allStreaks.push({ label: 'Chunks', done: isStreakDone(aula.id, 'chunks') });
                if ((isS1 && [6, 23, 26].includes(aula.id)) || aula.thirdBtn === 'hangman') allStreaks.push({ label: 'Forca', done: isStreakDone(aula.id, 'hangman') });
                if (isS1 && [12, 14].includes(aula.id)) allStreaks.push({ label: 'Caça-Palavras', done: isStreakDone(aula.id, 'wordsearch') });
                const streakHtml = allStreaks.length > 0 ? `<div style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.5rem;">${allStreaks.map(s => s.done
                    ? `<span style="font-size: 0.6rem; font-weight: 700; color: #16a34a; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 0.1rem 0.4rem; border-radius: 1rem; display: inline-flex; align-items: center; gap: 0.2rem;" data-testid="streak-done-${s.label}"><svg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='#16a34a' stroke-width='3'><polyline points='20 6 9 17 4 12'/></svg> ${s.label}</span>`
                    : `<span style="font-size: 0.6rem; font-weight: 700; color: #dc2626; background: #fef2f2; border: 1px solid #fecaca; padding: 0.1rem 0.4rem; border-radius: 1rem; display: inline-flex; align-items: center; gap: 0.2rem;" data-testid="streak-pending-${s.label}"><svg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='#dc2626' stroke-width='2'><circle cx='12' cy='12' r='10'/><line x1='15' y1='9' x2='9' y2='15'/><line x1='9' y1='9' x2='15' y2='15'/></svg> ${s.label}</span>`
                ).join('')}</div>` : '';

                return `
                <div class="level-card relative ${!aula.hasHomework ? 'locked' : ''}" id="module-${aula.id}">
                    ${!aula.hasHomework ? `
                        <div class="lock-overlay">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        </div>
                    ` : `<img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1760657894/SLAP_ICON_PRETO_2_2_tv8bmp.png" alt="Logo" class="absolute top-4 right-4 w-8 h-8 opacity-10">`}
                    <div>
                        <span class="module-tag">${levelTag} - HW AULA ${String(aula.id).padStart(2, '0')}</span>
                        <h3 class="text-xl font-bold text-stone-800 mb-2 mt-2">${aula.name}</h3>
                        <p class="text-stone-500 text-sm mb-3">${aula.desc}</p>
                        ${streakHtml}
                    </div>
                    <div class="flex flex-wrap gap-1.5">
                        ${sBtn} ${tBtn} ${dBtn} ${chBtn} ${hBtn} ${cBtn}
                        <button class="action-button-sm uppercase" ${(!aula.hasHomework || !activeQuiz[aula.id]) ? 'disabled' : `onclick="openPractice(${aula.id})"`}>HOMEWORK</button>
                    </div>
                </div>`
            }).join('');
        }

        window.openPractice = function(id) {
            currentAulaId = id; 
            currentStudyMode = 'homework';
            questionsPool = shuffle([...getQuizDataForModule(id)]);
            const aula = getActiveAulas().find(a => a.id === id);
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('generator-view').classList.remove('hidden');
            document.getElementById('current-hw-display').textContent = "Homework: " + aula.name;
            quizStreak = 0; renderQuizStreak(); loadNextQuestion();
        };

        window.loadNextQuestion = function() {
            if (quizStreak >= STREAK_GOAL) {
                markStreakDone(currentAulaId, 'homework');
                document.getElementById('main-question').innerHTML = `<div class="text-center py-4"><div class="text-6xl mb-4">📸</div><h2 class="text-2xl font-bold">Missão Cumprida!</h2><p class="text-stone-500">Tire um print para o seu Teacher!</p></div>`;
                document.getElementById('options-container').innerHTML = `<button class="action-button" onclick="showDashboard()">Voltar</button>`;
                document.getElementById('rationale-display').classList.add('hidden');
                document.getElementById('feedback-alert').classList.add('hidden');
                document.getElementById('next-btn-container').classList.add('hidden');
                return;
            }

            if (questionsPool.length === 0) {
                 questionsPool = shuffle([...getQuizDataForModule(currentAulaId)]); 
            }

            currentQuestion = questionsPool.pop();

            document.getElementById('main-question').textContent = currentQuestion.q;
            document.getElementById('rationale-display').classList.add('hidden');
            document.getElementById('feedback-alert').classList.add('hidden');
            document.getElementById('next-btn-container').classList.add('hidden');
            answerSubmitted = false;

            const container = document.getElementById('options-container');
            container.innerHTML = currentQuestion.options.map((opt, i) => 
                `<button class="option-button w-full border-2 border-slate-200 p-4 rounded-xl font-bold text-left hover:border-yellow-400 transition-all flex items-center" onclick="submitAnswer(${idxToBool(opt.isCorrect)}, ${i}, '${(currentQuestion.rationale || "").replace(/'/g, "\\'")}')">
                    <span class="w-8 h-8 rounded-full bg-yellow-50 text-amber-700 flex items-center justify-center font-bold mr-3 flex-shrink-0 text-sm border border-yellow-300">${String.fromCharCode(65+i)}</span>
                    <span>${opt.text}</span>
                </button>`
            ).join('');
        };

        function idxToBool(val) { return val ? 'true' : 'false'; } 

        window.submitAnswer = function(correct, idx, rationale) {
            if (answerSubmitted) return;
            answerSubmitted = true;
            const alert = document.getElementById('feedback-alert');

            if (correct) {
                playCorrectSound();
                quizStreak++;
                document.getElementById('rationale-content').textContent = rationale;
                document.getElementById('rationale-display').classList.remove('hidden');
            } else {
                playIncorrectSound();
                quizStreak = 0;
                document.getElementById('rationale-display').classList.add('hidden');
            }
            alert.classList.add('hidden');
            document.getElementById('next-btn-container').classList.remove('hidden');
            renderQuizStreak();

            document.querySelectorAll('.option-button').forEach((btn, i) => {
                btn.disabled = true;
                if (i === idx) {
                   if(correct) btn.classList.add('bg-green-50', 'border-green-400');
                   else btn.classList.add('bg-red-50', 'border-red-400');
                }
            });
        };

        function renderQuizStreak() {
            const progress = Math.min(quizStreak, STREAK_GOAL);
            const percentage = (progress / STREAK_GOAL) * 100;
            const isComplete = quizStreak >= STREAK_GOAL;
            document.getElementById('quiz-streak-bar').innerHTML = `
                <div class="streak-bar-wrapper">
                    <div class="streak-label text-center">
                        ${isComplete ? '<svg class="inline w-5 h-5 mr-1 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Streak completo! Tire um print!' : `Complete ${STREAK_GOAL} acertos seguidos: ${progress}/${STREAK_GOAL}`}
                    </div>
                    <div class="streak-bar-bg">
                        <div class="streak-bar-fill" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        }

        window.openStudy = function(id) {
            const aula = getActiveAulas().find(a => a.id === id);
            currentAulaId = id;
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('study-view').classList.remove('hidden');
            const titleArea = document.getElementById('study-title');
            const instrArea = document.getElementById('study-instruction');
            const contentArea = document.getElementById('study-content-area');
            const statusArea = document.getElementById('preloading-status');

            titleArea.textContent = aula.name;
            statusArea.textContent = "";
            currentIdx = 0;
            currentStreak = 0;
            renderStreakBar();

            if (aula.specialMode === 'flashcards') {
                currentStudyMode = 'flashcards';
                instrArea.textContent = "";
                currentFlashcardIdx = 0; 
                currentShuffledCards = shuffle([...getActiveFlashcards()[id]]); 
                renderFlashcards();
            } else if (aula.specialMode === 'listening') {
                currentStudyMode = 'listening';
                instrArea.textContent = "";
                const useWideGrid = [5, 7, 23, 24].includes(id);
                renderListeningBoard(aula.items, useWideGrid);
            } else if (aula.specialMode === 'chunks') {
                currentStudyMode = 'chunks';
                titleArea.textContent = "CHUNKS OF LANGUAGE";
                instrArea.textContent = "";
                renderChunksGrid(getActiveChunks()[id]);
            } else if (aula.specialMode === 'mistake') {
                currentStudyMode = 'mistake';
                instrArea.textContent = "";
                currentShuffledData = shuffle([...gamesData[id]]);
                renderMistake();
            } else if (aula.specialMode === 'scramble') {
                currentStudyMode = 'scramble';
                instrArea.textContent = "";
                currentShuffledData = shuffle([...gamesData[id]]);
                renderScramble();
            }
        };

        window.openFlashcards = function(id) {
            const aula = getActiveAulas().find(a => a.id === id);
            currentStudyMode = 'flashcards';
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('study-view').classList.remove('hidden');
            document.getElementById('study-title').textContent = "Flashcards: Holidays";
            document.getElementById('study-instruction').textContent = "";
            currentFlashcardIdx = 0; currentShuffledCards = shuffle([...getActiveFlashcards()[id]]); renderFlashcards();
        }

        window.openChunksThird = function(id) {
            const aula = getActiveAulas().find(a => a.id === id);
            currentAulaId = id;
            currentStudyMode = 'chunks';
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('study-view').classList.remove('hidden');
            document.getElementById('study-title').textContent = "CHUNKS OF LANGUAGE";
            document.getElementById('study-instruction').textContent = "";
            renderChunksGrid(getActiveChunks()[id]);
        };

        let isSpellingMode = false;
        let isNumberComboMode = false;
        window.openDictation = function(id) {
             const aula = getActiveAulas().find(a => a.id === id);
             currentAulaId = id;
             currentStudyMode = 'dictation';
             isSpellingMode = gamesData[id].isSpelling || false;
             isNumberComboMode = gamesData[id].isNumberCombo || false;
             document.getElementById('main-header').classList.add('hidden');
             document.getElementById('dashboard-view').classList.add('hidden');
             document.getElementById('study-view').classList.remove('hidden');
             document.getElementById('study-title').textContent = "Ditado";
             document.getElementById('study-instruction').textContent = "";
             currentShuffledData = shuffle([...gamesData[id].dictation]);
             currentIdx = 0;
             currentStreak = 0; // Reset Streak
             renderStreakBar(); // Initial render
             renderDictation();
        }

        // HANGMAN GAME
        const hangmanWordLists = {
            6: [ // Spelling - 10 palavras
                {word: "CAR", hint: "Veículo com 4 rodas"},
                {word: "DOG", hint: "Melhor amigo do homem"},
                {word: "CAT", hint: "Animal que mia"},
                {word: "BUS", hint: "Transporte público"},
                {word: "SUN", hint: "Estrela que ilumina o dia"},
                {word: "HAT", hint: "Acessório para a cabeça"},
                {word: "PEN", hint: "Usamos para escrever"},
                {word: "RED", hint: "Cor do coração"},
                {word: "BOX", hint: "Caixa em inglês"},
                {word: "CUP", hint: "Usamos para beber café"}
            ],
            23: [ // Months and Holidays - 10 palavras
                {word: "JANUARY", hint: "Primeiro mês do ano"},
                {word: "FEBRUARY", hint: "Mês do carnaval"},
                {word: "MARCH", hint: "Terceiro mês do ano"},
                {word: "APRIL", hint: "Mês da Páscoa"},
                {word: "MAY", hint: "Mês das mães"},
                {word: "JUNE", hint: "Mês das festas juninas"},
                {word: "JULY", hint: "Mês das férias de inverno"},
                {word: "AUGUST", hint: "Mês dos pais"},
                {word: "CHRISTMAS", hint: "Feriado em 25 de dezembro"},
                {word: "EASTER", hint: "Feriado do coelhinho"}
            ],
            24: [ // Movie Genres - Nomes de filmes famosos
                {word: "TITANIC", hint: "Filme sobre um navio que afundou"},
                {word: "FROZEN", hint: "Animação da Disney com a Elsa"},
                {word: "AVATAR", hint: "Filme com aliens azuis em Pandora"},
                {word: "BATMAN", hint: "Super-herói que vive em Gotham"},
                {word: "SHREK", hint: "Ogro verde que vive no pântano"},
                {word: "MOANA", hint: "Princesa da Disney que navega o oceano"},
                {word: "ROCKY", hint: "Filme de boxe com Stallone"},
                {word: "COCO", hint: "Animação sobre o Dia dos Mortos no México"},
                {word: "JAWS", hint: "Filme clássico sobre um tubarão"},
                {word: "UP", hint: "Animação da Pixar com uma casa voando com balões"}
            ],
            26: [ // Foods and Fruits - 10 palavras
                {word: "APPLE", hint: "Fruta vermelha ou verde"},
                {word: "BANANA", hint: "Fruta amarela e comprida"},
                {word: "ORANGE", hint: "Fruta cítrica laranja"},
                {word: "GRAPE", hint: "Fruta pequena usada para vinho"},
                {word: "LEMON", hint: "Fruta azeda e amarela"},
                {word: "BREAD", hint: "Alimento feito de farinha"},
                {word: "CHEESE", hint: "Derivado do leite"},
                {word: "RICE", hint: "Grão branco do almoço"},
                {word: "PIZZA", hint: "Comida italiana redonda"},
                {word: "JUICE", hint: "Bebida de frutas"}
            ]
        };
        let currentHangmanList = [];
        let hangmanWord = "";
        let hangmanHint = "";
        let hangmanGuessed = [];
        let hangmanWrong = 0;
        const hangmanMaxWrong = 6;

        window.openHangman = function(moduleId) {
            currentAulaId = moduleId;
            currentStudyMode = 'hangman';
            currentHangmanList = hangmanWordLists[moduleId] || hangmanWordLists[6];
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('study-view').classList.remove('hidden');
            document.getElementById('study-title').textContent = "Forca";
            document.getElementById('study-instruction').textContent = "";
            currentStreak = 0;
            renderStreakBar();
            startNewHangman();
        }

        function startNewHangman() {
            const item = currentHangmanList[Math.floor(Math.random() * currentHangmanList.length)];
            hangmanWord = item.word;
            hangmanHint = item.hint;
            hangmanGuessed = [];
            hangmanWrong = 0;
            renderHangman();
        }

        function renderHangman() {
            const area = document.getElementById('study-content-area');
            renderStreakBar();

            if (currentStreak >= HANGMAN_STREAK_GOAL) {
                markStreakDone(currentAulaId, 'hangman');
                area.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10">
                        <div class="mb-4"><svg class="w-20 h-20 mx-auto text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h14a2 2 0 0 1 2 2v2a5 5 0 0 1-4.4 4.96 5.5 5.5 0 0 1-5.1 3.04 5.5 5.5 0 0 1-5.1-3.04A5 5 0 0 1 3 7V5a2 2 0 0 1 2-2zm0 2v2a3 3 0 0 0 2.1 2.86 5.48 5.48 0 0 1-.1-1.14V7a1 1 0 1 1 2 0v1.72c0 1.28.56 2.43 1.47 3.22A3.5 3.5 0 0 0 12 9.72V7a1 1 0 1 1 2 0v2.72a3.5 3.5 0 0 0 1.53 2.22A3.48 3.48 0 0 0 17 8.72V7a1 1 0 1 1 2 0v1.72c0 .39-.03.77-.1 1.14A3 3 0 0 0 21 7V5H5zm2 14h10v2H7v-2zm1-3h8a1 1 0 0 1 1 1v1H7v-1a1 1 0 0 1 1-1z"/></svg></div>
                        <h2 class="text-3xl font-bold text-stone-800 mb-2">Missão Cumprida!</h2>
                        <p class="text-stone-500 mb-8">Você acertou ${HANGMAN_STREAK_GOAL} palavras seguidas na Forca!</p>
                        <button class="action-button px-8" onclick="showDashboard()">Voltar</button>
                        <button class="secondary-button mt-4" onclick="currentStreak=0; startNewHangman()">Jogar Novamente</button>
                    </div>`;
                return;
            }

            const wordDisplay = hangmanWord.split('').map(letter => 
                hangmanGuessed.includes(letter) ? letter : '_'
            ).join(' ');
            
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            const keyboard = alphabet.map(letter => {
                const used = hangmanGuessed.includes(letter);
                const isWrong = used && !hangmanWord.includes(letter);
                const isCorrect = used && hangmanWord.includes(letter);
                return `<button 
                    class="w-9 h-9 m-0.5 rounded-lg font-bold text-sm transition ${used ? (isCorrect ? 'bg-green-500 text-white' : 'bg-red-400 text-white opacity-50') : 'bg-white border-2 border-stone-200 hover:border-primary hover:bg-primary/5'}"
                    ${used ? 'disabled' : `onclick="guessLetter('${letter}')"`}
                >${letter}</button>`;
            }).join('');

            area.innerHTML = `
                <div class="flex flex-col sm:flex-row items-center sm:items-start justify-center gap-4 sm:gap-8">
                    <div class="flex flex-col items-center gap-3">
                        <svg width="160" height="160" viewBox="0 0 200 200" class="bg-white rounded-xl p-3">
                            <line x1="40" y1="180" x2="160" y2="180" stroke="#44403c" stroke-width="4"/>
                            <line x1="60" y1="180" x2="60" y2="20" stroke="#44403c" stroke-width="4"/>
                            <line x1="60" y1="20" x2="120" y2="20" stroke="#44403c" stroke-width="4"/>
                            <line x1="120" y1="20" x2="120" y2="40" stroke="#44403c" stroke-width="4"/>
                            ${hangmanWrong >= 1 ? '<circle cx="120" cy="55" r="15" stroke="#8671d1" stroke-width="3" fill="none"/>' : ''}
                            ${hangmanWrong >= 2 ? '<line x1="120" y1="70" x2="120" y2="110" stroke="#8671d1" stroke-width="3"/>' : ''}
                            ${hangmanWrong >= 3 ? '<line x1="120" y1="80" x2="100" y2="100" stroke="#8671d1" stroke-width="3"/>' : ''}
                            ${hangmanWrong >= 4 ? '<line x1="120" y1="80" x2="140" y2="100" stroke="#8671d1" stroke-width="3"/>' : ''}
                            ${hangmanWrong >= 5 ? '<line x1="120" y1="110" x2="100" y2="140" stroke="#8671d1" stroke-width="3"/>' : ''}
                            ${hangmanWrong >= 6 ? '<line x1="120" y1="110" x2="140" y2="140" stroke="#8671d1" stroke-width="3"/>' : ''}
                        </svg>
                        <div class="text-3xl font-bold tracking-widest text-stone-800">${wordDisplay}</div>
                        <div class="bg-amber-100 text-amber-800 px-3 py-1.5 rounded-lg text-sm font-medium inline-flex items-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5C8.26 12.26 8.72 13.02 8.91 14"/></svg> ${hangmanHint}</div>
                        <div class="text-sm text-stone-500">Erros: ${hangmanWrong}/${hangmanMaxWrong}</div>
                    </div>
                    <div class="flex flex-col items-center gap-3">
                        <div class="grid grid-cols-7 gap-1">${keyboard}</div>
                        <div id="hangman-result"></div>
                    </div>
                </div>
            `;
        }

        window.guessLetter = function(letter) {
            if (hangmanGuessed.includes(letter)) return;
            if (hangmanWrong >= hangmanMaxWrong) return;
            hangmanGuessed.push(letter);
            
            // Ler a letra em voz alta
            speakText(letter.toLowerCase());

            if (!hangmanWord.includes(letter)) {
                hangmanWrong++;
            }

            renderHangman();

            const allRevealed = hangmanWord.split('').every(l => hangmanGuessed.includes(l));
            const resultDiv = document.getElementById('hangman-result');

            if (allRevealed) {
                currentStreak++;
                renderStreakBar();
                resultDiv.innerHTML = `<div class="text-green-600 font-bold text-lg mb-2">Parabéns! Você acertou!</div>
                    <button class="action-button" onclick="startNewHangman()">Próxima Palavra</button>`;
            } else if (hangmanWrong >= hangmanMaxWrong) {
                currentStreak = 0;
                renderStreakBar();
                resultDiv.innerHTML = `<div class="text-red-600 font-bold text-lg mb-2">Game Over! Tente outra palavra.</div>
                    <button class="action-button" onclick="startNewHangman()">Tentar Novamente</button>`;
            }
        }

        // WORD SEARCH GAME
        const wordSearchData = {
            12: [ // Countries
                { words: ["CHINA", "BRAZIL", "JAPAN", "MEXICO", "EGYPT"] },
                { words: ["INDIA", "ITALY", "SPAIN", "RUSSIA", "PERU"] },
                { words: ["ENGLAND", "GERMANY", "FRANCE", "CUBA", "IRAN"] }
            ],
            14: [ // Family Members
                { words: ["SON", "SISTER", "UNCLE", "AUNT", "DAD"] },
                { words: ["MOM", "BROTHER", "COUSIN", "WIFE", "BABY"] },
                { words: ["DAUGHTER", "GRANDMA", "HUSBAND", "NEPHEW", "MOTHER"] }
            ]
        };
        let currentWordSearchList = [];
        let currentWordSearch = null;
        let wordSearchStreak = 0;
        let wsGrid = [];
        let wsWords = [];
        let wsFoundWords = [];
        let wsSelectedCells = [];
        let wsIsSelecting = false;
        let wsTimer = null;
        let wsTimeLeft = 120;
        const WS_TIME_LIMIT = 120;

        function generateWordSearchGrid(words, size = 10) {
            const grid = Array(size).fill(null).map(() => Array(size).fill(''));
            const directions = [
                {dr: 0, dc: 1},   // right
                {dr: 1, dc: 0},   // down
                {dr: 0, dc: -1},  // left
                {dr: -1, dc: 0}   // up
            ];
            
            const shuffledWords = [...words].sort(() => Math.random() - 0.5);
            
            for (const word of shuffledWords) {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 100) {
                    const dir = directions[Math.floor(Math.random() * directions.length)];
                    const startR = Math.floor(Math.random() * size);
                    const startC = Math.floor(Math.random() * size);
                    
                    let canPlace = true;
                    const cells = [];
                    
                    for (let i = 0; i < word.length; i++) {
                        const r = startR + dir.dr * i;
                        const c = startC + dir.dc * i;
                        if (r < 0 || r >= size || c < 0 || c >= size) {
                            canPlace = false;
                            break;
                        }
                        if (grid[r][c] !== '' && grid[r][c] !== word[i]) {
                            canPlace = false;
                            break;
                        }
                        cells.push({r, c, letter: word[i]});
                    }
                    
                    if (canPlace) {
                        cells.forEach(cell => grid[cell.r][cell.c] = cell.letter);
                        placed = true;
                    }
                    attempts++;
                }
            }
            
            // Fill empty cells with random letters
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    if (grid[r][c] === '') {
                        grid[r][c] = letters[Math.floor(Math.random() * letters.length)];
                    }
                }
            }
            
            return grid;
        }

        let usedWordSearchIndices = [];

        window.openWordSearch = function(moduleId) {
            currentAulaId = moduleId;
            currentStudyMode = 'wordsearch';
            currentWordSearchList = wordSearchData[moduleId] || [];
            wordSearchStreak = 0;
            usedWordSearchIndices = [];
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('study-view').classList.remove('hidden');
            document.getElementById('study-title').textContent = "Caça-Palavras";
            document.getElementById('study-instruction').textContent = "";
            startNewWordSearch();
        }

        function startNewWordSearch() {
            if (wsTimer) clearInterval(wsTimer);
            
            // Get available indices (not used yet)
            let availableIndices = [];
            for (let i = 0; i < currentWordSearchList.length; i++) {
                if (!usedWordSearchIndices.includes(i)) availableIndices.push(i);
            }
            // If all used, reset the list
            if (availableIndices.length === 0) {
                usedWordSearchIndices = [];
                availableIndices = currentWordSearchList.map((_, i) => i);
            }
            
            const puzzleIdx = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            usedWordSearchIndices.push(puzzleIdx);
            currentWordSearch = currentWordSearchList[puzzleIdx];
            wsWords = [...currentWordSearch.words];
            wsFoundWords = [];
            wsSelectedCells = [];
            wsGrid = generateWordSearchGrid(wsWords, 10);
            wsTimeLeft = WS_TIME_LIMIT;
            renderWordSearchStreakBar();
            renderWordSearch();
            wsTimer = setInterval(() => {
                wsTimeLeft--;
                updateWsTimer();
                if (wsTimeLeft <= 0) {
                    clearInterval(wsTimer);
                    wsTimer = null;
                    wordSearchStreak = 0;
                    renderWordSearchStreakBar();
                    document.getElementById('wordsearch-result').innerHTML = `
                        <div class="text-red-600 font-bold text-lg mb-4">Tempo esgotado!</div>
                        <button class="action-button" onclick="startNewWordSearch()">Tentar Novamente</button>`;
                }
            }, 1000);
        }

        function playTimerBeep() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                gainNode.gain.value = 0.1;
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            } catch(e) {}
        }

        function updateWsTimer() {
            const timerEl = document.getElementById('ws-timer');
            if (timerEl) {
                const isLow = wsTimeLeft <= 15;
                const bgColor = isLow ? 'bg-red-500' : '';
                const textColor = isLow ? 'text-white' : 'text-stone-800';
                timerEl.className = `${bgColor} ${textColor} px-4 py-2 rounded-lg font-bold text-lg mb-5`;
                timerEl.style.backgroundColor = isLow ? '' : '#F1D24B';
                timerEl.textContent = `TEMPO RESTANTE: ${wsTimeLeft}s`;
                if (isLow && wsTimeLeft > 0) {
                    playTimerBeep();
                }
            }
        }

        function renderWordSearchStreakBar() {
            const container = document.getElementById('streak-bar-container');
            container.classList.remove('hidden');
            const progress = Math.min(wordSearchStreak, WORDSEARCH_STREAK_GOAL);
            const percentage = (progress / WORDSEARCH_STREAK_GOAL) * 100;
            const isComplete = wordSearchStreak >= WORDSEARCH_STREAK_GOAL;
            container.innerHTML = `
                <div class="streak-bar-bg">
                    <div class="streak-bar-fill ${isComplete ? 'complete' : ''}" style="width: ${percentage}%"></div>
                </div>
                <p class="text-sm text-stone-500 mt-2 text-center">
                    ${isComplete ? '<svg class="inline w-5 h-5 mr-1 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Streak completo! Tire um print!' : `Complete ${WORDSEARCH_STREAK_GOAL} puzzles seguidos: ${progress}/${WORDSEARCH_STREAK_GOAL}`}
                </p>`;
        }

        function renderWordSearch() {
            const area = document.getElementById('study-content-area');
            const size = wsGrid.length;
            
            let gridHtml = `<div class="wordsearch-grid" style="grid-template-columns: repeat(${size}, 1fr)">`;
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    gridHtml += `<div class="wordsearch-cell" data-row="${r}" data-col="${c}" 
                        onmousedown="wsStartSelect(${r},${c})" 
                        onmouseenter="wsContinueSelect(${r},${c})"
                        ontouchstart="wsStartSelect(${r},${c}); event.preventDefault();"
                        ontouchmove="wsTouchMove(event)">${wsGrid[r][c]}</div>`;
                }
            }
            gridHtml += '</div>';
            
            let wordsHtml = '<div class="wordsearch-words mt-4">';
            wsWords.forEach(word => {
                const foundClass = wsFoundWords.includes(word) ? 'found' : '';
                wordsHtml += `<span class="wordsearch-word ${foundClass}" data-word="${word}">${word}</span>`;
            });
            wordsHtml += '</div>';
            
            area.innerHTML = `
                <div class="flex flex-col items-center">
                    <div id="ws-timer" style="background-color: #F1D24B;" class="text-stone-800 px-4 py-2 rounded-lg font-bold text-lg mb-5">TEMPO RESTANTE: ${wsTimeLeft}s</div>
                    ${gridHtml}
                    ${wordsHtml}
                </div>
                <div id="wordsearch-result" class="mt-4 text-center"></div>
            `;
            
            document.addEventListener('mouseup', wsEndSelect);
            document.addEventListener('touchend', wsEndSelect);
        }

        window.wsStartSelect = function(r, c) {
            wsIsSelecting = true;
            wsSelectedCells = [{r, c}];
            updateWsSelection();
        }

        window.wsContinueSelect = function(r, c) {
            if (!wsIsSelecting) return;
            const last = wsSelectedCells[wsSelectedCells.length - 1];
            if (last.r === r && last.c === c) return;
            
            if (wsSelectedCells.length === 1) {
                wsSelectedCells.push({r, c});
            } else {
                const first = wsSelectedCells[0];
                const dr = Math.sign(wsSelectedCells[1].r - first.r);
                const dc = Math.sign(wsSelectedCells[1].c - first.c);
                const newDr = Math.sign(r - first.r);
                const newDc = Math.sign(c - first.c);
                
                if ((dr === 0 && dc === 0) || (newDr === dr && newDc === dc) || (newDr === 0 && newDc === 0)) {
                    const dist = Math.max(Math.abs(r - first.r), Math.abs(c - first.c));
                    const actualDr = dist > 0 ? (r - first.r) / dist : 0;
                    const actualDc = dist > 0 ? (c - first.c) / dist : 0;
                    
                    wsSelectedCells = [];
                    for (let i = 0; i <= dist; i++) {
                        wsSelectedCells.push({
                            r: first.r + Math.round(actualDr * i),
                            c: first.c + Math.round(actualDc * i)
                        });
                    }
                }
            }
            updateWsSelection();
        }

        window.wsTouchMove = function(event) {
            const touch = event.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            if (element && element.classList.contains('wordsearch-cell')) {
                const r = parseInt(element.dataset.row);
                const c = parseInt(element.dataset.col);
                wsContinueSelect(r, c);
            }
        }

        window.wsEndSelect = function() {
            if (!wsIsSelecting) return;
            wsIsSelecting = false;
            
            if (wsSelectedCells.length < 2) {
                wsSelectedCells = [];
                updateWsSelection();
                return;
            }
            
            let selectedWord = '';
            wsSelectedCells.forEach(cell => {
                selectedWord += wsGrid[cell.r][cell.c];
            });
            
            const reversedWord = selectedWord.split('').reverse().join('');
            
            let foundWord = null;
            if (wsWords.includes(selectedWord) && !wsFoundWords.includes(selectedWord)) {
                foundWord = selectedWord;
            } else if (wsWords.includes(reversedWord) && !wsFoundWords.includes(reversedWord)) {
                foundWord = reversedWord;
            }
            
            if (foundWord) {
                wsFoundWords.push(foundWord);
                wsSelectedCells.forEach(cell => {
                    const cellEl = document.querySelector(`.wordsearch-cell[data-row="${cell.r}"][data-col="${cell.c}"]`);
                    if (cellEl) cellEl.classList.add('found');
                });
                const wordEl = document.querySelector(`.wordsearch-word[data-word="${foundWord}"]`);
                if (wordEl) wordEl.classList.add('found');
                
                if (wsFoundWords.length === wsWords.length) {
                    clearInterval(wsTimer);
                    wsTimer = null;
                    wordSearchStreak++;
                    renderWordSearchStreakBar();
                    
                    setTimeout(() => {
                        if (wordSearchStreak >= WORDSEARCH_STREAK_GOAL) {
                            markStreakDone(currentAulaId, 'wordsearch');
                            document.getElementById('study-content-area').innerHTML = `
                                <div class="flex flex-col items-center justify-center py-10">
                                    <div class="mb-4"><svg class="w-20 h-20 mx-auto text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h14a2 2 0 0 1 2 2v2a5 5 0 0 1-4.4 4.96 5.5 5.5 0 0 1-5.1 3.04 5.5 5.5 0 0 1-5.1-3.04A5 5 0 0 1 3 7V5a2 2 0 0 1 2-2zm0 2v2a3 3 0 0 0 2.1 2.86 5.48 5.48 0 0 1-.1-1.14V7a1 1 0 1 1 2 0v1.72c0 1.28.56 2.43 1.47 3.22A3.5 3.5 0 0 0 12 9.72V7a1 1 0 1 1 2 0v2.72a3.5 3.5 0 0 0 1.53 2.22A3.48 3.48 0 0 0 17 8.72V7a1 1 0 1 1 2 0v1.72c0 .39-.03.77-.1 1.14A3 3 0 0 0 21 7V5H5zm2 14h10v2H7v-2zm1-3h8a1 1 0 0 1 1 1v1H7v-1a1 1 0 0 1 1-1z"/></svg></div>
                                    <h2 class="text-3xl font-bold text-stone-800 mb-2">Missão Cumprida!</h2>
                                    <p class="text-stone-500 mb-8">Você completou ${WORDSEARCH_STREAK_GOAL} caça-palavras seguidos!</p>
                                    <button class="action-button px-8" onclick="showDashboard()">Voltar</button>
                                    <button class="secondary-button mt-4" onclick="wordSearchStreak=0; startNewWordSearch()">Jogar Novamente</button>
                                </div>`;
                        } else {
                            document.getElementById('wordsearch-result').innerHTML = `
                                <div class="text-green-600 font-bold text-lg mb-4"><svg class="inline w-5 h-5 mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Parabéns! Todas as palavras encontradas!</div>
                                <button class="action-button" onclick="startNewWordSearch()">Próximo Caça-Palavras</button>`;
                        }
                    }, 500);
                }
            }
            
            wsSelectedCells = [];
            updateWsSelection();
        }

        function updateWsSelection() {
            document.querySelectorAll('.wordsearch-cell').forEach(cell => {
                if (!cell.classList.contains('found')) {
                    cell.classList.remove('selected');
                }
            });
            wsSelectedCells.forEach(cell => {
                const cellEl = document.querySelector(`.wordsearch-cell[data-row="${cell.r}"][data-col="${cell.c}"]`);
                if (cellEl && !cellEl.classList.contains('found')) {
                    cellEl.classList.add('selected');
                }
            });
        }

        window.toggleChunk = function(index) {
            const text = document.getElementById(`chunk-pt-${index}`);
            text.classList.toggle('translation-hidden');
            text.classList.toggle('translation-visible');
        }

        function renderStreakBar(customGoal, customProgress) {
            const container = document.getElementById('streak-bar-container');
            const title = document.getElementById('study-title').textContent;
            const isChunks = title.includes("CHUNKS");
            if (isChunks || title.includes("Ditado") || title.includes("Unscramble") || title.includes("Forca") || document.getElementById('study-instruction').textContent.includes("Ordene")) {
                container.classList.remove('hidden');
                const isScramble = title.includes("Unscramble") || document.getElementById('study-instruction').textContent.includes("Ordene");
                const isHangman = title.includes("Forca");
                const goal = customGoal || (isScramble ? SCRAMBLE_STREAK_GOAL : isHangman ? HANGMAN_STREAK_GOAL : STREAK_GOAL);
                const prog = customProgress !== undefined ? customProgress : currentStreak;
                const progress = Math.min(prog, goal);
                const percentage = (progress / goal) * 100;
                const isComplete = prog >= goal;
                container.innerHTML = `
                    <div class="streak-bar-wrapper">
                        <div class="streak-label text-center">
                            ${isComplete ? '<svg class="inline w-5 h-5 mr-1 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Streak completo! Tire um print!' : (isChunks ? `Complete todos os chunks: ${progress}/${goal}` : `Complete ${goal} acertos seguidos: ${progress}/${goal}`)}
                        </div>
                        <div class="streak-bar-bg">
                            <div class="streak-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            } else {
                container.classList.add('hidden');
            }
        }

        let chunksCorrectCount = 0;
        let chunksTotalCount = 0;
        var chunksAnswersCache = {};

        function chunksDocId(aulaId) {
            return currentLevel + '_' + aulaId;
        }

        async function loadChunksAnswers(aulaId) {
            if (!currentUser) return {};
            try {
                var docId = chunksDocId(aulaId);
                const doc = await firebaseDb.collection('users').doc(currentUser.uid).collection('chunksAnswers').doc(docId).get();
                if (doc.exists) return doc.data() || {};
                var oldDoc = await firebaseDb.collection('users').doc(currentUser.uid).collection('chunksAnswers').doc(String(aulaId)).get();
                if (oldDoc.exists && currentLevel === 'starter1') {
                    var oldData = oldDoc.data() || {};
                    await firebaseDb.collection('users').doc(currentUser.uid).collection('chunksAnswers').doc(docId).set(oldData);
                    return oldData;
                }
            } catch(e) {}
            return {};
        }

        async function saveChunkAnswer(aulaId, index, answer) {
            if (!currentUser) return;
            var cacheKey = chunksDocId(aulaId);
            if (!chunksAnswersCache[cacheKey]) chunksAnswersCache[cacheKey] = {};
            chunksAnswersCache[cacheKey][String(index)] = answer;
            try {
                await firebaseDb.collection('users').doc(currentUser.uid).collection('chunksAnswers').doc(cacheKey).set(chunksAnswersCache[cacheKey]);
            } catch(e) {}
        }

        async function renderChunksGrid(data) {
            const area = document.getElementById('study-content-area');
            chunksTotalCount = data.length;
            const saved = await loadChunksAnswers(currentAulaId);
            chunksAnswersCache[chunksDocId(currentAulaId)] = saved;
            chunksCorrectCount = Object.keys(saved).length;
            renderStreakBar(chunksTotalCount, chunksCorrectCount);
            area.innerHTML = `<div class="chunks-grid shadow-lg">
                <div class="chunks-header">Português</div>
                <div class="chunks-header">English</div>
                ${data.map((item, index) => {
                    const savedAnswer = saved[String(index)];
                    const isDone = !!savedAnswer;
                    return `
                <div class="chunks-cell chunks-cell-pt">
                    <span>${item.pt}</span>
                </div>
                <div class="chunks-cell chunks-cell-en">
                    <input type="text" id="chunk-input-${index}" class="chunk-input ${isDone ? 'correct' : ''}" placeholder="Type in English..." value="${isDone ? savedAnswer.replace(/"/g, '&quot;') : ''}" ${isDone ? 'disabled' : ''} data-answer="${item.en.replace(/"/g, '&quot;')}" onkeypress="if(event.key==='Enter')checkChunk(${index})" data-testid="input-chunk-${index}">
                    <button onclick="checkChunk(${index})" class="chunk-check-btn" ${isDone ? 'style="display:none"' : ''} data-testid="button-chunk-ok-${index}">OK</button>
                    <button id="chunk-audio-${index}" onclick="speakText('${item.en.replace(/'/g, "\\'")}')" class="p-1 rounded-full hover:bg-primary/10 transition" style="display:${isDone ? 'inline-flex' : 'none'};" data-testid="button-chunk-audio-${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#8671d1" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    </button>
                </div>`;
                }).join('')}</div>`;
            if (chunksCorrectCount >= chunksTotalCount) {
                markStreakDone(currentAulaId, 'chunks');
            }
        }

        window.checkChunk = function(index) {
            const input = document.getElementById('chunk-input-' + index);
            const answer = input.dataset.answer;
            const userAnswer = input.value.trim().toLowerCase();
            const correctAnswer = answer.toLowerCase();
            
            if (input.disabled) return;
            
            if (normalizeAnswer(userAnswer, correctAnswer)) {
                input.classList.remove('wrong');
                input.classList.add('correct');
                input.value = answer;
                input.disabled = true;
                playCorrectSound();
                const okBtn = input.nextElementSibling;
                if (okBtn && okBtn.classList.contains('chunk-check-btn')) okBtn.style.display = 'none';
                document.getElementById('chunk-audio-' + index).style.display = 'inline-flex';
                saveChunkAnswer(currentAulaId, index, answer);
                chunksCorrectCount++;
                renderStreakBar(chunksTotalCount, chunksCorrectCount);
                if (chunksCorrectCount >= chunksTotalCount) {
                    markStreakDone(currentAulaId, 'chunks');
                }
            } else {
                input.classList.remove('correct');
                input.classList.add('wrong');
                playIncorrectSound();
            }
        }

        async function renderListeningBoard(items, useWideGrid = false) {
            const area = document.getElementById('study-content-area');
            const gridClass = useWideGrid ? 'listening-grid-wide' : 'listening-grid';
            area.innerHTML = `<div class="${gridClass}"></div>`;
            const grid = area.querySelector('.' + gridClass);
            items.forEach((item, i) => {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                const phonetic = item.p ? `<span class="phonetic-text">${item.p}</span>` : '';
                btn.innerHTML = `<span class="main-text">${item.n || item}</span>${phonetic}<span class="sub-text">${item.w || ''}</span>`;
                btn.onclick = async () => {
                    if (btn.classList.contains('playing')) return;
                    btn.classList.add('playing');
                    const spokenWord = item.w || item.n || item;
                    const audio = await fetchTTSAudio(spokenWord);
                    if (audio) { 
                        await audio.play(); 
                        btn.classList.remove('playing');
                    } else {
                        btn.classList.remove('playing');
                    }
                };
                grid.appendChild(btn);
            });
        }

        function renderFlashcards() {
            const area = document.getElementById('study-content-area');
            const update = () => {
                const card = currentShuffledCards[currentFlashcardIdx];
                const isText = /[a-zA-Z0-9]/.test(card.front); 
                const frontSize = isText ? 'text-4xl' : 'text-9xl';
                area.innerHTML = `
                    <div class="flashcard-container" onclick="flipAndSpeak(this, '${card.back.replace(/'/g, "\\'")}')">
                        <div class="flashcard"><div class="flashcard-front"><span class="text-xs absolute top-8 opacity-50 font-bold tracking-widest">PORTUGUESE</span><span class="${frontSize} font-bold mt-4">${card.front}</span></div>
                        <div class="flashcard-back"><span class="text-xs absolute top-8 opacity-50 font-bold tracking-widest">ENGLISH</span><span class="text-3xl font-bold mt-4">${card.back}</span>
                        <button class="mt-4 p-2 rounded-full bg-primary/20 hover:bg-primary/30 transition" onclick="event.stopPropagation(); speakText('${card.back.replace(/'/g, "\\'")}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                        </button></div></div>
                    </div>
                    <div class="flex items-center justify-between max-w-xs mx-auto mt-4">
                        <button class="secondary-button p-3 rounded-full" onclick="changeFC(-1)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg></button>
                        <span class="font-bold text-stone-400">${currentFlashcardIdx + 1} / ${currentShuffledCards.length}</span>
                        <button class="secondary-button p-3 rounded-full" onclick="changeFC(1)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg></button>
                    </div>`;
            };
            window.changeFC = (dir) => { currentFlashcardIdx = (currentFlashcardIdx + dir + currentShuffledCards.length) % currentShuffledCards.length; update(); };
            window.flipAndSpeak = (el, text) => {
                const flashcard = el.querySelector('.flashcard');
                const wasFlipped = flashcard.classList.contains('flipped');
                flashcard.classList.toggle('flipped');
                if (!wasFlipped) { speakText(text); }
            };
            update();
        }

        function renderMistake() {
            const area = document.getElementById('study-content-area');
            renderStreakBar();

            if (currentStreak >= STREAK_GOAL) {
                markStreakDone(currentAulaId, 'mistake');
                 area.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10">
                        <div class="text-6xl mb-4">📸</div>
                        <h2 class="text-3xl font-bold text-stone-800 mb-2">Missão Cumprida!</h2>
                        <p class="text-stone-500 mb-8">Tire um print e envie para o seu teacher!</p>
                        <button class="action-button px-8" onclick="showDashboard()">Voltar</button>
                        <button class="secondary-button mt-4" onclick="currentStreak=0; currentShuffledData=shuffle([...currentShuffledData]); renderMistake()">Reiniciar</button>
                    </div>`;
                return;
            }

            const item = currentShuffledData[currentIdx];
            const words = item.sentence.split(' ');
            area.innerHTML = `
                <div class="text-2xl font-bold mb-8 leading-loose">
                    ${words.map(w => `<span class="mistake-word" onclick="checkMistakeClick(this, '${w}', '${item.wrong}', '${item.correct}', '${item.rationale}')">${w}</span>`).join(' ')}
                </div>
                <div id="mistake-fb" class="hidden p-4 rounded-xl mb-4 text-left"></div>
                <button class="action-button w-full hidden" id="mistake-next" onclick="window.nextRound(renderMistake)">Próxima Frase</button>
            `;
        }

        window.checkMistakeClick = function(el, w, wrong, correct, rationale) {
            const clean = w.replace(/[.,]/g, "");
            const fb = document.getElementById('mistake-fb');
            if (clean === wrong) {
                el.classList.add('correct-choice');
                fb.innerHTML = `<p class="font-bold text-green-800">Correct! O erro era "${wrong}". O certo é "${correct}".</p><p class="text-sm text-green-700 mt-2">${rationale}</p>`;
                fb.className = "p-4 rounded-xl bg-green-100 block mb-4";
                document.getElementById('mistake-next').classList.remove('hidden');
                document.querySelectorAll('.mistake-word').forEach(m => m.onclick = null);
                currentStreak++;
            } else {
                el.classList.add('wrong-choice');
                currentStreak = 0; // Reset on error
            }
            renderStreakBar();
        };

        function renderScramble() {
            const area = document.getElementById('study-content-area');
            renderStreakBar();

            if (currentStreak >= SCRAMBLE_STREAK_GOAL) {
                markStreakDone(currentAulaId, 'scramble');
                area.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10">
                        <div class="mb-4"><svg class="w-20 h-20 mx-auto text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h14a2 2 0 0 1 2 2v2a5 5 0 0 1-4.4 4.96 5.5 5.5 0 0 1-5.1 3.04 5.5 5.5 0 0 1-5.1-3.04A5 5 0 0 1 3 7V5a2 2 0 0 1 2-2zm0 2v2a3 3 0 0 0 2.1 2.86 5.48 5.48 0 0 1-.1-1.14V7a1 1 0 1 1 2 0v1.72c0 1.28.56 2.43 1.47 3.22A3.5 3.5 0 0 0 12 9.72V7a1 1 0 1 1 2 0v2.72a3.5 3.5 0 0 0 1.53 2.22A3.48 3.48 0 0 0 17 8.72V7a1 1 0 1 1 2 0v1.72c0 .39-.03.77-.1 1.14A3 3 0 0 0 21 7V5H5zm2 14h10v2H7v-2zm1-3h8a1 1 0 0 1 1 1v1H7v-1a1 1 0 0 1 1-1z"/></svg></div>
                        <h2 class="text-3xl font-bold text-stone-800 mb-2">Missão Cumprida!</h2>
                        <p class="text-stone-500 mb-8">Tire um print e envie para o seu teacher para mostrar que você arrasou!</p>
                        <button class="action-button px-8" onclick="showDashboard()">Voltar ao Menu</button>
                        <button class="secondary-button mt-4" onclick="currentStreak=0; currentIdx=0; currentShuffledData=shuffle([...currentShuffledData]); renderScramble()">Jogar Novamente</button>
                    </div>
                `;
                return;
            }

            const item = currentShuffledData[currentIdx % currentShuffledData.length];
            const totalSentences = currentShuffledData.length;
            const currentSentence = (currentIdx % totalSentences) + 1;
            scrambleResult = [];
            const shuffled = shuffle([...item.words]);
            area.innerHTML = `
                <div class="text-center mb-4">
                    <span class="inline-block bg-primary/10 text-primary px-4 py-2 rounded-full font-bold text-sm">
                        Frase ${currentSentence} / ${totalSentences}
                    </span>
                </div>
                <div id="scramble-fb" class="hidden p-4 rounded-xl mb-6 text-center font-bold"></div>
                <div class="scramble-dropzone mb-6 flex flex-wrap justify-center gap-2 min-h-[60px]" id="scramble-res"><span class="text-stone-400">Clique nas palavras para formar a frase...</span></div>
                <div class="flex flex-wrap justify-center gap-3 mb-6" id="scramble-words">
                    ${shuffled.map((w, i) => `<button class="scramble-word" data-idx="${i}" data-word="${w.replace(/"/g, '&quot;')}" data-full="${item.full.replace(/"/g, '&quot;')}" onclick="pickWord(this, this.dataset.word, this.dataset.full)">${w}</button>`).join('')}
                </div>
                <button class="action-button w-full hidden" id="scramble-next" onclick="window.nextRound(renderScramble)">Próxima Frase</button>
            `;
        }

        window.pickWord = function(btn, w, full) {
            speakText(w);
            const idx = btn.getAttribute('data-idx');
            scrambleResult.push({ word: w, idx: idx });
            btn.style.visibility = 'hidden';
            updateScrambleResult(full);
        };

        window.unpickWord = function(idx, full) {
            scrambleResult = scrambleResult.filter(item => item.idx !== idx);
            const btn = document.querySelector(`#scramble-words button[data-idx="${idx}"]`);
            if (btn) btn.style.visibility = 'visible';
            updateScrambleResult(full);
        };

        function updateScrambleResult(full) {
            const resArea = document.getElementById('scramble-res');
            if (scrambleResult.length === 0) {
                resArea.innerHTML = '<span class="text-stone-400">Clique nas palavras para formar a frase...</span>';
                return;
            }
            resArea.innerHTML = scrambleResult.map(item => 
                `<button class="scramble-word-selected" data-idx="${item.idx}" data-full="${full.replace(/"/g, '&quot;')}" onclick="unpickWord(this.dataset.idx, this.dataset.full)">${item.word}</button>`
            ).join('');
            
            if (scrambleResult.length === full.split(' ').length) {
                const fb = document.getElementById('scramble-fb');
                const resultText = scrambleResult.map(i => i.word).join(' ');
                if (resultText.toLowerCase() === full.toLowerCase()) { 
                    currentStreak++; 
                    renderStreakBar(); 
                    fb.innerHTML = `<span class="text-sm">Perfect! Frase correta.</span>`;
                    fb.className = "p-4 rounded-xl bg-green-100 text-green-800 block mb-4";
                    document.getElementById('scramble-next').classList.remove('hidden');
                    resArea.querySelectorAll('button').forEach(b => b.onclick = null);
                } else { 
                    currentStreak = 0; 
                    renderStreakBar(); 
                    fb.innerHTML = `Errou! Tente de novo. <button class="text-xs opacity-70 underline ml-2" onclick="renderScramble()">reset</button>`;
                    fb.className = "p-4 rounded-xl bg-red-100 text-red-800 block mb-4";
                }
            }
        };

        function renderDictation() {
            const area = document.getElementById('study-content-area');
            renderStreakBar();

            if (currentStreak >= STREAK_GOAL) {
                markStreakDone(currentAulaId, 'dictation');
                 area.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10">
                        <div class="mb-4"><svg class="w-20 h-20 mx-auto text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3h14a2 2 0 0 1 2 2v2a5 5 0 0 1-4.4 4.96 5.5 5.5 0 0 1-5.1 3.04 5.5 5.5 0 0 1-5.1-3.04A5 5 0 0 1 3 7V5a2 2 0 0 1 2-2zm0 2v2a3 3 0 0 0 2.1 2.86 5.48 5.48 0 0 1-.1-1.14V7a1 1 0 1 1 2 0v1.72c0 1.28.56 2.43 1.47 3.22A3.5 3.5 0 0 0 12 9.72V7a1 1 0 1 1 2 0v2.72a3.5 3.5 0 0 0 1.53 2.22A3.48 3.48 0 0 0 17 8.72V7a1 1 0 1 1 2 0v1.72c0 .39-.03.77-.1 1.14A3 3 0 0 0 21 7V5H5zm2 14h10v2H7v-2zm1-3h8a1 1 0 0 1 1 1v1H7v-1a1 1 0 0 1 1-1z"/></svg></div>
                        <h2 class="text-3xl font-bold text-stone-800 mb-2">Excelente!</h2>
                        <p class="text-stone-500 mb-8">Você completou o streak de 5 ditados.</p>
                        <button class="action-button px-8" onclick="showDashboard()">Voltar</button>
                        <button class="secondary-button mt-4" onclick="currentStreak=0; currentIdx=0; currentShuffledData=shuffle([...currentShuffledData]); renderDictation()">Reiniciar</button>
                    </div>
                `;
                return;
            }

            const item = currentShuffledData[currentIdx % currentShuffledData.length];
            const totalItems = currentShuffledData.length;
            const currentItem = (currentIdx % totalItems) + 1;
            area.innerHTML = `
                <div class="flex flex-col items-center gap-4">
                    <div class="text-center">
                        <span class="inline-block bg-primary/10 text-primary px-4 py-2 rounded-full font-bold text-sm">
                            ${isNumberComboMode ? 'Sequência' : 'Palavra'} ${currentItem} / ${totalItems}
                        </span>
                    </div>
                    <button id="dict-play" class="w-24 h-24 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full flex items-center justify-center hover:from-indigo-200 hover:to-purple-200 transition-all shadow-lg transform hover:scale-105" onclick="playDictation('${item}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#8671d1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
                    </button>
                    ${isNumberComboMode ? '<p class="text-sm text-stone-400">Ex: one two three ou 1 2 3</p>' : ''}
                    <input type="text" id="dict-input" class="dictation-input" ${isNumberComboMode ? 'style="width:320px"' : ''} placeholder="${isNumberComboMode ? 'Ex: one two three' : 'Digite aqui...'}" autocomplete="off" onkeypress="if(event.key==='Enter')checkDictation('${item}')">
                    <button class="action-button max-w-xs" onclick="checkDictation('${item}')">Verificar</button>
                    <div id="dict-fb" class="hidden p-4 rounded-xl font-bold text-lg"></div>
                    <button class="secondary-button hidden" id="dict-next" onclick="window.nextRound(renderDictation)">Próxima Palavra</button>
                </div>
            `;
        }

        function timeToWords(timeStr) {
            const match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
            if (!match) return timeStr;
            const h = parseInt(match[1], 10);
            const m = parseInt(match[2], 10);
            const hourWords = ['twelve', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve'];
            const hourWord = hourWords[h % 12];
            if (m === 0) return `${hourWord} o'clock`;
            if (m === 15) return `quarter past ${hourWord}`;
            if (m === 30) return `half past ${hourWord}`;
            if (m === 45) {
                const nextHour = hourWords[(h + 1) % 12];
                return `quarter to ${nextHour}`;
            }
            const minWord = m < 10 ? `oh ${['zero','one','two','three','four','five','six','seven','eight','nine'][m]}` : m.toString();
            return `${hourWord} ${minWord}`;
        }

        window.playDictation = async function(text) {
             const btn = document.getElementById('dict-play');
             btn.classList.add('animate-pulse');
             
             // Convert time format to spoken words
             const spokenText = text.includes(':') ? timeToWords(text) : text;
             
             if (isSpellingMode) {
                 const letters = text.split('');
                 for (let i = 0; i < letters.length; i++) {
                     const l = letters[i].toUpperCase();
                     const audio = await fetchTTSAudio(l);
                     if (audio) await audio.play();
                     if (i < letters.length - 1) {
                         await new Promise(resolve => setTimeout(resolve, 300));
                     }
                 }
                 btn.classList.remove('animate-pulse');
             } else if (isNumberComboMode) {
                 const numbers = text.split(' ');
                 for (let i = 0; i < numbers.length; i++) {
                     const audio = await fetchTTSAudio(numbers[i]);
                     if (audio) await audio.play();
                     if (i < numbers.length - 1) {
                         await new Promise(resolve => setTimeout(resolve, 600));
                     }
                 }
                 btn.classList.remove('animate-pulse');
             } else {
                 const audio = await fetchTTSAudio(spokenText);
                 if (audio) { 
                     await audio.play(); 
                     btn.classList.remove('animate-pulse'); 
                 } else {
                     btn.classList.remove('animate-pulse'); 
                 }
             }
        }

        // Number mappings for dictation (extenso <-> numeral)
        const numberMap = {
            'one': '1', 'two': '2', 'three': '3', 'four': '4', 'five': '5',
            'six': '6', 'seven': '7', 'eight': '8', 'nine': '9', 'ten': '10',
            'eleven': '11', 'twelve': '12', 'thirteen': '13', 'fourteen': '14', 'fifteen': '15',
            'sixteen': '16', 'seventeen': '17', 'eighteen': '18', 'nineteen': '19', 'twenty': '20',
            'first': '1st', 'second': '2nd', 'third': '3rd', 'fourth': '4th', 'fifth': '5th',
            'sixth': '6th', 'seventh': '7th', 'eighth': '8th', 'ninth': '9th', 'tenth': '10th'
        };
        const reverseNumberMap = Object.fromEntries(Object.entries(numberMap).map(([k, v]) => [v, k]));

        const contractionMap = {
            "what's": "what is", "that's": "that is", "it's": "it is", "he's": "he is", "she's": "she is",
            "here's": "here is", "there's": "there is", "where's": "where is", "who's": "who is", "how's": "how is",
            "i'm": "i am", "you're": "you are", "we're": "we are", "they're": "they are",
            "i've": "i have", "you've": "you have", "we've": "we have", "they've": "they have",
            "i'll": "i will", "you'll": "you will", "he'll": "he will", "she'll": "she will", "we'll": "we will", "they'll": "they will", "it'll": "it will",
            "i'd": "i would", "you'd": "you would", "he'd": "he would", "she'd": "she would", "we'd": "we would", "they'd": "they would",
            "isn't": "is not", "aren't": "are not", "wasn't": "was not", "weren't": "were not",
            "don't": "do not", "doesn't": "does not", "didn't": "did not",
            "can't": "cannot", "couldn't": "could not", "won't": "will not", "wouldn't": "would not",
            "shouldn't": "should not", "hasn't": "has not", "haven't": "have not", "hadn't": "had not",
            "let's": "let us"
        };
        function expandContractions(text) {
            let result = text.toLowerCase();
            for (const [contraction, expanded] of Object.entries(contractionMap)) {
                result = result.replace(new RegExp(contraction.replace("'", "[''']"), 'gi'), expanded);
            }
            return result.trim().replace(/\s+/g, ' ');
        }

        function normalizeAnswer(val, correct) {
            val = val.toLowerCase().trim().replace(/\s+/g, ' ');
            correct = correct.toLowerCase().trim();
            if (val === correct) return true;
            if (expandContractions(val) === expandContractions(correct)) return true;
            // Check if user typed number instead of word
            if (numberMap[correct] && val === numberMap[correct]) return true;
            // Check if user typed word instead of number
            if (reverseNumberMap[correct] && val === reverseNumberMap[correct]) return true;
            // Handle multi-number combos (e.g. "one two three" vs "1 2 3" or mixed)
            if (correct.includes(' ')) {
                const correctParts = correct.split(' ');
                const valParts = val.split(' ');
                if (correctParts.length === valParts.length) {
                    const allMatch = correctParts.every((cp, i) => {
                        const vp = valParts[i];
                        if (vp === cp) return true;
                        if (numberMap[cp] && vp === numberMap[cp]) return true;
                        if (reverseNumberMap[cp] && vp === reverseNumberMap[cp]) return true;
                        return false;
                    });
                    if (allMatch) return true;
                }
            }
            // For letters (A, B, C...) accept lowercase
            if (correct.length === 1 && val === correct) return true;
            // For time formats - normalize and compare
            if (correct.includes(':')) {
                const normalizeTime = (t) => {
                    t = t.replace(/[hH]/, ':').replace(/\s+/g, '');
                    const match = t.match(/^(\d{1,2}):?(\d{2})?$/);
                    if (match) {
                        const h = parseInt(match[1], 10);
                        const m = match[2] ? parseInt(match[2], 10) : 0;
                        return `${h}:${m.toString().padStart(2, '0')}`;
                    }
                    return t;
                };
                if (normalizeTime(val) === normalizeTime(correct)) return true;
            }
            return false;
        }

        window.checkDictation = function(correct) {
            const input = document.getElementById('dict-input');
            const verifyBtn = document.querySelector('#study-content-area .action-button');
            
            // Prevent multiple clicks
            if (verifyBtn.disabled) return;
            verifyBtn.disabled = true;
            verifyBtn.classList.add('opacity-50', 'cursor-not-allowed');
            input.disabled = true;
            
            const val = input.value.toLowerCase().trim();
            const fb = document.getElementById('dict-fb');

            if (normalizeAnswer(val, correct)) {
                input.classList.add('correct');
                fb.className = "hidden";
                document.getElementById('dict-next').classList.remove('hidden');
                currentStreak++;
                playCorrectSound();
            } else {
                input.classList.add('wrong');
                fb.innerHTML = `<p class="text-red-600 font-bold mb-2">Resposta correta: <span class="text-stone-800">${correct}</span></p><button class="action-button" onclick="currentStreak=0; currentIdx=0; currentShuffledData=shuffle([...currentShuffledData]); renderDictation()">Começar Novamente</button>`;
                fb.className = "mt-4 block";
                currentStreak = 0;
                playIncorrectSound();
            }
            renderStreakBar();
        }

        window.nextRound = function(cb) {
            currentIdx = (currentIdx + 1) % currentShuffledData.length;
            cb();
        };

        function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
        function scrollToModule(id) { document.getElementById(`module-${id}`).scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        window.scrollToModule = scrollToModule;

        window.onload = async function() { 
            const firebaseReady = await initFirebase();
            if (firebaseReady) {
                firebaseAuth.onAuthStateChanged(onAuthStateChanged);
            } else {
                showScreen('app');
                document.getElementById('user-info-badge').style.display = 'none';
                renderDashboard();
            }
        };
    </script>
</body>
</html>
